if(typeof (XWiki)=="undefined"){XWiki=new Object()}XWiki.Selection=Class.create({container:false,selectionText:false,selectionContext:false,selectionOffset:false,range:false,highlightWrappers:false,selectionParent:false,selectionParentInnerHTML:false,offsetX:false,offsetY:false,step:5,wordStep:1,initialize:function(A){if(!A){return }this.container=A;if(!window.getSelection){this.container.observe("mousedown",function(B){this.offsetX=B.pointerX();this.offsetY=B.pointerY()}.bindAsEventListener(this))}},computeSelection:function(){this.selectionText=false;this.range=false;this.selectionContext=false;this.selectionOffset=false;this.highlightWrappers=false;this.selectionParent=false;this.selectionParentInnerHTML=false;if(!this.container){return }if(window.getSelection){if(window.getSelection().rangeCount==0){return }this.range=window.getSelection().getRangeAt(0);if(!this.isDescendantOrSelf(this.container,this.range.commonAncestorContainer)){return }this.selectionText=this.range.toString()}else{if(document.selection.type=="Text"){this.range=document.selection.createRange();if(!this.isDescendantOrSelf(this.container,this.range.parentElement())){return }this.selectionText=this.range.text}}if(this.selectionText==""){this.selectionText=false}},isDescendantOrSelf:function(A,B){return A==B||Element.descendantOf(B,A)},computeContext:function(){if(window.getSelection){this.computeContextFF()}else{this.computeContextIE()}},highlightSelection:function(B){if(!this.range){return }if(window.getSelection){var A=new Element("span",{"style":"background-color: "+B,"class":"selection-highlight"});var C=this.getRangeTextNodes();window.getSelection().removeAllRanges();this.highlightWrappers=new Array();C.each(function(E){var D=A.clone();D.update(E.textContent);E.parentNode.replaceChild(D,E);this.highlightWrappers.push(D)}.bind(this))}else{this.selectionParent=this.range.parentElement();this.selectionParentInnerHTML=this.selectionParent.innerHTML;this.range.execCommand("BackColor",false,B)}},getRangeTextNodes:function(){var G=this.range.startContainer;var H=this.range.endContainer;var A=this.range.startOffset;var E=this.range.endOffset;var D=this.getFirstLeafInRange(this.range);var C=this.getLastLeafInRange(this.range);var B=this.getLeafsBetween(D,C);var F=B.findAll(function(I){return I.nodeType==3});if(G==F[0]&&A!=0){F[0]=G.splitText(A);if(G==H){E=E-A;H=F[0]}}if(H==F[F.length-1]&&E!=H.length){H=H.splitText(E)}return F},getLeafsBetween:function(C,A){var B=new Array();var D=C;B.push(C);while(D!=A){D=this.getNextLeaf(D);B.push(D)}return B},getFirstLeafInRange:function(A){if(A.startContainer.hasChildNodes()){if(A.collapsed){return null}else{if(A.startOffset>=A.startContainer.childNodes.length){return this.getNextLeaf(A.startContainer)}else{return this.getFirstLeaf(A.startContainer.childNodes[A.startOffset])}}}else{return A.startContainer}},getLastLeafInRange:function(A){if(A.endContainer.hasChildNodes()){if(A.collapsed){return null}else{if(A.endOffset==0){return this.getPreviousLeaf(A.endContainer)}else{return this.getLastLeaf(A.endContainer.childNodes[A.endOffset-1])}}}else{return A.endContainer}},getNextLeaf:function(B){var A=B;while(A!=null&&A.nextSibling==null){A=A.parentNode}if(A==null){return null}else{return this.getFirstLeaf(A.nextSibling)}},getPreviousLeaf:function(B){var A=B;while(A!=null&&A.previousSibling==null){A=A.parentNode}if(A==null){return null}else{return this.getLastLeaf(A.previousSibling)}},getFirstLeaf:function(B){var A=B;while(A.hasChildNodes()){A=A.firstChild}return A},getLastLeaf:function(B){var A=B;while(A.hasChildNodes()){A=A.lastChild}return A},removeSelectionHighlight:function(){if(window.getSelection){this.highlightWrappers.each(function(A){A.replace(A.innerHTML)})}else{this.selectionParent.update(this.selectionParentInnerHTML)}},getPositionNextToSelection:function(){if(!this.range){return{"left":0,"top":0}}var C=0;var B=0;if(window.getSelection){if(this.highlightWrappers.length>0){C=this.highlightWrappers[0].cumulativeOffset().left;var A=this.highlightWrappers[this.highlightWrappers.length-1];B=A.cumulativeOffset().top+A.getHeight()}}else{C=this.offsetX;B=this.offsetY}return{"left":C,"top":B}},getRightDocument:function(A){var C="";if(A==this.container){C=this.getRightDocument(A.parentNode)}for(var B=A.nextSibling;B!=null;B=B.nextSibling){C+=B.textContent}return C},getLeftDocument:function(B){var C="";if(B==this.container){C=this.getLeftDocument(B.parentNode)}parent=B.parentNode;if(parent.childNodes){for(var A=0;A<parent.childNodes.length&&parent.childNodes[A]!=B;++A){C+=parent.childNodes[A].textContent}}return C},computeContextFF:function(){var C=this.getLeftDocument(this.range.startContainer)+this.range.startContainer.textContent.substring(0,this.range.startOffset);var G="";var I=this.range.endContainer.textContent.substring(this.range.endOffset,this.range.endContainer.textContent.length)+this.getRightDocument(this.range.endContainer);var H="";var F=0;var B=this.range.toString();var J=0;var A=0;while(H!=I||G!=C){var E=this.container.textContent.indexOf(B);var D=this.container.textContent.indexOf(B,E+1);if(D==-1){break}J=Math.min(C.length,J+this.step);A=Math.min(I.length,A+this.step);H=I.substring(0,A);G=C.substring(C.length-J,C.length)}this.selectionContext=G+this.selectionText+H;this.selectionOffset=Math.max(G.length,0)},computeContextIE:function(){var C=this.container.innerText;var E=this.range.duplicate();var D=0;var B=true;while(!this.isUnique(C,E.text)&&B){var B=false;var A=E.text.length;E.moveStart("word",-1);if(!this.isDescendantOrSelf(this.container,E.parentElement())){E.moveStart("word",1)}else{D+=E.text.length-A;B=true}E.moveEnd("word",1);if(!this.isDescendantOrSelf(this.container,E.parentElement())){E.moveEnd("word",-1)}else{B=true}}this.selectionContext=E.text;this.selectionOffset=D},isUnique:function(A,B){var C=A.indexOf(B);if(C>=0){return A.indexOf(B,C+1)<0}return true}});XWiki.Annotation=Class.create({annotatedElement:false,annTabname:"Annotations",fetchedAnnotations:false,displayAnnotationsCheckbox:false,displayedByDefault:false,displayHighlight:true,addAnnotationShortcuts:["Ctrl+M","Meta+M","Ctrl+I","Meta+I"],closeDialogShortcuts:["Esc"],selectionService:false,bubbles:new Array(),currentFilter:{},initialize:function(C,B,A){this.displayHighlight=C;this.annotatedElement=B;this.displayedByDefault=A;if(!this.annotatedElement){if(this.displayedByDefault){new XWiki.widgets.Notification("No es poden carregar les anotacions ja què no està disponible el contingut.","warning")}return }this.hookMenuButton();this.hookTabShortcut();this.hookTab();document.observe("xwiki:docextra:loaded",this.addDeleteListenersInTab.bindAsEventListener(this));document.observe("xwiki:docextra:loaded",this.addEditListenersInTab.bindAsEventListener(this));document.observe("xwiki:docextra:loaded",this.addValidateListenersInTab.bindAsEventListener(this));this.registerAddAnnotationShortcut();this.registerCloseDialogShortcut();this.selectionService=new XWiki.Selection(this.annotatedElement);document.observe("xwiki:annotations:filter:changed",this.onFilterChange.bindAsEventListener(this));XWiki.currentPage=$$("meta[name=page]")[0].content;if(this.displayedByDefault){if(XWiki.docsyntax!="xwiki/1.0"){this.fetchAnnotations(true)}else{new XWiki.widgets.Notification("Les anotacions no estan disponibles per als documents amb sintaxis XWiki/1.0.	","warning")}}},hookMenuButton:function(){var C=$("contentmenu");if(C){var B=C.down(".rightmenu");if(!B){B=new Element("div",{"class":"rightmenu"});var E=C.down(".leftmenu");if(E){E.insert({before:B})}else{C.insert({bottom:B})}}var D=new Element("div",{"class":"topmenuentry hasIcon","id":"tmAnnotations"});var A=new Element("a",{"class":"tme","href":"#"+this.annTabname});A.update("<strong>Anotacions</strong>");D.insert({top:A});B.insert({bottom:D});A.observe("click",this.toggleSettingsPanel.bind(this))}},hookTabShortcut:function(){if($("commentsshortcut")){var B=$("commentsshortcut").up();var C=new Element("span",{"id":"annotationsshortcut"}).update('<a href="#'+this.annTabname+'">Anotacions</a> ');B.insert({top:C});var A=new Element("span",{"class":"separator"}).update("·");C.insert({after:A});C.observe("click",XWiki.displayDocExtra.bind(XWiki,this.annTabname,"annotationsinline.vm",true))}},hookTab:function(){var C=$("docExtrasTabsUl");if(C){var B=new Element("li",{"id":this.annTabname+"tab"}).update('<a href="#'+this.annTabname+'" id="'+this.annTabname+'link">Anotacions</a>');C.insert({top:B});B.observe("click",XWiki.displayDocExtra.bind(XWiki,this.annTabname,"annotationsinline.vm",true));var D=$("docextrapanes");var E=new Element("div",{"id":this.annTabname+"pane","class":"hidden empty"});D.insert({top:E});var A=$("docextraanchors");A.insert({top:new Element("span",{"id":this.annTabname+"anchor"}).update("&nbsp;")})}},toggleSettingsPanel:function(A){var B=A.element();A.stop();if(B.disabled){return }if(!this.settingsPanel){new Ajax.Request("/bin/view/AnnotationCode/Settings?xpage=plain",{parameters:{"target":XWiki.currentWiki+":"+XWiki.currentSpace+"."+XWiki.currentPage},onCreate:function(){B.disabled=true;B._x_notification=new XWiki.widgets.Notification("Carregant preferències d'anotacions","inprogress")},onSuccess:function(C){$("contentmenu").insert({after:C.responseText});this.settingsPanel=$("contentmenu").next();this.settingsPanel.fire("xwiki:annotations:settings:loaded");B._x_notification.hide();this.displayAnnotationsCheckbox=$("annotationsdisplay");if(this.displayedByDefault&&this.fetchedAnnotations){this.displayAnnotationsCheckbox.checked=true}this.attachSettingsListeners();$("tmAnnotations").toggleClassName("active")}.bind(this),onFailure:function(C){var D=C.statusText;if(C.statusText==""||C.status==12031){D="Server not responding"}B._x_notification.replace(new XWiki.widgets.Notification("Error:"+D,"error",{timeout:5}))},on0:function(C){C.request.options.onFailure(C)},onComplete:function(){B.disabled=false}})}else{this.settingsPanel.toggleClassName("hidden");$("tmAnnotations").toggleClassName("active")}},attachSettingsListeners:function(){this.displayAnnotationsCheckbox.observe("click",function(A){var B=this.displayAnnotationsCheckbox.checked;if(this.displayAnnotationsCheckbox.disabled){return }this.displayAnnotationsCheckbox.disabled=true;if(!this.fetchedAnnotations&&B){this.fetchAnnotations(true)}else{this.toggleAnnotations(B);this.displayAnnotationsCheckbox.disabled=false}}.bindAsEventListener(this))},toggleAnnotations:function(A){if(this.displayHighlight){this.annotatedElement.select(".annotation").invoke(A?"addClassName":"removeClassName","annotation-highlight")}this.annotatedElement.select(".annotation-marker").invoke(A?"removeClassName":"addClassName","hidden");if(!A){this.bubbles.each(function(B){if(B!=this.createPanel){B.remove()}}.bind(this));this.bubbles.clear()}},toggleAnnotationHighlight:function(A,B){this.annotatedElement.select(".annotation.ID"+A).invoke(B?"addClassName":"removeClassName","annotation-highlight")},onFilterChange:function(A){if(A.memo){this.currentFilter=A.memo}var B=this.displayAnnotationsCheckbox?this.displayAnnotationsCheckbox.checked:false;if(B){this.fetchAnnotations(true)}},getExtraFields:function(){return[]},getFilter:function(){return this.currentFilter},prepareRequestParameters:function(C){var F=this.getFilter();for(var B=0;B<F.length;B++){var E=F[B];var D="filter_"+E.name;if(!C.get(D)){C.set(D,[])}C.get(D).push(E.value)}var A=this.getExtraFields();if(A.size()>0){C.set("request_field",[])}for(var B=0;B<A.length;B++){C.get("request_field").push(A[B])}return C},fetchAnnotations:function(A){var B=XWiki.contextPath+"/rest/wikis/"+encodeURIComponent(XWiki.currentWiki)+"/spaces/"+encodeURIComponent(XWiki.currentSpace)+"/pages/"+encodeURIComponent(XWiki.currentPage)+"/annotations?media=json";new Ajax.Request(B,{method:"GET",parameters:this.prepareRequestParameters(new Hash()),onCreate:function(){this._x_notification=new XWiki.widgets.Notification("Carregant document amb anotació","inprogress")}.bind(this),onSuccess:function(C){if(this.checkResponseCodeAndFail(C)){return }this._x_notification.hide();this.loadAnnotatedContent(C.responseJSON.annotatedContent,A);this.fetchedAnnotations=true;if(this.displayAnnotationsCheckbox){this.displayAnnotationsCheckbox.checked=true}}.bind(this),onFailure:function(C){var D=C.statusText;if(C.statusText==""||C.status==12031){D="Server not responding"}this._x_notification.replace(new XWiki.widgets.Notification("Error:"+D,"error",{timeout:5}));if(this.displayAnnotationsCheckbox){this.displayAnnotationsCheckbox.checked=false}}.bind(this),on0:function(C){C.request.options.onFailure(C)}.bind(this),onComplete:function(){if(this.displayAnnotationsCheckbox){this.displayAnnotationsCheckbox.disabled=false}}.bind(this)})},checkResponseCodeAndFail:function(A){if(A.responseJSON&&A.responseJSON.responseCode!=null&&A.responseJSON.responseCode==0){return false}else{if(A.responseJSON){A.statusText=A.responseJSON.responseMessage}else{A.statusText="Resposta del servidor amb format incorrecte"}A.request.options.onFailure(A);return true}},loadAnnotatedContent:function(A,B,D,C){if((A.annotations&&A.annotations.size()>0)||C){this.annotatedElement.update(A.content);this.addAnnotationMarkers(A.annotations);this.reloadTab(D)}if(B){this.toggleAnnotations(true)}},reloadTab:function(B){var A=$(this.annTabname+"pane");if(A){A.update("");A.addClassName("empty");if(!A.hasClassName("hidden")){XWiki.displayDocExtra(this.annTabname,"annotationsinline.vm",B)}}},addDeleteListenersInTab:function(){$$(".annotation a.delete").each(function(A){this.addDeleteListener(A)}.bind(this))},addEditListenersInTab:function(){$$(".annotation a.edit").each(function(B){var A=B.up(".annotation");var C=A.id.substring(16);this.addEditListener(B,C,A.up())}.bind(this))},addValidateListenersInTab:function(){$$(".annotation a.validate").each(function(B){var A=B.up(".annotation");var C=A.id.substring(16);this.addValidateListener(B,C,A)}.bind(this))},addDeleteListener:function(C,B,A){C.observe("click",function(D){C.blur();D.stop();if(C.disabled){return }else{new XWiki.widgets.ConfirmedAjaxRequest(C.href,{parameters:this.prepareRequestParameters(new Hash()),onCreate:function(){C.disabled=true},onSuccess:function(E){if(this.checkResponseCodeAndFail(E)){return }if(B){this.hideBubble(A)}this.fetchedAnnotations=true;this.loadAnnotatedContent(E.responseJSON.annotatedContent,this.displayAnnotationsCheckbox?this.displayAnnotationsCheckbox.checked:this.displayedByDefault,!B,true)}.bind(this),onComplete:function(){C.disabled=false}},{confirmationText:"Esteu segurs que voleu eliminar aquesta anotació?",progressMessageText:"Eliminant anotació...",successMessageText:"Anotació eliminada",failureMessageText:"S'ha produït un error a l'eliminar l'anotació:"})}}.bindAsEventListener(this))},addValidateListener:function(C,D,A,B){C.observe("click",function(E){C.blur();E.stop();this.updateAnnotationAsync(A,D,B,C.href,"POST",new Hash({"state":"SAFE","originalSelection":""}),{successText:"L'anotació ha estat correctament validada.",failureText:"Error:"})}.bindAsEventListener(this))},addEditListener:function(C,D,A,B){C.observe("click",function(E){C.blur();E.stop();if(C.disabled){return }else{new Ajax.Request("/bin/view/AnnotationCode/EditForm",{parameters:{"xpage":"plain","wiki":XWiki.currentWiki,"space":XWiki.currentSpace,"page":XWiki.currentPage,"id":D},onCreate:function(){A.originalContentHTML=A.innerHTML;C.disabled=true;A.update(new Element("div",{"class":"loading"}))},onSuccess:function(F){this.fillEditForm(A,F.responseText,D,B)}.bind(this),onFailure:function(F){var G=F.statusText;if(F.statusText==""||F.status==12031){G="Server not responding"}this._x_notification=new XWiki.widgets.Notification("annotations.action.edit.form.loaderror"+G,"error",{timeout:5});this.fillViewPanel(A,A.originalContentHTML,D,B)}.bind(this),on0:function(F){F.request.options.onFailure(F)}.bind(this),onComplete:function(){C.disabled=false}})}}.bindAsEventListener(this))},addAnnotationMarkers:function(A){A.each(function(D){var E=this.annotatedElement.select("[class~=ID"+D.annotationId+"]");if(E.size()==0){return }var C=E[E.size()-1];var B=new Element("span",{"id":"ID"+D.annotationId,"class":"hidden annotation-marker "+D.state});C.insert({after:B});B.observe("mouseover",this.onMarkerMouseOver.bindAsEventListener(this,D.annotationId))}.bind(this))},onMarkerMouseOver:function(B,C){var A=this.displayLoadingBubble(B.element().cumulativeOffset().top,B.element().cumulativeOffset().left);A.observe("mouseout",function(F,E){var D=F.relatedTarget||F.toElement;if((F.element()==E||F.element().up(".annotation-bubble"))&&(D==null||D.up(".annotation-bubble")==null)){F.stop();this.hideBubble(E);if(!this.displayHighlight){this.toggleAnnotationHighlight(C,false)}}}.bindAsEventListener(this,A));if(!this.displayHighlight){this.toggleAnnotationHighlight(C,true)}this.fetchAndShowAnnotationDetails(C,A)},fetchAndShowAnnotationDetails:function(B,A){new Ajax.Request("/bin/view/AnnotationCode/DisplayForm",{parameters:{"id":B,"xpage":"plain","wiki":XWiki.currentWiki,"space":XWiki.currentSpace,"page":XWiki.currentPage},onSuccess:function(C){this.fillViewPanel(A,C.responseText,B,true)}.bind(this),onFailure:function(C){var D=C.statusText;if(C.statusText==""||C.status==12031){D="Server not responding"}this.hideBubble(newBubble);this._x_notification=new XWiki.widgets.Notification("Error:"+D,"error",{timeout:5})}.bind(this),on0:function(C){C.request.options.onFailure(C)}.bind(this)})},displayLoadingBubble:function(C,B){var A=new Element("div",{"class":"annotation-bubble"});A.insert({top:new Element("div",{"class":"loading"})});document.body.insert({bottom:A});A.toggleClassName("hidden");A.style.left=B+"px";A.style.top=C+"px";A.toggleClassName("hidden");this.bubbles.push(A);return A},displayAnnotationViewBubble:function(A){},safeUpdate:function(A,B){if(!A.parentNode){return false}A.update(B);return true},fillEditForm:function(B,D,E,C){if(!this.safeUpdate(B,D)){return }B.stopObserving("mouseout");var F=B.down("a.delete");if(F){this.addDeleteListener(F,C,B)}var A=B.down("a.validate");if(A){this.addValidateListener(A,E,B,C)}B.down("form").focusFirstElement();B.down("input[type=submit]").observe("click",this.onAnnotationEdit.bindAsEventListener(this,B,E,C));B.down("input[type=reset]").observe("click",function(G){if(C){this.hideBubble(B)}else{this.fillViewPanel(B,B.originalContentHTML,E,false)}}.bindAsEventListener(this))},onAnnotationEdit:function(D,A,E,C){D.stop();var B=A.down("form");var F=new Hash(B.serialize(true));this.updateAnnotationAsync(A,E,C,B.action,B.method,F,{successText:"L'anotació ha estat correctament actualitzada.",failureText:"Error:"})},updateAnnotationAsync:function(A,F,D,E,G,C,B){new Ajax.Request(E,{method:G,parameters:this.prepareRequestParameters(C),onCreate:function(){if(A.parentNode){A.update(new Element("div",{"class":"loading"}))}},onSuccess:function(H){if(this.checkResponseCodeAndFail(H)){return }this._x_notification=new XWiki.widgets.Notification(B.successText,"done");if(D){this.hideBubble(A)}this.fetchedAnnotations=true;this.loadAnnotatedContent(H.responseJSON.annotatedContent,this.displayAnnotationsCheckbox?this.displayAnnotationsCheckbox.checked:this.displayedByDefault,!D)}.bind(this),onFailure:function(H){var I=H.statusText;if(H.statusText==""||H.status==12031){I="Server not responding"}this._x_notification.replace(new XWiki.widgets.Notification(B.failureText+I,"error",{timeout:5}));if(D){this.hideBubble(A)}else{this.fillViewPanel(A,A.originalContentHTML,F,false)}}.bind(this),on0:function(H){H.request.options.onFailure(H)}})},fillViewPanel:function(B,D,F,C){if(!this.safeUpdate(B,D)){return }var G=B.down("a.delete");if(G){this.addDeleteListener(G,C,B)}var A=B.down("a.validate");if(A){this.addValidateListener(A,F,B,C)}var E=B.down("a.edit");if(E){this.addEditListener(E,F,B,C)}},hideBubble:function(A){if(!A.parentNode){return }A.remove();var B=this.bubbles.indexOf(A);if(B>=0){this.bubbles.splice(B,1)}},registerAddAnnotationShortcut:function(){var B=this.onAddAnnotationShortcut;for(var A=0;A<this.addAnnotationShortcuts.size();++A){if(Prototype.Browser.IE||Prototype.Browser.WebKit){shortcut.add(this.addAnnotationShortcuts[A],B.bindAsEventListener(this),{type:"keyup"})}else{shortcut.add(this.addAnnotationShortcuts[A],B.bindAsEventListener(this),{type:"keypress"})}}},unregisterAddAnnotationShortcut:function(){for(var A=0;A<this.addAnnotationShortcuts.size();++A){shortcut.remove(this.addAnnotationShortcuts[A])}},registerCloseDialogShortcut:function(){var B=this.closeOpenBubble;for(var A=0;A<this.closeDialogShortcuts.size();++A){if(Prototype.Browser.IE||Prototype.Browser.WebKit){shortcut.add(this.closeDialogShortcuts[A],B.bindAsEventListener(this),{type:"keyup"})}else{shortcut.add(this.closeDialogShortcuts[A],B.bindAsEventListener(this),{type:"keypress"})}}},closeOpenBubble:function(){if(this.bubbles.length>0){var A=this.bubbles[this.bubbles.length-1];if(A==this.createPanel){this.hideAnnotationCreationForm()}else{this.hideBubble(A)}}},onAddAnnotationShortcut:function(){if(XWiki.docsyntax=="xwiki/1.0"){new XWiki.widgets.Notification("Les anotacions no estan disponibles per als documents amb sintaxis XWiki/1.0.","warning");return }this.selectionService.computeSelection();var A=this.selectionService.selectionText;if(!A){new XWiki.widgets.Notification("Seleccioneu un text no buit al contingut del document.","error",{timeout:5})}else{this.selectionService.computeContext();new Ajax.Request("/bin/view/AnnotationCode/CreateForm",{parameters:{"xpage":"plain","selection":A,"selectionContext":this.selectionService.selectionContext,"selectionOffset":this.selectionService.selectionOffset,"wiki":XWiki.currentWiki,"space":XWiki.currentSpace,"page":XWiki.currentPage},onCreate:function(){this.displayAnnotationCreationForm()}.bind(this),onSuccess:function(B){this.fillCreateForm(this.createPanel,B.responseText)}.bind(this),onFailure:function(B){var C=B.statusText;if(B.statusText==""||B.status==12031){C="Server not responding"}this._x_notification=new XWiki.widgets.Notification("Error:"+C,"error",{timeout:5});this.hideAnnotationCreationForm()}.bind(this),on0:function(B){B.request.options.onFailure(B)}.bind(this)})}},displayAnnotationCreationForm:function(){this.selectionService.highlightSelection("#FFEE99");var A=this.selectionService.getPositionNextToSelection();this.createPanel=this.displayLoadingBubble(A.top,A.left);this.unregisterAddAnnotationShortcut()},fillCreateForm:function(A,B){if(!this.safeUpdate(this.createPanel,B)){return }this.createPanel.select("form").first().focusFirstElement();this.createPanel.down("input[type=submit]").observe("click",this.onAnnotationAdd.bindAsEventListener(this));this.createPanel.down("input[type=reset]").observe("click",function(){this.hideAnnotationCreationForm()}.bind(this))},hideAnnotationCreationForm:function(A){this.hideBubble(this.createPanel);if(!A){this.selectionService.removeSelectionHighlight()}this.registerAddAnnotationShortcut()},onAnnotationAdd:function(B){B.stop();var A=this.createPanel.down("form");var C=new Hash(A.serialize(true));new Ajax.Request(A.action,{method:A.method,parameters:this.prepareRequestParameters(C),onCreate:function(){this.createPanel.update(new Element("div",{"class":"loading"}))}.bind(this),onSuccess:function(D){if(this.checkResponseCodeAndFail(D)){return }this.loadAnnotatedContent(D.responseJSON.annotatedContent,this.displayAnnotationsCheckbox?this.displayAnnotationsCheckbox.checked:this.displayedByDefault);this.fetchedAnnotations=true;A._x_notification=new XWiki.widgets.Notification("L'anotació ha esta correctament afegida.","done");this.hideAnnotationCreationForm(true)}.bind(this),onFailure:function(D){this.hideAnnotationCreationForm();var E=D.statusText;if(D.statusText==""||D.status==12031){E="Server not responding"}this._x_notification=new XWiki.widgets.Notification("Error:"+E,"error",{timeout:5})}.bind(this),on0:function(D){D.request.options.onFailure(D)}})}});document.observe("xwiki:dom:loaded",function(){if(XWiki.contextaction!="view"){return }var E=false;var D=false;var A=false;var C=[];var B=C.indexOf(XWiki.currentSpace);if((A&&B<0)||(!A&&B>=0)){new XWiki.Annotation(E,$("xwikicontent"),D)}})
