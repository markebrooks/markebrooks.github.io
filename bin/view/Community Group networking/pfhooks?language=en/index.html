<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                                    <title>Solaris Packet Filtering Hooks (Community Group networking.pfhooks) - XWiki</title>
                <meta http-equiv="Content-Script-Type" content="text/javascript" />
                        <meta http-equiv="imagetoolbar" content="no"/>
                      <link rel="alternate" type="application/x-wiki" title="Edit" href="/bin/edit/Community+Group+networking/pfhooks" />
                    <link rel="canonical" href="/bin/view/Community+Group+networking/pfhooks" />
                            <meta name="document" content="Community Group networking.pfhooks"/>
    <meta name="wiki" content="xwiki"/>
    <meta name="space" content="Community Group networking"/>
    <meta name="page" content="pfhooks"/>
    <meta name="version" content="1.1"/>
    <meta name="restURL" content="/rest/wikis/xwiki/spaces/Community+Group+networking/pages/pfhooks"/>
                <meta name="gwt:property" content="locale=en" />
                <meta name="revisit-after" content="7 days" />
<meta name="description" content="Solaris Packet Filtering Hooks" />
<meta name="keywords" content="wiki " />
<meta name="distribution" content="GLOBAL" />
<meta name="rating" content="General" />
<meta name="author" content="admin" />
<meta http-equiv="reply-to" content="" />
<meta name="language" content="en" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Wiki Feed RSS" href="/bin/view/Main/WebRss?xpage=rdf" />
<link rel="alternate" type="application/rss+xml" title="Blog RSS Feed" href="/bin/view/Blog/GlobalBlogRss?xpage=plain" />
<link rel="shortcut icon" href="/resources/icons/oso/icon.png">
                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
<link href="https://markebrooks.github.io/static/css/stylesheet.css" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/style.css?colorTheme=ColorThemes.Oso" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/print.css" rel="stylesheet" type="text/css" media="print" />
        <!--[if IE]>
  <link href="/bin/skin/skins/colibri/ie%2Dall.css" rel="stylesheet" type="text/css" />
<![endif]-->
<!--[if IE 6]>
  <link href="/bin/skin/skins/colibri/ie%2D6.css" rel="stylesheet" type="text/css" />
<![endif]-->
<link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Settings?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Style?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/XWiki/SharePage?language=en'/>
<link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/modalPopup.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/jumpToPage.css?language=en'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/confirmationBox.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/notification.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.css'/>

    
    <link href="/bin/skin/resources/js/xwiki/suggest/ajaxSuggest.css" rel="stylesheet" type="text/css" />
<link href="/bin/skin/resources/js/xwiki/lightbox/lightbox.css" rel="stylesheet" type="text/css" />
<!--[if IE]>
  <link href="/bin/skin/resources/js/xwiki/lightbox/lightboxIE.css" rel="stylesheet" type="text/css" />
<![endif]-->












<script type="text/javascript" src="/resources/js/prototype/prototype.js"></script>
<script type="text/javascript" src="/bin/skin/resources/js/xwiki/xwiki.js"></script>
<script type="text/javascript">
// <![CDATA[
XWiki.webapppath = "";
XWiki.servletpath = "bin/";
XWiki.contextPath = "";
XWiki.mainWiki = "xwiki";
XWiki.currentWiki = "xwiki";
XWiki.currentSpace = "Community Group networking";
XWiki.currentPage = "pfhooks";
XWiki.editor = "";
XWiki.viewer = "";
XWiki.contextaction = "view";
XWiki.docisnew = false;
XWiki.docsyntax = "xwiki/2.0";
XWiki.blacklistedSpaces = [ "Import","Panels","Scheduler","Stats","XAppClasses","XAppSheets","XAppTemplates","XWiki","WatchCode","WatchSheets","XApp","WatchAdmin","Watch","ColorThemes","AnnotationCode" ];
XWiki.hasEdit = false;
XWiki.hasProgramming = false;
XWiki.hasBackupPackImportRights = false;
window.docviewurl = "/bin/view/Community+Group+networking/pfhooks";
window.docediturl = "/bin/edit/Community+Group+networking/pfhooks";
window.docsaveurl = "/bin/save/Community+Group+networking/pfhooks";
window.docgeturl = "/bin/get/Community+Group+networking/pfhooks";
// ]]>
</script>
<script type='text/javascript' src='/bin/skin/resources/js/scriptaculous/effects.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/modalPopup.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/jumpToPage.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmationBox.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmedAjaxRequest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/notification.js' defer='defer'></script>
<script type='text/javascript' src='/resources/uicomponents/widgets/list/xlist.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/suggest/ajaxSuggest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/scriptaculous/scriptaculous.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/accordion/accordion.js' defer='defer'></script>

<script type='text/javascript' src='/bin/jsx/XWiki/WebDAV?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Settings?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Script?language=en' defer='defer'></script>

<script type="text/javascript" src="/resources/js/xwiki/compatibility.js" defer="defer"></script>

  </head>
  <body id="body" class="wiki-xwiki space-Community_Group_networking viewbody hideright">
<div id="xwikimaincontainer">
<div id="xwikimaincontainerinner">

  <div id="menuview">
    <div id="mainmenu" class="layoutsubsection actionmenu">
<strong id="xwikimenutitle" class="hidden">General Actions:</strong>
<div class="rightmenu">
      <div id="tmLogin" class="tmLogin topmenuentry ">
   <a class="tme" href="https://auth.opensolaris.org/login.action?targetUrl=http%3A%2F%2Fmarkebrooks.github.io%2Fbin%2Fview%2FCommunity%2BGroup%2Bnetworking%2Fpfhooks%3Flanguage%3Den"><strong>Log-in</strong></a>
  </div>
  </div>
<div class="leftmenu">
  <div id="tmWiki" class="tmWiki topmenuentry hasIcon">
   <a class="tme" href="/bin/view/Main/"><strong>Wiki</strong></a>
  </div>
  <div id="tmSpace" class="tmSpace topmenuentry dropdownmenuentry  hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Community+Group+networking/"><strong>Community Group networking</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
                <span class="submenuitem "><a href="/bin/view/Main/SpaceIndex?space=Community+Group+networking" id="tmSpaceDocumentIndex" class="tmSpaceDocumentIndex">Document Index</a></span>
    </span></div>

<div id="tmSubSites" class="tmSubSites topmenuentry dropdownmenuentry dropdownnolink hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Subsites</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem hasIcon"><a href="https://cr.opensolaris.org/" id="tmCR" class="tmCR">Code Reviews</a></span>
<span class="submenuitem hasIcon"><a href="http://repo.opensolaris.org/" id="tmRepo" class="tmRepo">SCM Management</a></span>
<span class="submenuitem hasIcon"><a href="http://pkg.opensolaris.org/" id="tmPkg" class="tmPkg">Package Search</a></span>
<span class="submenuitem hasIcon"><a href="http://bugs.opensolaris.org/" id="tmBugs" class="tmBugs">Bugster</a></span>
<span class="submenuitem hasIcon"><a href="http://defect.opensolaris.org/" id="tmDefect" class="tmDefect">Bugzilla</a></span>
<span class="submenuitem hasIcon"><a href="http://test.opensolaris.org/" id="tmTest" class="tmTest">Test Machines</a></span>
<span class="submenuitem hasIcon"><a href="http://planet.opensolaris.org/" id="tmPlanet" class="tmPlanet">Planet</a></span>
<span class="submenuitem hasIcon"><a href="http://mail.opensolaris.org/" id="tmMail" class="tmMail">Mailing Lists</a></span>
<span class="submenuitem hasIcon"><a href="http://poll.opensolaris.org/" id="tmPoll" class="tmPoll">Elections &amp; Polls</a></span>
<span class="submenuitem hasIcon"><a href="http://arc.opensolaris.org/" id="tmArc" class="tmArc">ARC Case Logs</a></span>
<span class="submenuitem hasIcon"><a href="http://jucr.opensolaris.org/" id="tmJucr" class="tmJucr">Source Juicer</a></span>
<span class="submenuitem hasIcon"><a href="http://pkgfactory.opensolaris.org/" id="tmPkgfactory" class="tmPkgfactory">Package Factory</a></span>
<span class="submenuitem hasIcon"><a href="http://auth.opensolaris.org/" id="tmAuth" class="tmAuth">Auth</a></span>
</span></div>

</div>
</div>

  </div>
 <div id="header" class="layoutsection">
<div class="minwidthb"></div>

  <div id="header">
    <table style="width: 100%;">
        <tr>
            <td style="width: 1%;">
                 <a href="https://markebrooks.github.io/bin/view/Main/"><div id="logo"></div></a>  
            </td>
            <td id="logo-text" style="width: 1%;">
                Solaris
            </td>         
            <td style="width: 98%;">
                <table id="loading-indicator">
                    <tr>
                        <td><img src="https://markebrooks.github.io:443/static/images/busy.gif"
                                 alt="Loading" title="Loading"/></td>
                        <td>Loading...</td>
                    </tr>
                </table>
            </td>
            <td style="width: 1%;">
                <table id="iconbar">
                    <tr>
                    <td><a id="collectives-icon" href="https://markebrooks.github.io/bin/view/Main/collectives">
                        Collectives</a></td>
                    <td><a id="discussions-icon" href="https://markebrooks.github.io/bin/view/Main/discussions">
                            Discussions</a></td>
                    <td><a id="documentation-icon" href="https://markebrooks.github.io/bin/view/Main/documentation">
                            Documentation</a></td>
                    <td><a id="download-icon" href="https://markebrooks.github.io/bin/view/Main/downloads">
                            Download</a></td>
                    <td><a id="source-browser-icon" href="http://src.opensolaris.org/source">
                            Source Browser</a></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

 </div> 
  <div id="globallinks">
    <form action="/bin/view/Main/Search">
      <div class="globalsearch">
        <label class="hidden" for="headerglobalsearchinput">Search</label><input class="globalsearchinput withTip" id="headerglobalsearchinput" type="text" name="text" value="search..." size="15"/><input class="button" type="image" value="Go" alt="Go" src="/resources/icons/xwiki/search.png"/>
      </div>
    </form>
  </div> <div style="float:left;">

                

   <div id="hierarchy">
                              <a href='/bin/view/Community+Group+networking/docs'>Documentation</a> <span class='separator'>&#187;</span> <span class='current'>Solaris Packet Filtering Hooks</span>
                </div>

</div>
  <span class="glink" id="headerlanguages" style="float:right">
        <a href="/bin/view/Community+Group+networking/pfhooks?language=en" class="language-default language-current">en</a>
    </span>


<div class="contenthideright" id="contentcontainer">
<div id="contentcontainerinner">
<div class="leftsidecolumns">
  <div id="contentcolumn"> 
          <div class="main layoutsubsection">
      <div id="contentmenu" class="actionmenu">
    <strong id="xwikicontentmenutitle" class="hidden">Page Actions:</strong>
<div class="rightmenu">
</div>
<div class="leftmenu">
  <div id="tmExport" class="tmExport topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Export</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/export/Community+Group+networking/pfhooks?format=pdf&amp;language=en" id="tmExportPdf" class="tmExportPdf">Export as PDF</a></span>
  <span class="submenuitem "><a href="/bin/export/Community+Group+networking/pfhooks?format=rtf&amp;language=en" id="tmExportRtf" class="tmExportRtf">Export as RTF</a></span>
  <span class="submenuitem "><a href="/bin/export/Community+Group+networking/pfhooks?format=html&amp;language=en" id="tmExportHtml" class="tmExportHtml">Export as HTML</a></span>
    </span></div>

<div id="tmShow" class="tmShow topmenuentry dropdownmenuentry  " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Community+Group+networking/pfhooks?viewer=code&amp;language=en"><strong>View</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?viewer=comments&amp;language=en" id="tmViewComments" class="tmViewComments">Comments</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?viewer=attachments&amp;language=en" id="tmViewAttachments" class="tmViewAttachments">Attachments</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?viewer=history&amp;language=en" id="tmViewHistory" class="tmViewHistory">History</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?viewer=information&amp;language=en" id="tmViewInformation" class="tmViewInformation">Information</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?viewer=code&amp;language=en" id="tmViewSource" class="tmViewSource">View Source</a></span>
</span></div>

  <div id="tmMoreActions" class="tmMoreActions topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>More actions</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?xpage=print&amp;language=en" id="tmPrintPreview" class="tmPrintPreview">Print preview</a></span>
          <span class="submenuitem "><a href="/bin/view/Community+Group+networking/pfhooks?xpage=copy" id="tmActionCopy" class="tmActionCopy">Copy</a></span>
      </span></div>
</div>

    </div>
    <div id="mainContentArea">
      








                      
<div id="document-title"><h1>Solaris Packet Filtering Hooks</h1></div>





              <div id="document-info">
    <div>
          </div>
    <div class="clearfloats"></div>
  </div>

<div id="xwikicontent">
<h1 class='hidden'>Solaris Packet Filtering Hooks</h1><p><em>Author: Darren Reed, March 2009</em></p><h2 id="HIntroduction"><span>Introduction</span></h2><p>&nbsp;Starting with the release of Solaris 10, networking inside the Solaris kernel has evolved away from being centered on the SVR4 STREAMS approach to a newer design that supports better performance. Whilst the system has continued to support the old interfaces, using them has often meant there is a performance cost.</p><p>&nbsp;A classic example of this is the use of STREAMS modules between TCP/IP and network interface drivers, typically used by firewalls and other software packages to inspect all of the packets.</p><p>&nbsp;To bring filtering of packets into line with the developments in other parts of Solaris, we've developed a new interface, known as the Packet Filtering Hooks. In addition to providing the means to be notified each time a packet appears at one of the hook points, this new interface also provides the developer with kernel access to other basic network interface information, such as their names and addresses associated with them.</p><p>&nbsp;Callbacks and notifications are available to the programmer to provide them with information about when a new instance of IP is created to support a new Zone booting that requries an exclusive instance of IP. Finally, for the first time on Solaris, it is possible to intercept packets on the loopback interface. The loopback packet interception also provides the developer with access to packets as they move between zones that are using a shared instance of IP, the default model.</p><p>&nbsp;In summary, the introduction of Packet Filtering Hooks into Solaris brings into line with the needs and expectations of developers who are looking to develop value added network solutions at the kernel level, be they for security (packet filtering/firewall), network address translation (NAT) or other purposes. For Solaris users, these interfaces are available in Solaris 10 Update 7 and later. For OpenSolaris users, these interfaces are available in OpenSolaris 2009.06 and later.</p><h2 id="HTheAPI"><span>The API</span></h2><h3 id="HKernelfunctions"><span>Kernel functions</span></h3><p>&nbsp;The folliowing functions are exported from the misc/neti and misc/hook kernel modules to support packet filtering. Developers writing code to interface with these functions will need to link their kernel module(s) with -Nmisc/neti and -Nmisc/hook in order to be correctly loaded by the kernel.</p><ul><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/hook-alloc-9f?a=view">hook_alloc</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/hook-free-9f?a=view">hook_free</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-event-notify-register-9f?a=view">net_event_notify_register</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-event-notify-unregister-9f?a=view">net_event_notify_unregister</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-getifname-9f?a=view">net_getifname</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-getlifaddr-9f?a=view">net_getlifaddr</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-getmtu-9f?a=view">net_getmtu</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-getpmtuenabled-9f?a=view">net_getpmtuenabled</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-hook-reguster-9f?a=view">net_hook_register</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-hook-unregister-9f?a=view">net_hook_unregister</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-inject-9f?a=view">net_inject</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-inject-alloc-9f?a=view">net_inject_alloc</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-inject-free-9f?a=view">net_inject_free</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-alloc-9f?a=view">net_instance_alloc</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-free-9f?a=view">net_instance_free</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-notify-register-9f?a=view">net_instance_notify_register</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-notify-unregister-9f?a=view">net_instance_notify_unregister</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-register-9f?a=view">net_instance_register</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-instance-unregister-9f?a=view">net_instance_unregister</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-ispartialchecksum-9f?a=view">net_ispartialchecksum</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-isvalidchecksum-9f?a=view">net_isvalidchecksum</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-kstat-create-9f?a=view">net_kstat_create</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-kstat-delete-9f?a=view">net_kstat_delete</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-lifgetnext-9f?a=view">net_lifgetnext</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-phygetnext-9f?a=view">net_phygetnext</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-phylookup-9f?a=view">net_phylookup</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-protocol-lookup-9f?a=view">net_protocol_lookup</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-protocol-notify-registern-9f?a=view">net_protocol_notify_register</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-protocol-notify-unregistern-9f?a=view">net_protocol_notify_unregister</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-protocol-release-9f?a=view">net_protocol_release</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2256/net-routeto-9f?a=view">net_routeto</a></span></li></ul><h3 id="HTypes"><span>Types</span></h3><p>&nbsp;The following types have been introduced as part of this API to support the functions above.</p><ul><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2257/hook-t-9s?a=view">hook_t</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2257/hook-nic-event-t-9s?a=view">hook_nic_event_t</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2257/hook-pkt-event-t-9s?a=view">hook_pkt_event_t</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2257/net-inject-t-9s?a=view">net_inject_t</a></span></li><li><span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2257/net-instance-t-9s?a=view">net_instance_t</a></span></li></ul><h2 id="HUsingtheAPI"><span>Using the API</span></h2><h3 id="HIntroduction-1"><span>Introduction</span></h3><p>&nbsp;There is a substantial amount of programming required to properly setup working with this API as it supports multiple instances of the IP stack running concurrently in the same kernel. When the IP stack was extended to allow multiple instances of itself for zones, it was also deemed necessary to have multiple instances of the framework supporting packet interception in IP. This section of the document will explore what's necessary to use this API to receive inbound IPv4 packets.</p><h3 id="HStartingout"><span>Starting out</span></h3><p>&nbsp;To start out using the API, it is first necessary to decide whether or not to cater to multiple instances of IP running in the kernel or to only interact with the global zone. This document will focus on what is necessary to set up code to get running. It will not go into any depth on shutdown/destroy, that is left as an exercise for the reader.</p><h3 id="HBeingInstanceAware"><span>Being Instance Aware</span></h3><p>&nbsp;To be aware of the presence of IP instances, it is necessary to register callback functions that get activated when an instance is created, shutdown and destroyed. The structure used to store these three function pointers in should be allocated through a call to <strong>net_instance_alloc</strong>) and later free'd when it is no longer required by calling <strong>net_instance_free</strong>. The programmer is expected to give the instance a name, through setting nin_name and specify at least the create (<strong>nin_create</strong>) and destroy (<strong>nin_destroy</strong>) callbacks. Modifying <strong>nin_version</strong> is prohibited. Setting <strong>nin_shutdown</strong> is optional unless the code will be exporting information to kstats. To use kstats on a per-instance basis, it is necessary to use the function <strong>net_kstat_create</strong> as part of your work during the create callback. Cleanup of the kstat information must happen during the shutdown callback, <strong>not</strong> the destroy callback and is done by calling <strong>net_kstat_delete</strong>.</p><pre>

extern void *mycreate(const netid_t);

net_instance_t *n;

n = net_instance_alloc(NETINFO_VERSION);
if (n != NULL) {
	n-&gt;nin_create = mycreate;
	n-&gt;nin_destroy = mydestroy;
	n-&gt;nin_name = "my module";
	if (net_instance_register(n) != 0)
		net_instance_free(n);
}

</pre><p>&nbsp;If there is already 1 or more instances present when this function call is made, the create callback will be called for each currently active instance of IP. The framework that supports the callbacks being made will ensure that only one of the create/destroy/shutdown functions is active at any one time for a given instance and that once created has been called, shutdown will only be called after create has been completed and similarly destroy does not start until shutdown is complete.</p><p>&nbsp;The function below, <em>mycreate</em>, is a simple example of what might be used as the callback when an instance is created. All that this function does is record the network instance identifier in its own private context structure and register a new callback to be called when a new protocol (such as IPv4 or IPv6) is registered with this framework.</p><p>&nbsp;Remember that even if there are no zones running (and therefore no instances other than the global zone), calling <strong>net_instance_register</strong> will always result in the <strong>nin_create</strong> being exercised for the global zone. As part of the programming to use this interface, it is always necessary to supply the destroy callback so that <strong>net_instance_unregister</strong> can be later called. Attempts to call <strong>net_instance_register</strong> with either the <strong>nin_create</strong> or <strong>nin_destroy</strong> fields set to NULL will fail.</p><pre>

void *
mycreate(const netid_t id)
{
	mytype_t *ctx;

	ctx = kmem_alloc(sizeof(*ctx), KM_SLEEP);
	ctx-&gt;instance_id = id;
	net_instance_notify_register(id, mynewproto, ctx);
	return (ctx);
}

</pre><p>&nbsp;The function <em>mynewproto</em> should expect to be called each time a network protocol is either added to or removed from a networking instance. If there already registered network protocols operating within the given instance, then the create callback will be called for each one that already exists.</p><h3 id="HProtocolRegistration"><span>Protocol Registration</span></h3><p>&nbsp;For this callback, only the proto argument is filled in by the caller - there is neither an event nor hook name that can be meaningfully supplied at this point. In this example function, only events that announce the registration of the IPv4 protocol are being looked for.</p><p>&nbsp;The next step, in this function, is to discover when events are added to the IPv4 protocol by registering the function <em>mynewevent</em> using the <strong>net_protocol_notify_register</strong> interface.</p><pre>

static int
mynewproto(hook_notify_cmd_t cmd, void *arg, const char *proto,
    const char *event, const char *hook)
{
        mytype_t *ctx = arg;

	if (strcmp(proto, NHF_INET) != 0)
		return (0);

	switch (cmd) {
	case HN_REGISTER :
		ctx-&gt;inet = net_protocol_lookup(s-&gt;id, proto);
		net_protocol_notify_register(s-&gt;inet, mynewevent, ctx);
		break;

	case HN_UNREGISTER :
	case HN_NONE :
       		break;
	}

	return (0);
}

</pre><p>&nbsp;The table below lists all three protocols that could be expected to be seen with the <em>mynewproto</em> callback. In time new protocols may be added, so it is important to safely fail (return the value 0) any unknown protocols.</p><table><tr><td>Programming symbol</td><td>Protocol</td></tr><tr><td>NHF_INET</td><td>IPv4</td></tr><tr><td>NHF_INET6</td><td>IPv6</td></tr><tr><td>NHF_ARP</td><td>ARP</td></tr></table><h3 id="HEventRegistration"><span>Event Registration</span></h3><p>&nbsp;Just as the handling of instances and protocols is dynamic, so too is that of the events which live under each protocol. At present there are two types of events supported by this API: network interface events and packet events.</p><p>&nbsp;In the function below, the announcement for the presence of the event for inbound packets for IPv4 is being checked for. When that is seen, a <strong>hook_t</strong> structure is allocated, describing the function to be called for each inbound IPv4 packet.</p><pre>

static int
mynewevent(hook_notify_cmd_t cmd, void *arg, const char *parent,
    const char *event, const char *hook)
{
	mytype_t *ctx = arg;
	char buffer[32];
	hook_t *h;

	if ((strcmp(event, NH_PHYSICAL_IN) == 0) &amp;&amp;
	    (strcmp(parent, NHF_INET) == 0)) {
		sprintf(buffer, "mypkthook_%s_%s", parent, event);
		h = hook_alloc(HOOK_VERSION);
		h-&gt;h_hint = HH_NONE;
		h-&gt;h_arg = s;
		h-&gt;h_name = strdup(buffer);
		h-&gt;h_func = mypkthook;
		s-&gt;hook_in = h;
		net_hook_register(ctx-&gt;inet, (char *)event, h);
	} else {
		h = NULL;
	}
	return (0);
}

</pre><p>&nbsp;The function <em>mynewevent</em> will be called for each event that is added and removed.</p><p>The following list of events are available for use today:</p><table><tr><td>Event Name</td><td>Data structure</td><td>Comment</td></tr><tr><td>NH_PHYSICAL_IN</td><td>hook_pkt_event_t</td><td>This event is generated for every packet that arrives at the network protocol and has been received from a network interface driver.</td></tr><tr><td>NH_PHYSICAL_OUT</td><td>hook_pkt_event_t</td><td>&nbsp;This event is generated for every packet prior to delivery to the network interface driver for sending from the network protocol layer.</td></tr><tr><td>NH_FORWARDING</td><td>hook_pkt_event_t</td><td>This is for all packets that have been received by the system and will be sent out another network interface. It happens after NH_PHYSICAL_IN and before NH_PHYSICAL_OUT</td></tr><tr><td>NH_LOOPBACK_IN</td><td>hook_pkt_event_t</td><td>&nbsp;This event is generated for packets that are <em>received</em> on the loopback interface or that are received by a zone that is sharing its network instance with the global zone.</td></tr><tr><td>NH_LOOPBACK_OUT</td><td>hook_pkt_event_t</td><td>&nbsp;This event is generated for packets that are <em>sent</em> on of the loopback interface or that are being sent by a zone that is sharing its network instance with the global zone.</td></tr><tr><td>NH_NIC_EVENTS</td><td>hook_nic_event_t</td><td>This event is generated for specific changes of state for network interfaces.</td></tr></table><h4 id="HNetworkInterfaceEvents"><span>Network Interface Events</span></h4><p>&nbsp;For packet events, there is one specific event for each particular point in the IP stack. This is to enable the developer to be selective about exactly where in the flow of the packets they wish to intercept packets, without having to be overburdened by examining every packet event that happens inside the kernel. For network interface events, the model is different, in part because the events are much lower in volume and because it is more likely that the developer will be interested in several of them, not just one.</p><p>&nbsp;The network interface event announces when interfaces...</p><ul><li>... are created (<strong>NE_PLUMB</strong>) or destroyed (<strong>NE_UNPLUMB</strong>).</li><li>... change state to up (<strong>NE_UP</strong>) or down (<strong>NE_DOWN</strong>).</li><li>... have an address change (<strong>NE_ADDRESS_CHANGE</strong>).</li></ul><p>&nbsp;Over time new network interface events may be added so it is important to always return 0 for any unknown or unrecognised event that the callback function receives.</p><h3 id="HThePacketHook"><span>The Packet Hook</span></h3><p>&nbsp;Finally, we have arrived in the function that is called when a packet is received. In this case the function <em>mypkthook</em> should expect to be called for each inbound packet that arrives in the kernel from a physical network interface. Packets generated internally, that flow between zones using the shared IP instance model or over the loopback interface, will not be seen.</p><p>&nbsp;To illustrate the difference between accepting a packet and allowing it to return normally with what's required to drop a packet, the code below prints out the source and destination address of every 100th packet and then drops it, introducing a packet loss of 1%.</p><pre>

static int
mypkthook(hook_event_token_t tok, hook_data_t data, void *arg)
{
	static int counter = 0;
	mytupe_t *ctx = arg;
	hook_pkt_event_t *pkt = (hook_pkt_event_t)data;
	struct ip *ip;
	size_t bytes;

	bytes = msgdsize(pkt-&gt;hpe_mb);

	ip = (struct ip *)pkt-&gt;hpe_hdr;

	counter++;
	if (counter == 100) {
		printf("drop %d bytes received from %x to %x\n", bytes,
		    ntohl(ip-&gt;ip_src.s_addr), ntohl(ip-&gt;ip_dst.s_addr));
		counter = 0;

		freemsg(*pkt-&gt;hpe_mp);
		*pkt-&gt;hpe_mp = NULL;
		pkt-&gt;hpe_mb = NULL;
		pkt-&gt;hpe_hdr = NULL;

		return (1);
	}

	return (0);
}

</pre><p>&nbsp;Packets received by this function, and all others that are called as a callback from a packet event, are done so one at a time. There is no chaning together of packets with this interface, so the developer should expect there to be only one packet per call and for b_next to always be NULL. It is important to remember that whilst there is no other packet, a single packet may be comprised of several mblk_t's chained together with b_cont.</p><h3 id="HAFullyWorkedExample"><span>A Fully Worked Example</span></h3><p>&nbsp;For a fully worked example that can be compiled and loaded into the kernel, please look at <span class="wikiexternallink"><a href="https://markebrooks.github.io/bin/download/Community+Group+networking/files/full.c.gz">full.c</a></span>.</p><p>&nbsp;To compile this code into a working kernel module, on a 64bit system the following should be sufficient:</p><pre>

gcc -D_KERNEL -m64 -c full.c
ld -dy -Nmisc/neti -Nmisc/hook -r full.o -o full

</pre>
</div>


    <div class="clearfloats"></div>
  </div>      <div id="xdocFooter">
  
                

       <div class="doc-tags" id="xdocTags">
        Tags:
        </div>
  
  <div id="xdocAuthors">
    <div class="xdocCreation">       Created by admin on 2009/10/26 12:08<br/>
          </div>
    <div class="xdocLastModification">       Last modified by admin on 2009/10/26 12:08
    </div>
  </div>
</div>
<div id="xwikidata" class="layoutsubsection">
        </div>  
    </div>      </div><div id="leftPanels" class="panels left">
                  <div class="panel expanded OSNav">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSNav');">Collectives</h1>
<div class="xwikipanelcontents">
<div id="xwikinavcontainer">
<span class="wikilink"><a href="/bin/view/Main/communities">Community Groups</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/projects">Projects</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/usergroups">User Groups</a></span>
</div><p/>
<script type="text/javascript">
document.observe('xwiki:dom:loaded', function() {
var obj = {div:'xwikinav',no:$count,height:250};
var acc = createAccordion(obj);
});
</script>
</div>
</div>
                        <div class="panel expanded OSDocs">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSDocs');">Community Group networking Pages</h1>
<div class="xwikipanelcontents">
<ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/docs">Documentation</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/dtrace_networking_cookbook">DTrace Networking Cookbook</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/pfhooks">Solaris Packet Filtering Hooks</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/files">Files</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/projects">Networking Projects</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/emulex%2Dcna">Emulex Advanced Ethernet Device Driver</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/qlogic%2Dcna">QLogic CNA GLDv3 Driver</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/tests">Network Tests</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+networking/nc">Netcat Test Suite</a></span></li>
</ul></li>
</ul>
                              </div>
</div>
      </div>

  </div>
<div class="clearfloats"></div>
  </div></div><div id="footerglobal" class="layoutsection">
<div class="minwidth"></div>
<hr/>
        <div id="xwikiplatformversion">XWiki Enterprise 2.7.1.34853 - <a onclick="openURL('http://enterprise.xwiki.org/xwiki/bin/view/Main/Documentation', '_blank'); return false;" href="http://www.xwiki.org/xwiki/bin/view/Main/Documentation">Documentation</a></div>
<br/>
  
      <div id="footer">
    <p>
                <a href="https://markebrooks.github.io/bin/view/Main/tou/">Terms of Use</a>
                |
                <a href="http://www.oracle.com/html/privacy.html">Privacy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/trademark/">Trademarks</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/copyrights/">Copyright Policy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site_guidelines/">Site Guidelines</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site-map/">Site Map</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/help/">Help</a>
                <br/>Your use of this web site or any of its content or software indicates your agreement to be bound by these Terms of Use.<br/>
                &copy; 2012, Oracle Corporation and/or its affiliates.<br/><img src="https://markebrooks.github.io:443/static/images/logo_oracle_footer.gif" alt="Oracle Logo"/>
            </p>
        </div>

  
</div>

</div></div></body>
</html>
