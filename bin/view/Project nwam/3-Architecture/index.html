<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                                    <title>Architecture (Project nwam.3-Architecture) - XWiki</title>
                <meta http-equiv="Content-Script-Type" content="text/javascript" />
                        <meta http-equiv="imagetoolbar" content="no"/>
                      <link rel="alternate" type="application/x-wiki" title="Edit" href="/bin/edit/Project+nwam/3%2DArchitecture" />
                    <link rel="canonical" href="/bin/view/Project+nwam/3%2DArchitecture" />
                            <meta name="document" content="Project nwam.3-Architecture"/>
    <meta name="wiki" content="xwiki"/>
    <meta name="space" content="Project nwam"/>
    <meta name="page" content="3-Architecture"/>
    <meta name="version" content="3.2"/>
    <meta name="restURL" content="/rest/wikis/xwiki/spaces/Project+nwam/pages/3-Architecture"/>
                <meta name="gwt:property" content="locale=en" />
                <meta name="revisit-after" content="7 days" />
<meta name="description" content="Architecture" />
<meta name="keywords" content="wiki " />
<meta name="distribution" content="GLOBAL" />
<meta name="rating" content="General" />
<meta name="author" content="Renee Sommerfeld" />
<meta http-equiv="reply-to" content="" />
<meta name="language" content="en" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Wiki Feed RSS" href="/bin/view/Main/WebRss?xpage=rdf" />
<link rel="alternate" type="application/rss+xml" title="Blog RSS Feed" href="/bin/view/Blog/GlobalBlogRss?xpage=plain" />
<link rel="shortcut icon" href="/resources/icons/oso/icon.png">
                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
<link href="https://markebrooks.github.io/static/css/stylesheet.css" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/style.css?colorTheme=ColorThemes.Oso" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/print.css" rel="stylesheet" type="text/css" media="print" />
        <!--[if IE]>
  <link href="/bin/skin/skins/colibri/ie%2Dall.css" rel="stylesheet" type="text/css" />
<![endif]-->
<!--[if IE 6]>
  <link href="/bin/skin/skins/colibri/ie%2D6.css" rel="stylesheet" type="text/css" />
<![endif]-->
<link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Settings?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Style?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/XWiki/SharePage?language=en'/>
<link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/modalPopup.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/jumpToPage.css?language=en'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/confirmationBox.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/notification.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.css'/>

    
    <link href="/bin/skin/resources/js/xwiki/suggest/ajaxSuggest.css" rel="stylesheet" type="text/css" />
<link href="/bin/skin/resources/js/xwiki/lightbox/lightbox.css" rel="stylesheet" type="text/css" />
<!--[if IE]>
  <link href="/bin/skin/resources/js/xwiki/lightbox/lightboxIE.css" rel="stylesheet" type="text/css" />
<![endif]-->












<script type="text/javascript" src="/resources/js/prototype/prototype.js"></script>
<script type="text/javascript" src="/bin/skin/resources/js/xwiki/xwiki.js"></script>
<script type="text/javascript">
// <![CDATA[
XWiki.webapppath = "";
XWiki.servletpath = "bin/";
XWiki.contextPath = "";
XWiki.mainWiki = "xwiki";
XWiki.currentWiki = "xwiki";
XWiki.currentSpace = "Project nwam";
XWiki.currentPage = "3-Architecture";
XWiki.editor = "";
XWiki.viewer = "";
XWiki.contextaction = "view";
XWiki.docisnew = false;
XWiki.docsyntax = "xwiki/2.0";
XWiki.blacklistedSpaces = [ "Import","Panels","Scheduler","Stats","XAppClasses","XAppSheets","XAppTemplates","XWiki","WatchCode","WatchSheets","XApp","WatchAdmin","Watch","ColorThemes","AnnotationCode" ];
XWiki.hasEdit = false;
XWiki.hasProgramming = false;
XWiki.hasBackupPackImportRights = false;
window.docviewurl = "/bin/view/Project+nwam/3%2DArchitecture";
window.docediturl = "/bin/edit/Project+nwam/3%2DArchitecture";
window.docsaveurl = "/bin/save/Project+nwam/3%2DArchitecture";
window.docgeturl = "/bin/get/Project+nwam/3%2DArchitecture";
// ]]>
</script>
<script type='text/javascript' src='/bin/skin/resources/js/scriptaculous/effects.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/modalPopup.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/jumpToPage.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmationBox.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmedAjaxRequest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/notification.js' defer='defer'></script>
<script type='text/javascript' src='/resources/uicomponents/widgets/list/xlist.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/suggest/ajaxSuggest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/scriptaculous/scriptaculous.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/accordion/accordion.js' defer='defer'></script>

<script type='text/javascript' src='/bin/jsx/XWiki/WebDAV?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Settings?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Script?language=en' defer='defer'></script>

<script type="text/javascript" src="/resources/js/xwiki/compatibility.js" defer="defer"></script>

  </head>
  <body id="body" class="wiki-xwiki space-Project_nwam viewbody hideright">
<div id="xwikimaincontainer">
<div id="xwikimaincontainerinner">

  <div id="menuview">
    <div id="mainmenu" class="layoutsubsection actionmenu">
<strong id="xwikimenutitle" class="hidden">General Actions:</strong>
<div class="rightmenu">
      <div id="tmLogin" class="tmLogin topmenuentry ">
   <a class="tme" href="https://auth.opensolaris.org/login.action?targetUrl=http%3A%2F%2Fmarkebrooks.github.io%2Fbin%2Fview%2FProject%2Bnwam%2F3%252DArchitecture"><strong>Log-in</strong></a>
  </div>
  </div>
<div class="leftmenu">
  <div id="tmWiki" class="tmWiki topmenuentry hasIcon">
   <a class="tme" href="/bin/view/Main/"><strong>Wiki</strong></a>
  </div>
  <div id="tmSpace" class="tmSpace topmenuentry dropdownmenuentry  hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Project+nwam/"><strong>Project nwam</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
                <span class="submenuitem "><a href="/bin/view/Main/SpaceIndex?space=Project+nwam" id="tmSpaceDocumentIndex" class="tmSpaceDocumentIndex">Document Index</a></span>
    </span></div>

<div id="tmSubSites" class="tmSubSites topmenuentry dropdownmenuentry dropdownnolink hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Subsites</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem hasIcon"><a href="https://cr.opensolaris.org/" id="tmCR" class="tmCR">Code Reviews</a></span>
<span class="submenuitem hasIcon"><a href="http://repo.opensolaris.org/" id="tmRepo" class="tmRepo">SCM Management</a></span>
<span class="submenuitem hasIcon"><a href="http://pkg.opensolaris.org/" id="tmPkg" class="tmPkg">Package Search</a></span>
<span class="submenuitem hasIcon"><a href="http://bugs.opensolaris.org/" id="tmBugs" class="tmBugs">Bugster</a></span>
<span class="submenuitem hasIcon"><a href="http://defect.opensolaris.org/" id="tmDefect" class="tmDefect">Bugzilla</a></span>
<span class="submenuitem hasIcon"><a href="http://test.opensolaris.org/" id="tmTest" class="tmTest">Test Machines</a></span>
<span class="submenuitem hasIcon"><a href="http://planet.opensolaris.org/" id="tmPlanet" class="tmPlanet">Planet</a></span>
<span class="submenuitem hasIcon"><a href="http://mail.opensolaris.org/" id="tmMail" class="tmMail">Mailing Lists</a></span>
<span class="submenuitem hasIcon"><a href="http://poll.opensolaris.org/" id="tmPoll" class="tmPoll">Elections &amp; Polls</a></span>
<span class="submenuitem hasIcon"><a href="http://arc.opensolaris.org/" id="tmArc" class="tmArc">ARC Case Logs</a></span>
<span class="submenuitem hasIcon"><a href="http://jucr.opensolaris.org/" id="tmJucr" class="tmJucr">Source Juicer</a></span>
<span class="submenuitem hasIcon"><a href="http://pkgfactory.opensolaris.org/" id="tmPkgfactory" class="tmPkgfactory">Package Factory</a></span>
<span class="submenuitem hasIcon"><a href="http://auth.opensolaris.org/" id="tmAuth" class="tmAuth">Auth</a></span>
</span></div>

</div>
</div>

  </div>
 <div id="header" class="layoutsection">
<div class="minwidthb"></div>

  <div id="header">
    <div id="header_banner">
	<table style="width: 100%;">
	    <tr>
		<td style="width: 1%;">
		    <a href="https://markebrooks.github.io/bin/view/Main/"><div id="logo"></div></a>  
		</td>
		<td id="logo-text" style="width: 1%;">
		    Solaris
		</td>         
		<td style="width: 98%;">
		    <table id="loading-indicator">
			<tr>
			    <td><img src="https://markebrooks.github.io:443/static/images/busy.gif"
				    alt="Loading" title="Loading"/></td>
			    <td>Loading...</td>
			</tr>
		    </table>
		</td>
		<td style="width: 1%;">
		    <table id="iconbar">
			<tr>
			<td><a id="collectives-icon" href="https://markebrooks.github.io/bin/view/Main/collectives">
			    Collectives</a></td>
			<td><a id="discussions-icon" href="https://markebrooks.github.io/bin/view/Main/discussions">
				Discussions</a></td>
			<td><a id="documentation-icon" href="https://markebrooks.github.io/bin/view/Main/documentation">
				Documentation</a></td>
			<td><a id="download-icon" href="https://markebrooks.github.io/bin/view/Main/downloads">
				Download</a></td>
			<td><a id="source-browser-icon" href="http://src.opensolaris.org/source">
				Source Browser</a></td>
			</tr>
		    </table>
		</td>
	    </tr>
	</table>
    </div>
    <div id="site-notice">
	<span>
	    <a href="https://markebrooks.github.io/bin/view/Main/">ATTENTION: This website and all services within the opensolaris.org domain will be unavailable after March 24, 2013.</a>	   
	</span>
    </div>
</div>
 </div> 
  <div id="globallinks">
    <form action="/bin/view/Main/Search">
      <div class="globalsearch">
        <label class="hidden" for="headerglobalsearchinput">Search</label><input class="globalsearchinput withTip" id="headerglobalsearchinput" type="text" name="text" value="search..." size="15"/><input class="button" type="image" value="Go" alt="Go" src="/resources/icons/xwiki/search.png"/>
      </div>
    </form>
  </div> <div style="float:left;">

                

   <div id="hierarchy">
                              <a href='/bin/view/Project+nwam/Foundation'>Foundation</a> <span class='separator'>&#187;</span> <span class='current'>Architecture</span>
                </div>

</div>
  <span class="glink" id="headerlanguages" style="float:right">
        <a href="/bin/view/Project+nwam/3%2DArchitecture?language=en" class="language-default language-current">en</a>
    </span>


<div class="contenthideright" id="contentcontainer">
<div id="contentcontainerinner">
<div class="leftsidecolumns">
  <div id="contentcolumn"> 
          <div class="main layoutsubsection">
      <div id="contentmenu" class="actionmenu">
    <strong id="xwikicontentmenutitle" class="hidden">Page Actions:</strong>
<div class="rightmenu">
</div>
<div class="leftmenu">
  <div id="tmExport" class="tmExport topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Export</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/export/Project+nwam/3%2DArchitecture?format=pdf&amp;language=en" id="tmExportPdf" class="tmExportPdf">Export as PDF</a></span>
  <span class="submenuitem "><a href="/bin/export/Project+nwam/3%2DArchitecture?format=rtf&amp;language=en" id="tmExportRtf" class="tmExportRtf">Export as RTF</a></span>
  <span class="submenuitem "><a href="/bin/export/Project+nwam/3%2DArchitecture?format=html&amp;language=en" id="tmExportHtml" class="tmExportHtml">Export as HTML</a></span>
    </span></div>

<div id="tmShow" class="tmShow topmenuentry dropdownmenuentry  " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Project+nwam/3%2DArchitecture?viewer=code&amp;language=en"><strong>View</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?viewer=comments&amp;language=en" id="tmViewComments" class="tmViewComments">Comments</a></span>
<span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?viewer=attachments&amp;language=en" id="tmViewAttachments" class="tmViewAttachments">Attachments</a></span>
<span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?viewer=history&amp;language=en" id="tmViewHistory" class="tmViewHistory">History</a></span>
<span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?viewer=information&amp;language=en" id="tmViewInformation" class="tmViewInformation">Information</a></span>
<span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?viewer=code&amp;language=en" id="tmViewSource" class="tmViewSource">View Source</a></span>
</span></div>

  <div id="tmMoreActions" class="tmMoreActions topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>More actions</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/view/Project+nwam/3%2DArchitecture?xpage=print&amp;language=en" id="tmPrintPreview" class="tmPrintPreview">Print preview</a></span>
          </span></div>
</div>

    </div>
    <div id="mainContentArea">
      








    
<div id="document-title"><h1>Architecture</h1></div>





              <div id="document-info">
    <div>
          </div>
    <div class="clearfloats"></div>
  </div>

<div id="xwikicontent">
<h1 id="HNetworkAuto-MagicArchitecture"><span>Network Auto-Magic Architecture</span></h1><p>&nbsp;Version 2.0, 2007-Feb-16</p><table><tr><td><span class="wikiexternallink"><a href="http://blogs.sun.com/jbeck">John Beck</a></span></td><td><span class="wikiexternallink"><a href="http://blogs.sun.com/carlson">Jim Carlson</a></span></td><td><span class="wikiexternallink"><a href="http://blogs.sun.com/okie">Renee Danson</a></span></td><td><span class="wikiexternallink"><a href="http://blogs.sun.com/mph">Michael Hunter</a></span></td></tr><tr><td><span class="wikiexternallink"><a href="http://blogs.sun.com/anay">Anay Panvalkar</a></span></td><td><span class="wikiexternallink"><a href="http://blogs.sun.com/kcpoon">Kacheong Poon</a></span></td><td>Garima Tripathi</td><td>Jan Xie</td></tr></table><p>&nbsp;There are six focus areas described below:</p><ol><li><span class="wikilink"><a href="#overview">Overview &amp; Component Interaction</a></span></li><li><span class="wikilink"><a href="#state-machine">State Machine</a></span></li><li><span class="wikilink"><a href="#event-handler">Event Handler</a></span></li><li><span class="wikilink"><a href="#profiles">Profiles</a></span></li><li><span class="wikilink"><a href="#network-service">Network Service Model</a></span></li><li><span class="wikilink"><a href="#dependencies">Dependencies with the rest of the System</a></span></li></ol><p>&nbsp;There are also two appendices:</p><ol><li><span class="wikicreatelink"><a href="/bin/create/Project+nwam/AB%2DGlossary?parent=Project+nwam.3%2DArchitecture">Glossary</a></span></li><li><span class="wikilink"><a href="#revision">Revision History</a></span></li></ol><hr/><h2 id="H0.Architecturevs.Design"><span>0. Architecture vs. Design</span></h2><p>&nbsp;This Architecture document was completed in April 2006, then used as the basis for the <span class="wikilink"><a href="/bin/view/Project+nwam/4%2DDesign">Design Document</a></span> which was completed in February 2007. Most of the high-level plans laid out here can be found in a similar lower-level form there, though as one might expect, some changes were made as part of the design process:</p><ul><li>Link-Layer Profiles (LLPs) were renamed to Network Configuration Profiles (NCPs), and their form changed somewhat. LLPs were per-link, whereas an NCP describes the entire system, and is made up of NCUs (U == Units), where each NCU describes a link or an IP interface.</li><li>Upper-Layer Profiles (ULPs) were renamed to Environments, but were otherwise little changed.</li><li>The State Machine / Event Handler is largely similar at a high level, but its functional details are rather different.</li><li>Our Network Service Model is largely similar, but again, some details have changed.</li></ul><p>&nbsp;Keep these changes in mind when reading this document.</p><h2 id="H1.Overview26ComponentInteraction"><span>1. Overview &amp; Component Interaction</span></h2><h3 id="H1.1Introduction"><span>1.1 Introduction</span></h3><p>&nbsp;Network Profiles, the primary component of the Network Auto-Magic project, are a way to simplify network configuration management. They work by allowing users to specify various properties which determine how things work in different circumstances. The properties include, but are not limited to:</p><ul><li>Link-Layer<ul><li>which network interface(s) to use</li><li>how to obtain IP address(es) for the interface(s) in use</li><li>whether or not a given link should be configured automatically</li><li>parallel interfaces to the same subnet (i.e., link aggregation and IP Multipathing)</li><li>the relative priority vs. other Link-Layer profiles</li></ul></li><li>Upper-Layer<ul><li>conditions under which this profile should be activated</li><li>which name service(s) to use</li><li>a host name (and any required variations thereof)</li><li>routing information</li><li>a set of IP filter rules</li><li><span class="box code">smf(5)</span> services</li><li>user-specified post-activation "hook"</li><li>the relative priority vs. other Upper-Layer profiles</li></ul></li></ul><p>&nbsp;Note that this dual-layer model was chosen to support "overlay" profiles, as discussed in our <span class="wikilink"><a href="/bin/view/Project+nwam/1%2DStoryBoards">Story Boards</a></span> and <span class="wikilink"><a href="/bin/view/Project+nwam/2%2DRequirements">Requirements</a></span>. Examples are provided below to illustrate this.</p><h3 id="H1.2Overview"><span>1.2 Overview</span></h3><p>&nbsp;Let us begin with an architectural overview. The primary components are:</p><ul><li>The profile repository. This is where the configuration program stores its data, which will also be read by the profile daemon.</li><li>The profile configuration program (a.k.a. the UI).<ul><li>Note that there will be both CLI and GUI versions of this program which will perform similar if not identical tasks.</li><li>In addition to using the repository, it also interacts with the profile daemon.</li><li>Tasks which users will use this program to perform include:<ul><li>creating, modifying and deleting profiles</li><li>activating one or more profiles</li><li>querying information about profiles</li></ul></li></ul></li><li>The profile daemon.<ul><li>This reads data from the repository.</li><li>It reacts to events as notified by the event handler.</li><li>It reacts to changes which users make via the configuration program.</li><li>The "state machine" described in <span class="wikilink"><a href="#state-machine">Section 2</a></span> is implemented in this daemon.</li><li>The daemon also interacts with the SMF network services.</li></ul></li><li>The event handler. This will likely have at least some kernel component, which will report information about events. A user-land component will gather this information and report it to the profile daemon. The user-land component may exist within the profile daemon itself.</li><li>The SMF network services. These are already part of Solaris, but we expect to modify them to some extent. The daemon will restart / refresh some of these services as needed.</li></ul><h3 id="H1.3Interactions"><span>1.3 Interactions</span></h3><p>&nbsp;How they interact is roughly as follows:</p><ul><li>At any given time, one or more Link-Layer profiles and exactly one Upper-Layer profile are "active".</li><li>At boot, the profile daemon consults the repository for the current active Link-Layer profile(s), proceeds until one or more IP addresses have been configured, checks the conditions of the Upper-Layer profiles, activates the highest priority one whose conditions match, and configures the network(s) accordingly. It is not yet clear whether:<ul><li>the active profile(s) is/are always persistent across reboots &nbsp;or</li><li>there may be support for temporarily active profiles which do not persist across reboots</li></ul></li><li>As events occur which may trigger a change in the network configuration, the event handler detects these and notifies the daemon accordingly. The daemon in turn consults the active profiles and may reconfigure the network(s) accordingly. Note that some of these events may indicate that the conditions have changed.</li><li>A change in conditions may trigger activating a different Link-Layer profile, which may in turn trigger a change in the Upper-Layer profile, which may in turn affect the network configuration. A change in conditions may also trigger activating a different Upper-Layer profile directly, without changing the underlying Link-Layer profile(s).</li><li>If a user modifies a profile, the configuration program updates the repository and notifies the daemon. If the current active profile is modified, then the daemon may reconfigure the network(s) accordingly.</li><li>Likewise, if a user activates a new profile (at either layer), then the configuration program updates the repository and notifies the daemon, which may then reconfigure the network(s) accordingly. Note that a user can always manually activate a profile (at either layer), regardless of conditions. Also note that users who desire total control will be able to specify conditions such that a different profile is never activated automatically.</li></ul><h3 id="H1.4Examples"><span>1.4 Examples</span></h3><ul><li>There will likely be an out-of-the box pair of profiles for "no network" which specify <span class="box code">files</span> for everything in <span class="box code"><span style="color: #666666; ">/</span>etc<span style="color: #666666; ">/</span>nsswitch.conf</span>, disables services which make no sense in a stand-alone environment, etc. Then at boot, the profile daemon would consult the conditions, note that there was no networking, then automatically select that pair of profiles.</li><li>A user at Sun might specify an Upper-Layer "SWAN" profile:<ul><li>conditions of the form "apply when a wired network with IP addresses in the range <span class="box code">129.144.0.0<span style="color: #666666; ">/</span>12</span> is detected"</li><li>a property to use name server X</li><li>a property to use <span class="box code">files<span style="color: #666666; ">/</span>dns<span style="color: #666666; ">/</span>nis</span> or <span class="box code">files<span style="color: #666666; ">/</span>nis</span> in <span class="box code"><span style="color: #666666; ">/</span>etc<span style="color: #666666; ">/</span>nsswitch.conf</span></li><li>a property to use NIS server Y</li><li>enable the SMF service <span class="box code">nis<span style="color: #666666; ">/</span>client</span></li><li>etc.</li></ul></li><li>A user might specify a Link-Layer profile which specifies "when I detect a WLAN on interface <span class="box code">bcmndis0</span> with ESSID X and BSSID Y, then use DHCP to get an IP address", then a related Upper-Layer profile whose conditions activate it contingent upon the above, then have a user "hook" to punchin, which in turn activates the punchin Link-Layer profile, which creates an IPsec tunnel, which ultimately leads to the Upper-Layer "SWAN" profile being activated.</li></ul><h2 id="H2.StateMachine"><span>2. State Machine</span></h2><p>&nbsp;One of our focus areas is "State Machine", which needs to cover both the abstract set of states for the profile daemon, and the set of possible transitions between those states. For now, we will focus on the transitions, with the idea that sufficiently specifying the transitions may suggest what the states themselves should be.</p><h3 id="H2.1InitialConditions"><span>2.1 Initial Conditions</span></h3><p>&nbsp;Since the new network/profile service will be replacing the existing network/physical and network/initial services (see <span class="wikilink"><a href="#profile-daemon">§5.2</a></span>), all of the start-up functionality of those two services will need to be accounted for. Though the state machine is designed to make bringing up an interface at boot time as much as possible like bringing up an interface on a running system, there will be a few initialization tasks required:</p><ul><li>Plumbing of loopback interfaces.</li><li>Walking the device tree to find existing network links. During normal operation, we would receive notification of the arrival of a new link; this notification kicks off the process of bringing up that link. At boot time, those event notifications will not occur, so we will have to find all existing links and "manually" kick off the bring-up of those links.</li></ul><h3 id="H2.2Event-DrivenTransitions"><span>2.2 Event-Driven Transitions</span></h3><p>&nbsp;A transition is made up of a series of reactions to a given event. These events come in pairs: some new thing is available, some old thing is no longer available. There are three event pairs which frame the "life-cycle" of a link:</p><ul><li>link is created: <span class="box code">link<span style="color: #666666; ">++</span></span><br/>&nbsp;A new link has been added to the system. Common possible reasons:<ul><li>a NIC is hot-plugged/DR inserted</li><li>a new tunnel has been configured<br/>&nbsp;The system reacts by:</li><li>plumbing the link (if necessary)</li><li>if the link is wireless, attempting to connect: scan for APs, consult list of "known" ESSIDs for matches (may also have to explicitly try connecting to user-specified ESSIDs that do not advertise). If an available ESSID matches one on our list, connect. If not (depending on policy), present available ESSIDs to user for selection.</li></ul></li><li>link comes up (<span class="box code">RUNNING</span> flag is set): <span class="box code">network<span style="color: #666666; ">++</span></span><br/>&nbsp;A link has become available for use. Common possible reasons:<ul><li>a LAN cable is plugged in</li><li>a wireless link has connected to an AP<br/>&nbsp;The system reacts by</li><li>Gathering information about the network: DHCP server availability, VLANs and/or subnets present</li><li>Consulting the Link-Layer profile to determine if this link should be configured. If no, note its availability, but leave link down and do nothing else; if yes, bring link up.</li></ul></li><li>link gets IP address: <span class="box code">ip<span style="color: #666666; ">++</span></span><br/>&nbsp;An IP address has been assigned to the link. Common possible reasons:<ul><li>DHCP lease has been obtained</li><li>IPv6 stateless address autoconf has completed</li><li>a link-local address has been configured</li><li>a static address has been assigned<br/>&nbsp;The system reacts by:</li><li>Consulting Upper-Layer profiles to decide what higher-layer configuration is required; this could include applying completely new configuration (for name services, ipfilter, etc.), restarting existing services, or possibly doing nothing.</li><li>Activating new configuration as needed.</li></ul></li><li>link loses IP address: <span class="box code">ip<span style="color: #666666; ">~--</span></span><br/>&nbsp;An IP address has been removed from the link. Common possible reasons:<ul><li>DHCP lease has expired</li><li>an autoconfigured address has timed out</li><li>a link-local address has been removed</li><li>a static address has been removed<br/>&nbsp;The system reacts by:</li><li>Consulting Upper-Layer profiles to decide what higher-layer configuration changes, if any, are required.</li><li>Activating new configuration as needed.</li></ul></li><li>link goes down: <span class="box code">network<span style="color: #666666; ">~--</span></span><br/>&nbsp;A link is no longer available for use. Common possible reasons:<ul><li>a LAN cable is unplugged</li><li>a connection with an AP is lost<br/>&nbsp;The system reacts by:</li><li>If link was not in use (<span class="box code">UP</span> flag is off), just deleting its info from our list of available links.</li><li>Consulting Link-Layer profile to determine if other <span class="box code">RUNNING</span> links should be brought up, and then following the rest of the <span class="box code">network<span style="color: #666666; ">++</span></span> process for those links as needed.</li></ul></li><li>link is removed: <span class="box code">link<span style="color: #666666; ">~--</span></span><br/>&nbsp;A link has been removed from the system. Common possible reasons:<ul><li>a NIC is unplugged/DR removed</li><li>an existing tunnel has been torn down<br/>&nbsp;The system reacts by:</li><li>If link was up (<span class="box code">RUNNING</span>), taking it down (this will cause "link goes down" steps to take place).</li><li>Unplumbing the link.</li></ul></li></ul><p>&nbsp;Note that booting and resuming from suspend are really just special cases where one or more of the ++ cases appear to happen at once, as the daemon will attempt to "de-queue" all pending events whenever it starts or resumes (i.e., it will attempt to examine all pending events before handling any of them). This will be part of the daemon's "damping" to maximize stability (more on this below).</p><p>&nbsp;Likewise, shutdown and suspend are really just special cases where the -- events happen on all links at the same time.</p><p>&nbsp;Generally, the normal sequence for an interface being added to the system would be <span class="box code">link<span style="color: #666666; ">++</span></span>, followed by <span class="box code">network<span style="color: #666666; ">++</span></span>, followed by one or more <span class="box code">ip<span style="color: #666666; ">++</span></span>. When an interface is removed, there would be a <span class="box code">network<span style="color: #666666; ">~--</span></span> followed by a <span class="box code">link<span style="color: #666666; ">~--</span></span> event; it is quite likely that there would not be explicit <span class="box code">ip<span style="color: #666666; ">~--</span></span> events initiating the process.</p><p>&nbsp;An interesting case would be when a <span class="box code">network<span style="color: #666666; ">~--</span></span> is <strong>not</strong> followed by a <span class="box code">link<span style="color: #666666; ">~--</span></span>. It could be a transient failure, or it could be a move from one network to another (in which case a <span class="box code">network<span style="color: #666666; ">++</span></span> would follow at some point), or it could simply be that that link is "gone," whether by admin choice or because of a longer-term failure. Since the network is gone, we can do nothing with respect to it per se. But we can start a timer, then once that timer "pops" (per the profile), we might either reset all connections (if the number of networks is now 0) or try to get all services using the "dead" network to transition to one of the other networks (if the number of networks is now ≥ 1). Also note that when the timer pops, we set the state so that a subsequent "<span class="box code">network<span style="color: #666666; ">++</span></span>" event follows the "there was no previous network" path rather than the "there was a previous network" path. But note that if we get a "<span class="box code">network<span style="color: #666666; ">++</span></span>" event before the timer pops, and determine that the "new network" is the same as the "old network", then we will attempt to "damp" the events out and act as if neither event had occurred.</p><h3 id="H2.3User-DrivenTransitions"><span>2.3 User-Driven Transitions</span></h3><p>&nbsp;There are also user-driven transitions: whenever a user modifies the active profile (of either layer), or activates a different profile (at either layer), then the new active profile(s) may result in a transition. Depending on the change(s), there may be nothing to do, or there may be minor reconfigurations to make, or it may be that the user did the equivalent of pressing a giant red "reset" button.</p><p>&nbsp;A note on "punchin" (the IPsec-based VPN which many of us use to access the SWAN remotely): although tunnels coming and going should be detected by the event handler and thus be handled by the profile daemon as an event-driven transition, it would probably be better for us to work with the punchin team to integrate our stuff together so that punching in and out would involve using our interfaces, and thus be user-driven transitions, with the profile daemon doing the heavy lifting instead of the punchin script.</p><h3 id="H2.4Implications"><span>2.4 Implications</span></h3><p>&nbsp;It is not clear if these transitions suggest any sort of traditional simple state model. E.g., the Zones model whose primary states are Configured, Installed and Running seems impossibly simplistic for what we are trying to achieve. Instead, it seems that we ought to come up with an abstract representation of the network configuration, and that abstraction will become the "state". Then whenever the users modifies the active profile or activates a different profile, the network configuration will be changed accordingly, as will our abstract "state". Likewise, whenever an event forces a reconfiguration, the new configuration will be reflected in our abstract "state".</p><h2 id="H3.EventHandler"><span>3. Event Handler</span></h2><p>&nbsp;The event handler must interface with the kernel, but will probably mostly run in user-land.</p><p>&nbsp;The event handler will monitor several sources of information: hald, routing socket, sysevents (and, longer term, link FMRIs); current thinking is that this monitoring will take place within the "profile daemon" entity.</p><p>&nbsp;In addition to the monitoring component, work may be required in the kernel to ensure that information is reported in a consistent manner; hald back-end support may also need to be added (this will benefit other projects as well as this one).</p><h3 id="H3.1Information26Events"><span>3.1 Information &amp; Events</span></h3><p>&nbsp;What information needs to be delivered? What events are we concerned with?</p><ul><li>Link creation/removal (signals that a link exists)<ul><li>Physical hardware: card removal / insertion (note that one card may lead to multiple links being created -- e.g., qfe).<ul><li>This should cover both DR and PCMCIA/cardbus hot-plug</li></ul></li><li>Virtual links: creation / removal of:<ul><li>IP Tunnels</li><li>Link aggregations</li><li>VLANs</li><li>Future: Crossbow VNICs?</li></ul></li></ul></li><li>Link up/down (signals the link is or is not available for use)<ul><li>On wired networks: is the cable plugged in?</li><li>On wireless networks: are we connected?</li></ul></li><li>Link health (signals how healthy the link is)<ul><li>On wireless networks: what is the signal strength?</li><li>Future: error rate heuristics; failed links in an aggregation.</li></ul></li><li>Link availability (which networks are available)<ul><li>On wireless: available networks/APs</li><li>On wired/wireless: IP address assigned</li></ul></li></ul><h3 id="H3.2ObtainingInformation"><span>3.2 Obtaining Information</span></h3><ul><li>link creation/removal<br/>&nbsp;This covers both physical links (e.g., [un]plugging a NIC) and virtual links (e.g. a tunnel, or an aggregation).<br/>&nbsp;We can subscribe to event notifications using the sysevent user subscription API; <span class="box code">EC_DEV_ADD</span> and <span class="box code">EC_DEV_REMOVE</span> classes for subclass <span class="box code">ESC_NETWORK</span> should do the trick.<br/>&nbsp;One possible complication: the sysevents report device names, based on the device driver name. <span class="wikiexternallink"><a href="https://markebrooks.github.io/bin/download/Community+Group+networking/WebHome/uv-design.pdf">Clearview vanity names</a></span> will introduce the notion of link names; we will need to be able to map appropriately, as we will want to allow users to talk about link names, not device names.<br/>&nbsp;It has been suggested that we really should only care about the creation of new <strong>links</strong>, and not devices. Clearview will add sysevents that cover link creation/removal (refer to <span class="wikiexternallink"><a href="https://markebrooks.github.io/bin/download/Community+Group+networking/WebHome/uv-design.pdf">Clearview UV design doc</a></span>, §6.2.7).</li><li>link up/down<br/><span class="box code">DL_NOTE_LINK_UP<span style="color: #666666; ">/</span>DOWN</span> translates to toggling of <span class="box code">IFF_RUNNING</span> which can be monitored on a routing socket.<br/>&nbsp;Support for <span class="box code">DL_NOTE_LINK_UP<span style="color: #666666; ">/</span>DOWN</span> is not consistent across all drivers. We should plan to make sure that support is in place for the most commonly used of Sun's drivers, either by doing the work ourselves or by working with the driver teams to do it, and we will still need to work with drivers that do not support <span class="box code">DL_NOTE_LINK_UP<span style="color: #666666; ">/</span>DOWN</span>.<br/>&nbsp;For wireless drivers, the IFF_RUNNING flag should represent whether or not there is a connection, either to an AP or an ad-hoc network. However, it does not appear that this is part of the existing interface to which WiFi drivers are being written/ported. We should look into adding this to the interface; but if that is not possible, then the <span class="box code">connected</span> state of a wireless driver should be queryable.</li><li>link health/link availability: wireless-specific information<br/>&nbsp;An earlier PSARC case (whose official title was <em>WiFi PCMCIA Driver Productization</em>, although it is colloquially known as <em>wificonfig</em>) defines a set of (unstable) wireless driver ioctls that make up the interface with wificonfig. Those interfaces are likely to change, though, as work in that area is going on right now. The new library will be available for us, and will allow us to query signal strength and request a scan for available networks.<br/>&nbsp;This information will not be reported as an asynchronous event; the event handler will need to query for this information. Preferred behavior is always to query when wireless interfaces are present, whether or not the interface is currently attached; if the scans create performance problems, the rate may be reduced, or the scans could be eliminated altogether.<br/>&nbsp;There may also be roaming features (discussed in <span class="wikilink"><a href="#roaming">§3.5</a></span> below) which make querying for available APs necessary even when connected.</li><li>link availability: IP address<br/>&nbsp;This is easy enough to get from a routing socket.</li></ul><h3 id="H3.3DeliveringInformation"><span>3.3 Delivering Information</span></h3><p>&nbsp;How will the information be delivered to consumers?</p><p>&nbsp;This is probably a more detailed design question, as the current thinking is that the event handler will be part of the profile daemon entity, our primary consumer.</p><h3 id="H3.4StoringInformation"><span>3.4 Storing Information</span></h3><p>&nbsp;Will the information be stored anywhere? If so, when should snapshots be taken? How many should be stored?</p><p>&nbsp;It is not clear that we need a repository at this point.</p><h3 id="H3.5Roaming"><span>3.5 Roaming</span></h3><p>&nbsp;Roaming can be broken up into two different layers: L2 and L3. L2 is the case where there are multiple APs, on the same LAN; the IP address does not change when migrating from one AP to another. This is something that hardware implementations (either in the hardware itself or in the driver) seem to take care of (based on casual Googling and toting OS X and Solaris laptops around the building).</p><p>&nbsp;L3 is harder. MobileIP tries to make it transparent; that is something that we might consider doing at some point under the NWAM umbrella, but will not be part of phase 1 of the project. It has also been suggested that there are some cases where simply making the switch, without worrying about keeping existing connections alive, might be preferred behavior. This sort of gets back to the question of intent we have discussed elsewhere: is the user just surfing and checking mail, so switching to a cheaper network when it pops up is painless; or does s/he have long-term ssh sessions that must stay up at all costs?</p><h3 id="H3.6Howtorespondtoexternalconfigurationchanges3F"><span>3.6 How to respond to external configuration changes?</span></h3><ul><li>Types of changes<br/>&nbsp;There are two types of changes which an administrator can make: changes which affect one or more of the Conditions, and changes which affect one or more of the Profile Attributes. E.g., taking an interface down via ifconfig would be an example of the former, while using svcadm to disable the ntp/client service would be an example of the latter.</li><li>Responding to these changes<br/>&nbsp;Changes in the conditions need to be propagated: that is part of what Network Auto-Magic is all about. So e.g., using ifconfig to take an interface down would have the same effect as if a LAN cable had been unplugged from the NIC corresponding to that interface, thus causing a change in conditions, so the profile daemon would have to reevaluate them, and possibly activate a different profile as a result.<br/>&nbsp;Changes in state/configuration prescribed by profile attributes result in inconsistencies with the profile. There are two problems with this: (1) the inconsistency might confuse users in the future, and (2) the user might have made a (very expensive) mistake. Fixing (1) seems to be outside the scope of NWAM. NWAM seems to make fixing (2) possible (e.g., by undoing the user's action), though it is not clear that it is worth the additional complexity.<br/>&nbsp;As to whether a given change affects a Condition, a Profile Attribute, neither, or both, we will need to come up with a list of things which we will need to monitor (e.g., network service states, network interface states, etc.), and classify each, as part of the low-level design of this project. But for now we suspect that there will be few if any things in both lists, and if there are any, they can be handled as special cases.</li></ul><h2 id="H4.Profiles"><span>4. Profiles</span></h2><p>&nbsp;Specification of network configuration is divided into two types of profiles. The first is applied at the <span class="box code">link<span style="color: #666666; ">++</span></span> and <span class="box code">network<span style="color: #666666; ">++</span></span> stages of a link's life. It is made up of the conditions and attributes required to determine which links should be used and how those links should be configured. This will be referred to as the Link-Layer Profile.</p><p>&nbsp;The second is applied at the <span class="box code">ip<span style="color: #666666; ">++</span></span> stage of a link's life, though not every <span class="box code">ip<span style="color: #666666; ">++</span></span> or <span class="box code">ip<span style="color: #666666; ">~--</span></span> transition will result in a configuration change. It is made up of the conditions and attributes required to configure higher-layer aspects of a link: things like name services, firewall rules, or proxies. This part of the configuration is not dependent on <strong>how</strong> IP connectivity is achieved, just that it exists on some set of links. This will be referred to as the Upper-Layer Profile.</p><h3 id="H4.1Link-LayerProfile"><span>4.1 Link-Layer Profile</span></h3><p>&nbsp;Links are configured individually, as <span class="box code">link<span style="color: #666666; ">++</span></span> and <span class="box code">network<span style="color: #666666; ">++</span></span> transitions occur (see <span class="wikilink"><a href="#event-driven">§2.2</a></span>). A Link-Layer profile contains attributes used to configure a link. A rule-set will determine link/profile mappings; some of the types of mappings that should be allowed are:</p><ul><li>profile foo applies to all links</li><li>profile foo applies to all wired links, profile bar to all wireless links</li><li>profile foo applies to bge2, profile bar applies to all other links</li><li>profile foo applies to all wireless links; prefer pcwl0 over bcmndis0</li></ul><p>&nbsp;The following attributes make up a Link-Layer profile:</p><ul><li>how to obtain IP address(es) for the link(s) in use<ul><li>Whether address(es) should come from DHCP, be statically assigned, be link local, be auto-configured, etc. Might be useful to be able to specify that an appropriate addr should be chosen from a user-specified pool of addresses (which would be available to multiple links).</li><li>Multiple sources might be a possibility (nsswitch-like mechanism?)</li><li>If static, should be able to specify multiple addresses.</li></ul></li><li>whether or not a given link should be configured automatically<ul><li>Should this link be configured automatically, without user intervention.</li><li>Default is true for wired interfaces, false for wireless interfaces.</li></ul></li><li>ESSIDs that can be joined automatically<ul><li>Should be generated automatically as knowledge of different ESSIDs is acquired; user may also manually add to it.</li><li>Will store authentication information for the ESSID, such as security model and keys.</li><li>Will have default ranking rules, but the user should be able to modify these.</li></ul></li><li>relative priority vs. other Link-Layer profiles<ul><li>Stored as an integer, but might be presented to the user differently.</li><li>Used to decide which Link-Layer profile should be used; the system will apply the profile with the highest priority among those that have the necessary links available.</li><li>May have multiple profiles at the same priority level; in this case, as many as possible should be used (unless another profile with higher priority is also available).</li><li>Priority might be part of the rule-set used to select a profile, rather than part of the profile itself.</li></ul></li><li>parallel interfaces to the same subnet (i.e., link aggregation and IP Multipathing)<ul><li>This is an advanced feature which may be added down the road.</li></ul></li></ul><h3 id="H4.2Upper-LayerProfile"><span>4.2 Upper-Layer Profile</span></h3><p>&nbsp;A set of these properties and resources is applied to the system once IP services are available (i.e. IP addresses are configured on running interfaces). Unlike Link-Layer profiles, only one Upper-Layer profile may be active at any time. Upper-Layer profile selection criteria include:</p><ul><li>specific link(s) that is(are) up</li><li>wireless network/ESSID to which we have connected</li><li>IP address range/subnet</li><li>domain look-up (perhaps from DHCP server, since we might not have configured name services yet)</li><li>user input (user explicitly chooses a profile; if it cannot be done with the currently available links, complain)</li></ul><p>&nbsp;The following attributes make up an Upper-Layer profile:</p><ul><li>conditions under which this profile should be activated</li><li>relative priority vs. other Upper-Layer profiles</li><li>which name service(s) to use</li><li>a host name (and any required variations thereof)</li><li>routing information</li><li>a set of IP Filter rules</li><li>smf(5) services</li><li>HTTP proxies</li><li>"hook" mechanism: user-specified action taken when profile is activated</li></ul><h3 id="H4.3UserIntent"><span>4.3 User Intent</span></h3><p>&nbsp;An issue which has come up repeatedly during design discussions has been that of "user intent". For example, laptops are used very differently than servers and test servers may be used very differently than production servers. So a knob to indicate this intent seems like a good idea. The form this knob may take needs to be worked out.</p><h2 id="H5.NetworkServiceModel"><span>5. Network Service Model</span></h2><p>&nbsp;This section might also be called "how we interact with SMF".</p><h3 id="H5.1Milestones"><span>5.1 Milestones</span></h3><p>&nbsp;There will be two system network states, each of which is represented by an SMF milestone service:</p><ul><li>milestone/network: basic network APIs are functional (i.e., applications can make <span class="box code">socket()</span> calls) and any configured packet filtering is enabled on the available network interfaces.</li><li>milestone/name-services: one or more name services (e.g., DNS, NIS, NIS+, LDAP) are selected, each selected service is configured properly.</li></ul><p>&nbsp;milestone/name-services should depend on milestone/network.</p><p>&nbsp;The profile daemon (profiled) will manipulate these two milestones. When network events happen or the active profile changes (via any of the mechanisms described in <span class="wikilink"><a href="#event-driven">§2.2</a></span> and <span class="wikilink"><a href="#user-driven">§2.3</a></span>), profiled will decide the state to which each of these milestones should be set. When conditions change sufficiently (again, see <span class="wikilink"><a href="#event-driven">§2.2</a></span> and <span class="wikilink"><a href="#user-driven">§2.3</a></span>), milestone/network will likely need to be refreshed. Network services should either depend on milestone/network or milestone/name-services. We need to identify what the complete lists are, and update their dependencies accordingly.</p><h3 id="H5.2ProfileDaemon"><span>5.2 Profile Daemon</span></h3><p>&nbsp;A new SMF service, network/profile, will start profiled. It should only depend on network/pfil[1] and should be started very early. The current network configuration services, network/physical, network/initial and network/service should be removed and most of their tasks[2] taken over by the profile daemon.</p><p>&nbsp;Based on the information from the active profile, the profile daemon may also enable or disable some name services. For example, when the system migrates from a profile which specifies using DNS to a profile which specifies using NIS, profiled should disable dns/client and enable nis/client.</p><table><tr><td>[1]</td><td>network/pfil is an existing SMF network service. It autopushes pfil onto the filtering interface and restricts network traffic during startup. It does not depend on anything.</td></tr><tr><td>[2]</td><td>Some of the pieces, such as ipqos and IPsec, need to be split out into separate services. More details of this will be worked out as we migrate from architecture to design. The IPsec part is covered by <span class="wikiexternallink"><a href="http://bugs.opensolaris.org/bugdatabase/view_bug.do?bug_id=6185380">Sun bug 6185380</a></span>; <span class="wikiexternallink"><a href="http://bugs.opensolaris.org/bugdatabase/view_bug.do?bug_id=5105194">Sun bug 5105194</a></span> covers the rest.</td></tr></table><h3 id="H5.3MoreonNameServices"><span>5.3 More on Name Services</span></h3><p>&nbsp;The <span class="wikiexternallink"><a href="https://markebrooks.github.io/bin/view/Project+sparks/">Sparks project</a></span> has just gone live. We are in contact with that project team and in fact several of their members are subscribed to our nwam-discuss list, so as their work progresses, our plans will evolve to match it, and this section will be updated accordingly.</p><h3 id="H5.4Diagnosability"><span>5.4 Diagnosability</span></h3><p>&nbsp;Although improving diagnosability of network problems is not one of our requirements, everyone agrees that we should at least not make this problem worse. Our plans are not yet more defined than using the <span class="box code">LOG_DAEMON</span> facility and syslogging various messages at various severities so that curious users can understand what profiled does and why, but these plans should become more refined as we progress from architecture to design.</p><h3 id="H5.5ToRestartornottoRestart3F"><span>5.5 To Restart or not to Restart?</span></h3><p>&nbsp;A great deal of discussion has occurred regarding whether or not profiled should be a delegated network restarter [see smf(5), smf_restarter(5), smf_method(5), svc.startd(1M) and inetd(1M) for what this means]. At present, our intention is that profiled will <strong>not</strong> be such a restarter, as we do not see sufficient upside to match the complexity downside. But this may change as we move into design and prototyping.</p><h2 id="H6.DependencieswiththerestoftheSystem"><span>6.Dependencies with the rest of the System</span></h2><p>&nbsp;In order to tie the NWAM architecture into the overall system we need to specify what other subsystems it interfaces with and what requirements it drives on those systems.</p><h3 id="H6.1ServiceDiscovery"><span>6.1 Service Discovery</span></h3><p>&nbsp;Bonjour is a <span class="wikiexternallink"><a href="http://en.wikipedia.org/wiki/Zeroconf">zero configuration</a></span> technology developed and made popular by <span class="wikiexternallink"><a href="http://www.apple.com/macosx/features/bonjour/">Apple</a></span>. Gnome has support via <span class="wikiexternallink"><a href="http://www.avahi.org/">Avahi</a></span>. Overall this set of features is called <span class="wikilink"><a href="/bin/view/Project+nwam/service%2Ddiscovery">Service Discovery</a></span>. Its main intersection with profiles will be in the assignment of a hostname. The system will keep a set of aliases including a user provided hostname, a service discovery provided hostname, and a DHCP provided hostname allowing any to refer to the current node. NWAM will have to be able to detect when a name changes in order to be able to allow the user to propagate that to interested applications.</p><h3 id="H6.2Virtualization"><span>6.2 Virtualization</span></h3><p>&nbsp;Another aspect of configuration is how we deal with the plethora of virtualization technologies being developed. Virtualizations technologies include:</p><ul><li><span class="wikilink"><a href="/bin/view/Community+Group+zones/">Zones</a></span> are a basic virtualization technology that can be used independently or together with several of the other virtualization technologies.</li><li><span class="wikilink"><a href="/bin/view/Community+Group+brandz/">BrandZ</a></span> is an attribute of a zone so should be dealt with in the same manner as a zone.</li><li><span class="wikilink"><a href="/bin/view/Community+Group+xen/">Xen</a></span> creates enough separation between the host OS and the guest OS that it is unlikely we will interact with it much.</li><li><span class="wikilink"><a href="/bin/view/Community+Group+networking/">Crossbow</a></span><ol><li>VNICs: One feature that Crossbow will introduce is virtual NICs. This is an independent construct from stack instances. As long as they act like real NICs our design should work fine with them. The current administrative model of VNICs is in flux. When that settles down the subset of parameters which can be managed by NWAM will need to determined.</li><li>Stack Instances: Those VNICs can be bound to stack instances which can be associated with a zone. The idea is that exclusive bindings between zone and stack instances would create VNICs only in the zone. In that case the events have to be generated in the zone. We would need something in the zone to consume those events.</li></ol></li></ul><p>Currently the administrative model of zones is restrictive. Anything that involves configuration has to be done in the global zone. Additionally neither sysevents nor routing sockets (information sources) work in zones. That drives NWAM to be mostly in the global zone. Future plans might change zones to be able to administer resources given to them and to receive various events. In this case a profile daemon could exist in a zone providing independent management of its configuration.</p><h3 id="H6.3HAL"><span>6.3 HAL</span></h3><p><span class="wikiexternallink"><a href="http://www.freedesktop.org/wiki/Software_2fhal">HAL</a></span> is a schema and API for accessing information about the system. Initially it was envisioned as the layer Gnome needed to abstract the hardware. Applications of HAL are as diverse as the battery status meter and a <span class="wikiexternallink"><a href="http://www.gnome.org/projects/NetworkManager/">network manager</a></span>.</p><p>&nbsp;There is an effort (to be documented soon on the OpenSolaris web site) to get HAL into Solaris for use in volume management. HAL uses DBUS as its IPC mechanism. There are system specific back-ends and an upper layer which also just work.</p><p>&nbsp;HAL's <span class="wikiexternallink"><a href="http://webcvs.freedesktop.org/*checkout*/hal/hal/doc/spec/hal-spec.html">&nbsp;schema</a></span> provides support for link-layer devices. While we could add entries to the HAL schema in order to meet our needs, it is not clear that this would be efficient. We have decided not to rely on HAL as a source of information for NWAM.</p><h3 id="H6.4VisualPanels"><span>6.4 Visual Panels</span></h3><p><span class="wikilink"><a href="/bin/view/Project+vpanels/">Visual Panels</a></span> are a new project aimed at creating a better way to configure Solaris. The current demo includes a hook for Network Profiles. Our UI design will have to reflect the need to integrate with Visual Panels.</p><h3 id="H6.5PredictiveSelfHealing"><span>6.5 Predictive Self Healing</span></h3><p>&nbsp;Sun's Predictive Self-Healing features in Solaris are represented by <span class="wikilink"><a href="/bin/view/Community+Group+fm/">Fault Management</a></span> (FMA) and the <span class="wikilink"><a href="/bin/view/Community+Group+smf/">Service Manager</a></span> (SMF; <span class="wikilink"><a href="#network-service">section 5</a></span> of this document). These form an important part of Solaris' diagnosability story.</p><p>&nbsp;With SMF we investigated various levels of interface. These broke down to a choice between a fairly coarse / high-level manipulation of SMF objects or a finer / lower-level modeling of the system in SMF objects and subsequently using SMF to drive many of the state changes. With a more detailed model of the system in SMF we could use the diagnosability features of SMF (<span class="box code">svcs <span style="color: #666666; ">-</span>x</span>) to help users determine what is wrong with their system. Initially we thought modeling an interface per SMF instance would not be possible so we discussed using properties to store interface information. But upon discussion with the SMF team we discovered that such modeling had been considered when SMF was designed.</p><p>&nbsp;The next question was to see what value we could give to our users by implementing a finer SMF model. There were 3 classes of errors we discussed:</p><ul><li>service configuration errors (e.g. <span class="box code"><span style="color: #666666; ">/</span>etc<span style="color: #666666; ">/</span>ssh<span style="color: #666666; ">/</span>sshd_config</span>)</li><li>local net errors (e.g. ethernet cable unplugged)</li><li>errors on the network (DNS server misbehaving)</li></ul><p>&nbsp;The first case is already covered by much of what we have. Most services are managed by SMF. Even in our coarser model those services would still be managed by SMF.</p><p>&nbsp;The second class could be modeled in SMF. We could not come up with any examples where modeling in SMF helped diagnose problems any better than the current mechanisms.</p><p>&nbsp;The third class is the interesting one. There are many tough problems in this DNS example alone, from trying to figure out any of the problems which might have come from disruptions in network connectivity outside of the user's network (e.g. making the server unreachable), to remote DNS server problems (e.g. making response slow or non-existent for some subset of the namespace). Due to the way that most modern networking is designed and specifically how IP works, these kinds of problems do not trace back to an interface in any useful manner. From having a single interface onto a backbone of many paths to having redundant and/or independent interfaces onto the network, the interface that sends out the request is not related to most of the problems those packets can encounter. Instead the model would really need to contain objects which are external to the box (routers, servers, services). This problem does not seem to be tractable.</p><p>&nbsp;Given that the current model suffices for NWAM and we could not find interesting diagnosibility problems that a finer model would help the user solve, we decided to use the coarser model with SMF.</p><p>&nbsp;FMA models system components so that faults can be centrally managed. The control mechanism for FMA is provided by fmd(1M). One way to do this for the networking subsystem would be putting the MAC layers in a hardware class (<span class="box code">hc:<span style="color: #666666; ">/</span>...</span>) and having administrator named data-link objects to which they map. Tools would be provided to set up relationships and control these devices. <span class="wikiexternallink"><a href="https://markebrooks.github.io/bin/view/Project+clearview/">Clearview</a></span> provides much of this functionality other than the FMA objects.</p><p>&nbsp;In attempting to find uses for MAC level FMA objects we run into the same issues we did with SMF. The interesting problem are <strong>not</strong> caused by local objects (e.g. interfaces) but instead by things on the network. At this time we do not think building MAC level FMA functionality would add to this project.</p><h3 id="H6.6Install"><span>6.6 Install</span></h3><p>&nbsp;NWAM will interact with install by providing tools that install can use to modify individual system parameters (e.g. hostname) and to configure basic networking. A document discussing the install strategy is available <span class="wikilink"><a href="/bin/view/Project+nwam/#2006%2D03%2D23_solaris_installation_strategy_review">here</a></span>.</p><hr/><h2 id="HAppendixA:Glossary"><span>Appendix A: <span class="wikicreatelink"><a href="/bin/create/Project+nwam/AB%2DGlossary?parent=Project+nwam.3%2DArchitecture">Glossary</a></span></span></h2><h2 id="HAppendixB:RevisionHistory"><span>Appendix B: Revision History</span></h2><table><tr><th scope="col">Revision</th><th scope="col">Date</th><th scope="col">Changes</th></tr><tr><td>0.1</td><td>2006-Feb-13</td><td>initial draft</td></tr><tr><td>0.1.1</td><td>2006-Feb-15</td><td>minor clarifications</td></tr><tr><td>0.1.2</td><td>2006-Feb-15</td><td>minor clarifications</td></tr><tr><td>0.2</td><td>2006-Feb-17</td><td>Section 1 organized &amp; clarified, <em>conditions</em> introduced</td></tr><tr><td>0.2.1</td><td>2006-Feb-23</td><td>Section 2 organized &amp; clarified, other minor clarifications</td></tr><tr><td>0.2.2</td><td>2006-Feb-24</td><td>Section 3 organized &amp; clarified</td></tr><tr><td>0.2.3</td><td>2006-Feb-27</td><td>Appendix A added, ¶ added to §3.1, §3.5 moved to §6.5</td></tr><tr><td>0.2.4</td><td>2006-Mar-06</td><td>§3.1 and §3.2 updated, § 3.5 added</td></tr><tr><td>0.2.5</td><td>2006-Mar-09</td><td>§6.1 and §6.2 updated</td></tr><tr><td>0.3</td><td>2006-Mar-20</td><td>Section 5 organized &amp; clarified</td></tr><tr><td>0.3.1</td><td>2006-Mar-28</td><td>Modified §3.2 &amp; §3.5; added §3.6</td></tr><tr><td>0.3.2</td><td>2006-Mar-28</td><td>Added Section 7</td></tr><tr><td>0.3.3</td><td>2006-Mar-28</td><td>Modified §6.1</td></tr><tr><td>0.3.4</td><td>2006-Mar-28</td><td>Modified §6.2</td></tr><tr><td>0.3.5</td><td>2006-Mar-29</td><td>Modified §6.3</td></tr><tr><td>0.3.6</td><td>2006-Mar-29</td><td>Added §6.6</td></tr><tr><td>0.3.7</td><td>2006-Mar-29</td><td>Modified §6.4</td></tr><tr><td>0.4</td><td>2006-Mar-29</td><td>Significantly modified §2.2</td></tr><tr><td>0.4.1</td><td>2006-Mar-30</td><td>Modified §6.2, §6.6 and Section 7</td></tr><tr><td>0.4.2</td><td>2006-Mar-31</td><td>Glossary moved from Section 7 to Appendix A<br/>&nbsp;Revision History moved from Appendix A to B</td></tr><tr><td>0.5</td><td>2006-Mar-31</td><td>Significantly modified §1.1, §1.3, §1.4, §2.1, §2.3 &amp; §4<br/>&nbsp;Link-Layer and Upper-Layer profiles introduced</td></tr><tr><td>0.5.1</td><td>2006-Apr-03</td><td>Significantly modified §6.5<br/>&nbsp;Changed § name from FMA to Predictive Self-Healing</td></tr><tr><td>1.0</td><td>2006-Apr-03</td><td>Architecture complete</td></tr><tr><td>1.0.1</td><td>2006-Apr-04</td><td>Revised §5.3 per Sparks project going live</td></tr><tr><td>1.0.2</td><td>2006-Apr-05</td><td>Revised §6.5 Dave B's comments on Predictive Self Healing</td></tr><tr><td>1.0.3</td><td>2006-Apr-05</td><td>Added introduction to §4.1</td></tr><tr><td>1.0.4</td><td>2006-Apr-18</td><td>Changed Section 4 name from <em>Configuration</em> to <em>Profiles</em></td></tr><tr><td>1.0.5</td><td>2006-Jul-27</td><td>Added Renee's blog URL to team list</td></tr><tr><td>1.0.6</td><td>2006-Aug-30</td><td>Moved Glossary to its own page</td></tr><tr><td>2.0</td><td>2007-Feb-16</td><td>Section 0 added to point out differences between Architecture &amp; Design</td></tr></table>
</div>


    <div class="clearfloats"></div>
  </div>      <div id="xdocFooter">
  
                

       <div class="doc-tags" id="xdocTags">
        Tags:
        </div>
  
  <div id="xdocAuthors">
    <div class="xdocCreation">       Created by Administrator on 2009/10/26 12:15<br/>
          </div>
    <div class="xdocLastModification">       Last modified by Renee Sommerfeld on 2009/11/19 01:33
    </div>
  </div>
</div>
<div id="xwikidata" class="layoutsubsection">
        </div>  
    </div>      </div><div id="leftPanels" class="panels left">
                  <div class="panel expanded OSNav">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSNav');">Collectives</h1>
<div class="xwikipanelcontents">
<div id="xwikinavcontainer">
<span class="wikilink"><a href="/bin/view/Main/communities">Community Groups</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/projects">Projects</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/usergroups">User Groups</a></span>
</div><p/>
<script type="text/javascript">
document.observe('xwiki:dom:loaded', function() {
var obj = {div:'xwikinav',no:$count,height:250};
var acc = createAccordion(obj);
});
</script>
</div>
</div>
                        <div class="panel expanded OSDocs">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSDocs');">Project nwam Pages</h1>
<div class="xwikipanelcontents">
<ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Foundation">Foundation</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/1%2DStoryBoards">Story Boards</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/2%2DRequirements">Requirements</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/3%2DArchitecture">Architecture</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/4%2DDesign">Design</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase0">Phase 0</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/llp">Interface Configuration Policy</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/prototype">Prototype</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase0%2D5">Phase 0.5</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase1EA">Phase 1 Early Access</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase1Repo">Phase 1 Repository</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase1Spec">Phase 1 Spec</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Contents">TOC</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/DraftManPages">Draft Man Pages</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Glossary">Glossary</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/UIDesign">Phase 1 GUI Design</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Phase1">GUI Spec</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/usertasks_config">User Tasks for NWAM Configuration</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/usertasks_status">User Tasks for NWAM Status Notification</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/UIResearch">GUI Research & Futures</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/ConfigUI">UI Spec &#45; Phase 2</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Sketches">UI Sketches/Prototypes</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/stateoftheart">State of the Art</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/terminology">Terminology Study: Location vs. Environment</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/userexperience">User Scenarios</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/service%2Ddiscovery">Service Discovery</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+nwam/Applications">Applications</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/mdnsd_man">mdnsd(1M)</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+nwam/nsswitch_dns">nsswitch.dns</a></span></li>
</ul></li>
</ul>
                              </div>
</div>
      </div>

  </div>
<div class="clearfloats"></div>
  </div></div><div id="footerglobal" class="layoutsection">
<div class="minwidth"></div>
<hr/>
        <div id="xwikiplatformversion">XWiki Enterprise 2.7.1.34853 - <a onclick="openURL('http://enterprise.xwiki.org/xwiki/bin/view/Main/Documentation', '_blank'); return false;" href="http://www.xwiki.org/xwiki/bin/view/Main/Documentation">Documentation</a></div>
<br/>
  
      <div id="footer">
    <p>
                <a href="https://markebrooks.github.io/bin/view/Main/tou/">Terms of Use</a>
                |
                <a href="http://www.oracle.com/html/privacy.html">Privacy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/trademark/">Trademarks</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/copyrights/">Copyright Policy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site_guidelines/">Site Guidelines</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site-map/">Site Map</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/help/">Help</a>
                <br/>Your use of this web site or any of its content or software indicates your agreement to be bound by these Terms of Use.<br/>
                &copy; 2013, Oracle Corporation and/or its affiliates.<br/><img src="https://markebrooks.github.io:443/static/images/logo_oracle_footer.gif" alt="Oracle Logo"/>
            </p>
        </div>

  
</div>

</div></div></body>
</html>
