<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                                    <title>Virtual Memory - HAT (Project ppc-dev.vm) - XWiki</title>
                <meta http-equiv="Content-Script-Type" content="text/javascript" />
                        <meta http-equiv="imagetoolbar" content="no"/>
                      <link rel="alternate" type="application/x-wiki" title="Edit" href="/bin/edit/Project+ppc%2Ddev/vm" />
                    <link rel="canonical" href="/bin/view/Project+ppc%2Ddev/vm" />
                            <meta name="document" content="Project ppc-dev.vm"/>
    <meta name="wiki" content="xwiki"/>
    <meta name="space" content="Project ppc-dev"/>
    <meta name="page" content="vm"/>
    <meta name="version" content="1.1"/>
    <meta name="restURL" content="/rest/wikis/xwiki/spaces/Project+ppc-dev/pages/vm"/>
                <meta name="gwt:property" content="locale=en" />
                <meta name="revisit-after" content="7 days" />
<meta name="description" content="Virtual Memory - HAT" />
<meta name="keywords" content="wiki " />
<meta name="distribution" content="GLOBAL" />
<meta name="rating" content="General" />
<meta name="author" content="admin" />
<meta http-equiv="reply-to" content="" />
<meta name="language" content="en" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Wiki Feed RSS" href="/bin/view/Main/WebRss?xpage=rdf" />
<link rel="alternate" type="application/rss+xml" title="Blog RSS Feed" href="/bin/view/Blog/GlobalBlogRss?xpage=plain" />
<link rel="shortcut icon" href="/resources/icons/oso/icon.png">
                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
<link href="https://markebrooks.github.io/static/css/stylesheet.css" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/style.css?colorTheme=ColorThemes.Oso" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/print.css" rel="stylesheet" type="text/css" media="print" />
        <!--[if IE]>
  <link href="/bin/skin/skins/colibri/ie%2Dall.css" rel="stylesheet" type="text/css" />
<![endif]-->
<!--[if IE 6]>
  <link href="/bin/skin/skins/colibri/ie%2D6.css" rel="stylesheet" type="text/css" />
<![endif]-->
<link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Settings?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Style?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/XWiki/SharePage?language=en'/>
<link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/modalPopup.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/jumpToPage.css?language=en'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/confirmationBox.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/notification.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.css'/>

    
    <link href="/bin/skin/resources/js/xwiki/suggest/ajaxSuggest.css" rel="stylesheet" type="text/css" />
<link href="/bin/skin/resources/js/xwiki/lightbox/lightbox.css" rel="stylesheet" type="text/css" />
<!--[if IE]>
  <link href="/bin/skin/resources/js/xwiki/lightbox/lightboxIE.css" rel="stylesheet" type="text/css" />
<![endif]-->












<script type="text/javascript" src="/resources/js/prototype/prototype.js"></script>
<script type="text/javascript" src="/bin/skin/resources/js/xwiki/xwiki.js"></script>
<script type="text/javascript">
// <![CDATA[
XWiki.webapppath = "";
XWiki.servletpath = "bin/";
XWiki.contextPath = "";
XWiki.mainWiki = "xwiki";
XWiki.currentWiki = "xwiki";
XWiki.currentSpace = "Project ppc-dev";
XWiki.currentPage = "vm";
XWiki.editor = "";
XWiki.viewer = "";
XWiki.contextaction = "view";
XWiki.docisnew = false;
XWiki.docsyntax = "xwiki/2.0";
XWiki.blacklistedSpaces = [ "Import","Panels","Scheduler","Stats","XAppClasses","XAppSheets","XAppTemplates","XWiki","WatchCode","WatchSheets","XApp","WatchAdmin","Watch","ColorThemes","AnnotationCode" ];
XWiki.hasEdit = false;
XWiki.hasProgramming = false;
XWiki.hasBackupPackImportRights = false;
window.docviewurl = "/bin/view/Project+ppc%2Ddev/vm";
window.docediturl = "/bin/edit/Project+ppc%2Ddev/vm";
window.docsaveurl = "/bin/save/Project+ppc%2Ddev/vm";
window.docgeturl = "/bin/get/Project+ppc%2Ddev/vm";
// ]]>
</script>
<script type='text/javascript' src='/bin/skin/resources/js/scriptaculous/effects.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/modalPopup.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/jumpToPage.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmationBox.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmedAjaxRequest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/notification.js' defer='defer'></script>
<script type='text/javascript' src='/resources/uicomponents/widgets/list/xlist.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/suggest/ajaxSuggest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/scriptaculous/scriptaculous.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/accordion/accordion.js' defer='defer'></script>

<script type='text/javascript' src='/bin/jsx/XWiki/WebDAV?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Settings?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Script?language=en' defer='defer'></script>

<script type="text/javascript" src="/resources/js/xwiki/compatibility.js" defer="defer"></script>

  </head>
  <body id="body" class="wiki-xwiki space-Project_ppc-dev viewbody hideright">
<div id="xwikimaincontainer">
<div id="xwikimaincontainerinner">

  <div id="menuview">
    <div id="mainmenu" class="layoutsubsection actionmenu">
<strong id="xwikimenutitle" class="hidden">General Actions:</strong>
<div class="rightmenu">
      <div id="tmLogin" class="tmLogin topmenuentry ">
   <a class="tme" href="https://auth.opensolaris.org/login.action?targetUrl=http%3A%2F%2Fmarkebrooks.github.io%2Fbin%2Fview%2FProject%2Bppc%252Ddev%2Fvm"><strong>Log-in</strong></a>
  </div>
  </div>
<div class="leftmenu">
  <div id="tmWiki" class="tmWiki topmenuentry hasIcon">
   <a class="tme" href="/bin/view/Main/"><strong>Wiki</strong></a>
  </div>
  <div id="tmSpace" class="tmSpace topmenuentry dropdownmenuentry  hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Project+ppc%2Ddev/"><strong>Project ppc-dev</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
                <span class="submenuitem "><a href="/bin/view/Main/SpaceIndex?space=Project+ppc%2Ddev" id="tmSpaceDocumentIndex" class="tmSpaceDocumentIndex">Document Index</a></span>
    </span></div>

<div id="tmSubSites" class="tmSubSites topmenuentry dropdownmenuentry dropdownnolink hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Subsites</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem hasIcon"><a href="https://cr.opensolaris.org/" id="tmCR" class="tmCR">Code Reviews</a></span>
<span class="submenuitem hasIcon"><a href="http://repo.opensolaris.org/" id="tmRepo" class="tmRepo">SCM Management</a></span>
<span class="submenuitem hasIcon"><a href="http://pkg.opensolaris.org/" id="tmPkg" class="tmPkg">Package Search</a></span>
<span class="submenuitem hasIcon"><a href="http://bugs.opensolaris.org/" id="tmBugs" class="tmBugs">Bugster</a></span>
<span class="submenuitem hasIcon"><a href="http://defect.opensolaris.org/" id="tmDefect" class="tmDefect">Bugzilla</a></span>
<span class="submenuitem hasIcon"><a href="http://test.opensolaris.org/" id="tmTest" class="tmTest">Test Machines</a></span>
<span class="submenuitem hasIcon"><a href="http://planet.opensolaris.org/" id="tmPlanet" class="tmPlanet">Planet</a></span>
<span class="submenuitem hasIcon"><a href="http://mail.opensolaris.org/" id="tmMail" class="tmMail">Mailing Lists</a></span>
<span class="submenuitem hasIcon"><a href="http://poll.opensolaris.org/" id="tmPoll" class="tmPoll">Elections &amp; Polls</a></span>
<span class="submenuitem hasIcon"><a href="http://arc.opensolaris.org/" id="tmArc" class="tmArc">ARC Case Logs</a></span>
<span class="submenuitem hasIcon"><a href="http://jucr.opensolaris.org/" id="tmJucr" class="tmJucr">Source Juicer</a></span>
<span class="submenuitem hasIcon"><a href="http://pkgfactory.opensolaris.org/" id="tmPkgfactory" class="tmPkgfactory">Package Factory</a></span>
<span class="submenuitem hasIcon"><a href="http://auth.opensolaris.org/" id="tmAuth" class="tmAuth">Auth</a></span>
</span></div>

</div>
</div>

  </div>
 <div id="header" class="layoutsection">
<div class="minwidthb"></div>

  <div id="header">
    <table style="width: 100%;">
        <tr>
            <td style="width: 1%;">
                 <a href="https://markebrooks.github.io/bin/view/Main/"><div id="logo"></div></a>
            </td>
            <td style="width: 99%;">
                <table id="loading-indicator">
                    <tr>
                        <td><img src="https://markebrooks.github.io:443/static/images/busy.gif"
                                 alt="Loading" title="Loading"/></td>
                        <td>Loading...</td>
                    </tr>
                </table>
            </td>
            <td style="width: 1%;">
                <table id="iconbar">
                    <tr>
                    <td><a id="collectives-icon" href="https://markebrooks.github.io/bin/view/Main/collectives">
                        Collectives</a></td>
                    <td><a id="discussions-icon" href="https://markebrooks.github.io/bin/view/Main/discussions">
                            Discussions</a></td>
                    <td><a id="documentation-icon" href="https://markebrooks.github.io/bin/view/Main/documentation">
                            Documentation</a></td>
                    <td><a id="download-icon" href="https://markebrooks.github.io/bin/view/Main/downloads">
                            Download</a></td>
                    <td><a id="source-browser-icon" href="http://src.opensolaris.org/source">
                            Source Browser</a></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

 </div> 
  <div id="globallinks">
    <form action="/bin/view/Main/Search">
      <div class="globalsearch">
        <label class="hidden" for="headerglobalsearchinput">Search</label><input class="globalsearchinput withTip" id="headerglobalsearchinput" type="text" name="text" value="search..." size="15"/><input class="button" type="image" value="Go" alt="Go" src="/resources/icons/xwiki/search.png"/>
      </div>
    </form>
  </div> <div style="float:left;">

                

   <div id="hierarchy">
                              <a href='/bin/view/Project+ppc%2Ddev/task_map'>Project Task Map</a> <span class='separator'>&#187;</span> <span class='current'>Virtual Memory - HAT</span>
                </div>

</div>
  <span class="glink" id="headerlanguages" style="float:right">
        <a href="/bin/view/Project+ppc%2Ddev/vm?language=en" class="language-default language-current">en</a>
    </span>


<div class="contenthideright" id="contentcontainer">
<div id="contentcontainerinner">
<div class="leftsidecolumns">
  <div id="contentcolumn"> 
          <div class="main layoutsubsection">
      <div id="contentmenu" class="actionmenu">
    <strong id="xwikicontentmenutitle" class="hidden">Page Actions:</strong>
<div class="rightmenu">
</div>
<div class="leftmenu">
  <div id="tmExport" class="tmExport topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Export</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/export/Project+ppc%2Ddev/vm?format=pdf&amp;language=en" id="tmExportPdf" class="tmExportPdf">Export as PDF</a></span>
  <span class="submenuitem "><a href="/bin/export/Project+ppc%2Ddev/vm?format=rtf&amp;language=en" id="tmExportRtf" class="tmExportRtf">Export as RTF</a></span>
  <span class="submenuitem "><a href="/bin/export/Project+ppc%2Ddev/vm?format=html&amp;language=en" id="tmExportHtml" class="tmExportHtml">Export as HTML</a></span>
    </span></div>

<div id="tmShow" class="tmShow topmenuentry dropdownmenuentry  " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Project+ppc%2Ddev/vm?viewer=code&amp;language=en"><strong>View</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?viewer=comments&amp;language=en" id="tmViewComments" class="tmViewComments">Comments</a></span>
<span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?viewer=attachments&amp;language=en" id="tmViewAttachments" class="tmViewAttachments">Attachments</a></span>
<span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?viewer=history&amp;language=en" id="tmViewHistory" class="tmViewHistory">History</a></span>
<span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?viewer=information&amp;language=en" id="tmViewInformation" class="tmViewInformation">Information</a></span>
<span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?viewer=code&amp;language=en" id="tmViewSource" class="tmViewSource">View Source</a></span>
</span></div>

  <div id="tmMoreActions" class="tmMoreActions topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>More actions</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?xpage=print&amp;language=en" id="tmPrintPreview" class="tmPrintPreview">Print preview</a></span>
          <span class="submenuitem "><a href="/bin/view/Project+ppc%2Ddev/vm?xpage=copy" id="tmActionCopy" class="tmActionCopy">Copy</a></span>
      </span></div>
</div>

    </div>
    <div id="mainContentArea">
      








    
<div id="document-title"><h1>Virtual Memory - HAT</h1></div>

              <div id="document-info">
    <div>
          </div>
    <div class="clearfloats"></div>
  </div>

<div id="xwikicontent">
<h2 id="HVirtualMemory-HAT28HardwareAddressTranslation29Layer"><span>Virtual Memory - HAT (Hardware Address Translation) Layer</span></h2><h3 id="HStatus062F052F2007"><span>Status 06/05/2007</span></h3><p>With the 2nd release of source the VM and the HAT layers are functional. The kernel is in control of the MMU even though we haven't yet executed a bop_quisce. We still are relying on the prom interface &nbsp;for the console, print and network connection. However in the kernel memory management there is comfort level with it's functionality. If you have reviewed the Openfirmware task you will have noticed the issues related to the lack of the ODW firmware running virtual memory mode. Overall this masked a number of items such that when we got VOF up and running we actually regressed in this area. However that is behind us.</p><p>More details to follow along with the 2nd source release.</p><div class="wikimodel-emptyline"></div><h3 id="HInitialReviewoftheHATLayer-12F12F06"><span>Initial Review of the HAT Layer - 1/1/06</span></h3><p>Way back when, before even writing a line of code Guy did an assessment of the original 2.6 code to see what was usable in a 2.11 port project. Below are his notes from that review.</p><p>Virtual Memory: HAT - Hardware Address Translation Layer - Guy Shaw</p><p>The Virtual Memory sustem can be considered the core of a Solaris system, and the implementation of Solaris virtual memory affects just about every other subsystem in the operating system. Rather than managing every byte of memory, Solaris uses page-size pieces of memory to minimize the amount of work the virtual memory system has to do to maintain virtual-to-physical memory mappings. Figure 4.1 shows how the management and translation of the virtual view of memory (the address space) to physical memory is performed by hardware known as the virtual memory management unit (MMU).</p><p>\-<del>-</del></p><p>Guy has evaluated HAT interface changes based on a difference listing of 2.6 vs 2.10. usr/src/uts/common/vm/hat.h in /ws/on998-gate vs /ws/onnv-gate.</p><p>&nbsp;&nbsp;&nbsp;*The following are new functions</p><pre>
    hat_dump
    hat_thread_exit
</pre><pre>
    hat_unload_callback
    hat_register_callback
    hat_add_callback
    hat_delete_callback
</pre><pre>
    hat_getkpfnum_badcall
</pre><pre>
    hat_reserve
</pre><pre>
    hat_page_demote
</pre><pre>
    /// Kernel Physical Mapping (segkpm) hat interface routines. ///
    hat_kpm_mapin
    hat_kpm_mapout
    hat_kpm_page2va
    hat_kpm_vaddr2page
    hat_kpm_fault
    hat_kpm_mseghash_clear
    hat_kpm_mseghash_update
    hat_kpm_addmem_mseg_update
    hat_kpm_addmem_mseg_insert
    hat_kpm_addmem_memsegs_update
    hat_kpm_mseg_reuse
    hat_kpm_delmem_mseg_update
    hat_kpm_split_mseg_update
    hat_kpm_walk
</pre><pre>
    va_to_pfn
    va_to_pa
</pre><p><strong>The following functions have been removed</strong></p><pre>
    hat_pageflip
</pre><p><strong>The following functions have a change in function signature</strong></p><pre>
    hat_share
    hat_unshare
</pre><pre>
    hat_dump() is small and is entirely processor-independent code.
</pre><pre>
    hat_thread_exit() is small but the underlying function that implements it,
    hat_switch(), does processor-specific and mmu-specific things to switch 
    from one thread to another. Not a big problem.
</pre><pre>
    The hat callback family of functions is currently implemented on Sparc only.
    We can just supply pacifiers to comply with the new interface.
    hat_getkpfnum() is deprecated. There are a few places left that still call 
    hat_getkpfnum(). Those have all been changed to hat_getkpfnum_badcall() 
    so that hat_getkpfnum() can be eliminated from the HAT interface. That way, 
    nobody is tempted to write new code that uses hat_getkpfnum(). 
    hat_getkpfnum_badcall() is just the implementation of what used to be 
    hat_getkpfnum(). This is an easy change.
</pre><pre>
    hat_reserve() does nothing.
</pre><pre>
    hat_page_demote() is a significant amount of work. Much of it is 
    processor-independent, because it has to do with the way Solaris allocates 
    and deallocates Hardware Mapping Entries (HMEs). However, this can be 
    deferred, because it is only used for mappings of large page sizes. We 
    don't have to exploit large page sizes in userland in the first cut.
</pre><pre>
    Kernel Physical Mapping (segkpm) hat interface routines, hat_kpm_*(), are 
    process-specific, but are trivial. Many would be noops on PowerPC.
</pre><pre>
    va_to_pfn() is used only at boot time, while the boot loader is in charge of
    the MMU. It is illegal to use it after that. Whoever writes the boot stuff 
    can do what he wants. We may need to coordinate on this item.
</pre><pre>
    va_to_pa() is declared in the common hat interface but is really only 
    implemented on Sparc and only sparc-specific code (drivers, etc.) call it. 
    We not only don't have to implement it, we don't even have to define it.
</pre><pre>
    The removal of hat_pageflip() is not a problem. The Power&lt;nop&gt;PC 
    implementation just returned a status indicating that this feature was not 
    supported.
</pre><pre>
    The change to hat_share() and hat_unshare() involve adding an argument, a 
    page size code, to indicated the desired page size for shared mappings. 
    This can be made simple by restricting the variety of page sizes we will 
    deal with. For starters, we don't even have to support Intimate Shared 
    Memory (ISM) at all.
</pre><pre>
    A few flags have been added for some functions:
    HAT_RELOAD_SHARE
    HAT_NO_KALLOC
    HAT_LOAD_AUTOLPG
    HAT_INIT
</pre><pre>
    all these are either trivial or can be deferred. That's about it for 
    interface changes. Please see below for comprehensive details on HAT port
</pre><h3 id="HStudyoftheFeasibilityofReusingSolarisPPC2.6HATCode"><span>Study of the Feasibility of Reusing Solaris PPC 2.6 HAT Code</span></h3><pre>
    Guy has composed a more structured overview which can be seen below
</pre><pre>
    Study of the Feasibility of Reusing Solaris/PPC 2.6 HAT Code
</pre><p><strong>Background<br/> &nbsp;&nbsp;&nbsp;<br/><tt class="wikimodel-verbatim">
    Sun has already done a port of Solaris to PowerPPC.  In 1995, Solaris
    the release 2.5.1 supported PowerPC.  Additional work was done for Solaris 
    rev 2.6. After 2.6, PPC support was removed, for commercial reasons rather
    than any technical failure.
</tt></strong></p><pre>
    A big question in considering how to do the new Solaris/PPC is:
    How much code from the Solaris/PPC 2.6 release can and should be reused, if 
    any?
</pre><pre>
    This document is concerned about answering that question only for
    the HAT layer and other processor-specific VM code, and portions of
    the boot that deal with VM.
</pre><pre>
    There are many pieces of processor-specific code involved in any
    port of Solaris to a new processor, but the HAT layer is a large and
    critical part.  Whether a new HAT layer is written from scratch or
    existing code is reused and upgraded, it is necessary to have some
    idea of the costs of the HAT layer in order to have any hope of
    reasoning about the total costs of the porting project.
</pre><p><strong>HAT Roles<br/> &nbsp;&nbsp;&nbsp;<br/><tt class="wikimodel-verbatim">
    The HAT layer has many roles with respect to other parts of the
    system, including hardware and other software.  In order to make
    decisions about the suitability of the existing code to be reused,
    all of these roles must be examined, in light of the changes that
    have taken place over the last decade.
</tt></strong></p><pre>
    The roles the HAT layer plays are:
</pre><ol><li>HAT/MMU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Manager of hardware MMU resources</li><li>HAT/provider &nbsp;&nbsp;&nbsp;- Provider of kernel services</li><li>HAT/consumer &nbsp;&nbsp;&nbsp;- Consumer of kernel services</li><li>HAT/boot &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Partner during boot</li></ol><pre>
    The term HAT/runtime is used to denote HAT/MMU, HAT/provider,
    and HAT/consumer, together; that is, everything except HAT/boot.
</pre><pre>
    Keep in mind that the boundary between HAT roles is just logical, for
    the sake of decomposing the analysis of changes in requirements.  It is
    not that there are separate files, packages, modules, or functions
    (whatever) that keep the code for these roles separate.  There is
    separate code for HAT/boot vs HAT/runtime, but it is not possible to
    separate out HAT/runtime roles in any coarse-grain fashion.  A single
    function can be HAT/provider in one line and call some function
    (HAT/consumer) in the next, then immediately do some low-level TLB
    management (HAT/MMU).
</pre><p><strong>The Decision Process</strong></p><pre>
    It could be that the existing code is simply too far out of date with
    respect to any combination of these four roles.  In that case the
    issue of re-usability would be a no-brainer, just scrap the old code.
    In the case of interaction with boot, a decision can be made separately
    to scrap most of the boot-related code, but keep all code related to
    the other HAT roles.
</pre><pre>
    If there is enough value in the old code, then things are not quite
    so simple, because decisions can be influenced by other factors, such
    as schedule and budget and willingness to drop or defer development
    of some functionality.
</pre><pre>
    For example, if rapid bring-up is an absolute requirement then things
    can be done for the sake of quick results, but which mean that cleanup
    or major revisions will have to be done later.  Examples of possible
    deferred HAT functionality are:
</pre><ol><li>support for Intimate Shared Memory (ISM)</li><li>support for 64 bit machines</li><li>support for multiprocessor machines</li></ol><pre>
    The following four sections will present an evaluation of the
    suitability of the Solaris 2.6 code.  Each role will be evaluated
    in terms of a quick go/no-go test, then in terms of time and
    optional features.
</pre><h3 id="HHAT2FMMU-ManagerofhardwareMMUresources"><span>HAT/MMU - Manager of hardware MMU resources</span></h3><pre>
    64-bit
</pre><p>Solaris/PPC 2.6 has no support for 64-bit models. &nbsp;Not for 64-bit<br/>kernel and not for 64-bit applications. &nbsp;That is bad news. &nbsp;But it<br/>does not necessarily mean that Solaris/PPC 2.6 HAT is unsuitable<br/>for reuse. &nbsp;If we wrote a new HAT from scratch, it is still more work<br/>to support both 32-bit and 64-bit kernel and applications. &nbsp;Since the<br/>new Solaris/PPC port see use for embedded systems, we believe that we<br/>would not contemplate supporting only a 64-bit kernel, as is done<br/>on Sparc. &nbsp;Even if we did that, in order to eliminate one of the four<br/>combinations, it would not save as much as 1/4 of the effort.</p><p>What this means is that it boils down to 2 questions:</p><p>1) Is the 64-bit MMU hardware so fundamentally different that the<br/>32-bit code cannot (or should not) be reused?</p><p>2) Was the Solaris/PPC 2.6 HAT code designed in a way that makes it<br/>unnecessarily difficult to support both 32-bit and 64-bit hardware?</p><p>You might think that the MMU hardware would be fundamentally different<br/>between 32-bit and 64-bit, and necessarily so. &nbsp;The major rewrite<br/>of Solaris/x86 HAT code was triggered by the port to AMD64. &nbsp;But,<br/>that was only the proximate cause.</p><p>Intel's x86 hardware was designed <em>much</em> earlier than PowerPC.<br/>Intel did not start out with a road-map for 64-bit kernel or userland.<br/>Solaris/x86 was not designed with a 64-bit future in mind. &nbsp;But, the<br/>PowerPC &nbsp;was designed from the beginning to be a 64-bit architecture<br/>with a 32-bit subset. &nbsp;That applies to the MMU design as well as ISA<br/>(Instruction Set Architecture).</p><p>The PowerPC has hashed page tables, unlike the x86, which has<br/>forward-mapped page tables. &nbsp;Also, there is one global page table, no<br/>per-process or per-group or separate kernel vs userland page tables.<br/>That is not a decision made by a kernel developer; it is pretty much<br/>dictated by the PowerPC MMU design, and we do not want to fight the<br/>hardware. &nbsp;64-bit addresses have segment IDs that are 32 bits longer,<br/>but the role of the lower order bits in hashing and indexing into<br/>the page table is the same for 32-bit and 64-bit. &nbsp;The designers of<br/>Solaris/PPC knew this at the time and kept it in mind. &nbsp;Although it<br/>has not been put to the test, the code appears to be sufficiently<br/>64-bit clean.</p><p>Conclusion: going to 64-bit HAT is nowhere near as traumatic as it<br/>was for x86 and AMD64.</p><p>Other aspects of 64-bit Solaris/PPC are outside the scope of this<br/>document. &nbsp;They would include design of a 64-bit ABI, link editor,<br/>etc. and getting consensus from all stake-holders. &nbsp;Historically,<br/>arriving at a consensus has been known to consume a great deal of time.<br/>But, reusing Solaris/PPC 2.6 HAT code does not add to this problem.</p><p><em>Location and size of page tables</em></p><p>There is a possibility of running into problems with a larger page<br/>table on a 64-bit system with more physical memory. &nbsp;This is because<br/>the pagetable is contiguous physical memory and a larger page table<br/>might conflict with something else that needs to be in lower memory<br/>or upper memory. &nbsp;But, I don't think this is too likely. &nbsp;In any case,<br/>this problem is not made worse by reusing Solaris/PPC 2.6 code.</p><p><em>MMU related traps</em></p><p>Older models of PowerPC generated traps for every TLB miss. &nbsp;Newer<br/>models can reload the TLB from the page tables without any traps;<br/>the only page fault is a major page fault. &nbsp;This is a welcome change.<br/>We could leave the trap handler in the code for the sake of older<br/>models, or we could purge it if we know we will never encounter<br/>hardware that generates TLB-miss traps. &nbsp;Better to have and not need<br/>than to need and not have. &nbsp;However, finding machines to test this<br/>case could be difficult.</p><p><em>Endianness</em></p><p>PowerPC can operate in either big-endian or little-endian mode.<br/>Solaris/PPC runs in little-endian mode. &nbsp;This decision was made<br/>primarily because of customer requirements at the time (1993-1995),<br/>not for any purely technical reason. &nbsp;Without those commercial<br/>requirements, there would be a slight advantage to running big-endian.<br/>For one thing, PowerPC page tables are big-endian, independent of the<br/>overall endian mode of the machine. &nbsp;The designers of Solaris/PPC knew<br/>at the time that this might be controversial and subject to change,<br/>and they coded accordingly. &nbsp;The HAT layer used accessor functions<br/>for all read and modify operations on the page tables. &nbsp;Other parts of<br/>Solaris have some endianness dependencies, but I believe they are not<br/>a huge problem. &nbsp;In fact, we have a running big-endian version<br/>of Solaris/PPC that was done as a feasibiltiy project. &nbsp;So, we might <br/>be able to use that as a starting point.</p><p><em>Cache Implementation</em><br/>-<del>-<br/>The PowerPC architecture leaves the details of cache implementation<br/>pretty wide open so that each model can be free to implement caching<br/>in its own way. &nbsp;A model of PowerPC is allowed to implement no cache<br/>at all. &nbsp;It is possible that Solaris/PPC 2.6 code, which supported<br/>a small number of early PowerPC models, would have to be modified to<br/>handle a wider range of cache behaviors in order to support newer<br/>models. &nbsp;Besides cache geometry (number of levels, size of each level,<br/>line sizes), which ought to be parameterized, other implementation<br/>details are possible, which may require more significant code changes<br/>to support. &nbsp;For example, on some models, a cache might be virtually<br/>indexed, as is the case for some Sparc models. &nbsp;In that case, code<br/>to handle page coloring would need to be added for performance.<br/>At least in the case of the MPC-7450, this will not be necessary.</del></p><p><em>Multiprocessor</em><br/>-<del>-<br/>Solaris/PPC has been written with multiprocessor machines in mind.<br/>There was a working version running in the lab, but it was not<br/>integrated into Solaris 2.7, because Solaris/PPC was canceled by<br/>then. &nbsp;Multiprocessor machines are much more common, today, and so<br/>expectations are higher. &nbsp;A PPC port of Solaris would still require <br/>much effort to verify multiprocessor mostly due to testing.</del></p><div class="wikimodel-emptyline"></div><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT/provider &nbsp;&nbsp;&nbsp;- Provider of kernel services</em><br/>-</del>-</p><p>The HAT layer is inherently processor and platform dependent.<br/>For that reason, Solaris HAT interfaces are pretty well-defined,<br/>much more so that some other parts of the kernel which have not<br/>had to be ported several times over Solaris's life. &nbsp;Therefore, of<br/>all parts of the kernel, the HAT layer is among the least likely to<br/>suffer from illegitimate interfaces, such as unintended dependencies,<br/>spooky action at a distance, lack of decomposability, etc.</p><p>All legitimate HAT interface is defined in usr/src/uts/common/vm/hat.h.<br/>This basic source code structure has not changed. &nbsp;It was a good idea<br/>then, and it is a good idea now.</p><p>How has the HAT interface since Solaris 2.6? &nbsp;This can be answered by<br/>examining a difference listing of usr/src/uts/common/vm/hat.h between<br/>2.6 and the current version of Solaris.</p><p>The two source code gates to be compared are:</p><p>&nbsp;&nbsp;&nbsp;/ws/on297-gate<br/>&nbsp;&nbsp;&nbsp;/ws/onnv-gate</p><p>The following are new functions:</p><p>&nbsp;&nbsp;&nbsp;hat_dump<br/>&nbsp;&nbsp;&nbsp;hat_thread_exit</p><p>&nbsp;&nbsp;&nbsp;hat_unload_callback<br/>&nbsp;&nbsp;&nbsp;hat_register_callback<br/>&nbsp;&nbsp;&nbsp;hat_add_callback<br/>&nbsp;&nbsp;&nbsp;hat_delete_callback</p><p>&nbsp;&nbsp;&nbsp;hat_getkpfnum_badcall</p><p>&nbsp;&nbsp;&nbsp;hat_reserve&nbsp;</p><p>&nbsp;&nbsp;&nbsp;hat_page_demote</p><p> &nbsp;&nbsp;<em>/ Kernel Physical Mapping (segkpm) hat interface routines.&nbsp;</em>/<br/>&nbsp;&nbsp;&nbsp;hat_kpm_mapin<br/>&nbsp;&nbsp;&nbsp;hat_kpm_mapout<br/>&nbsp;&nbsp;&nbsp;hat_kpm_page2va<br/>&nbsp;&nbsp;&nbsp;hat_kpm_vaddr2page<br/>&nbsp;&nbsp;&nbsp;hat_kpm_fault<br/>&nbsp;&nbsp;&nbsp;hat_kpm_mseghash_clear<br/>&nbsp;&nbsp;&nbsp;hat_kpm_mseghash_update<br/>&nbsp;&nbsp;&nbsp;hat_kpm_addmem_mseg_update<br/>&nbsp;&nbsp;&nbsp;hat_kpm_addmem_mseg_insert<br/>&nbsp;&nbsp;&nbsp;hat_kpm_addmem_memsegs_update<br/>&nbsp;&nbsp;&nbsp;hat_kpm_mseg_reuse<br/>&nbsp;&nbsp;&nbsp;hat_kpm_delmem_mseg_update<br/>&nbsp;&nbsp;&nbsp;hat_kpm_split_mseg_update<br/>&nbsp;&nbsp;&nbsp;hat_kpm_walk&nbsp;</p><p>&nbsp;&nbsp;&nbsp;va_to_pfn<br/>&nbsp;&nbsp;&nbsp;va_to_pa</p><p>The following functions have been removed:</p><p>&nbsp;&nbsp;&nbsp;hat_pageflip</p><p>The following functions have a change in function signature:</p><p>&nbsp;&nbsp;&nbsp;hat_share<br/>&nbsp;&nbsp;&nbsp;hat_unshare</p><p>hat_dump() is small and is entirely processor-independent code.</p><p>hat_thread_exit() is small but the underlying function that implements<br/>it, hat_switch(), does processor-specific and MMU-specific things to<br/>switch from one thread to another. &nbsp;Not a big problem.</p><p>The hat callback family of functions is currently implemented on Sparc<br/>only. &nbsp;We can just supply pacifiers to comply with the new interface.</p><p>hat_getkpfnum() is deprecated. &nbsp;There are a few places left<br/>that still call hat_getkpfnum(). &nbsp;Those have all been changed to<br/>hat_getkpfnum_badcall() so that hat_getkpfnum() can be eliminated<br/>from the HAT interface. &nbsp;That way, nobody is tempted to write new<br/>code that uses hat_getkpfnum(). &nbsp;hat_getkpfnum_badcall() is just<br/>the implementation of what used to be hat_getkpfnum(). &nbsp;This is an<br/>easy change.</p><p>hat_reserve() does nothing.</p><p>hat_page_demote() is a significant amount of work. &nbsp;Much of it is<br/>processor-independent, because it has to do with the way Solaris<br/>allocates and deallocates Hardware Mapping Entries (HMEs). &nbsp;However,<br/>this can be deferred, because it is only used for mappings of large<br/>page sizes. &nbsp;We don't have to exploit large page sizes in userland<br/>in the first cut.</p><p>Kernel Physical Mapping (segkpm) hat interface routines, hat_kpm_*(),<br/>are process-specific, but are trivial. &nbsp;Many would be no-ops on PowerPC.</p><p>va_to_pfn() is used only at boot time, while the boot loader is in<br/>charge of the MMU. &nbsp;It is illegal to use it after that. &nbsp;Whoever writes<br/>the boot stuff can do what he wants. &nbsp;We may need to coordinate on<br/>this item.</p><p>va_to_pa() is trivial, and is the same for all processors. &nbsp;It is<br/>just va_to_pfn() with the page offset of the given virtual address<br/>blended back in to give the corresponding physical address.</p><p>The removal of hat_pageflip() is not a problem. &nbsp;The PowerPC<br/>implementation just returned a status indicating that this feature<br/>was not supported.</p><p>The change to hat_share() and hat_unshare() involve adding an<br/>argument, a page size code, to indicated the desired page size for<br/>shared mappings. &nbsp;This can be made simple by restricting the variety<br/>of page sizes we will deal with. &nbsp;For starters, we don't even have<br/>to support Intimate Shared Memory (ISM) at all.</p><p><em>Flags</em><br/>-<del>-<br/>A few flags have been added for some functions:</del></p><p>&nbsp;&nbsp;&nbsp;HAT_RELOAD_SHARE<br/>&nbsp;&nbsp;&nbsp;HAT_NO_KALLOC<br/>&nbsp;&nbsp;&nbsp;HAT_LOAD_AUTOLPG<br/>&nbsp;&nbsp;&nbsp;HAT_INIT</p><p>all these are either trivial or can be deferred.</p><div class="wikimodel-emptyline"></div><p><em>Intimate Shared Memory (ISM)</em><br/>-<del>-<br/>ISM is strictly a performance feature. &nbsp;It does not involve any change<br/>to the HAT interface. &nbsp;ISM is a term used to refer to the cases when<br/>multiple processes can share not only mappings to the same physical<br/>memory, but also MMU resources used for those mappings. &nbsp;For example,<br/>in the case of x86, with forward-mapped page tables, entire pages of<br/>Page Table Entries (PTEs) can be shared, provided that the virtual<br/>addresses and size just happen to be suitable for sharing pages<br/>of PTEs. &nbsp;Let's use the term "PTE-page-span" to describe the size<br/>mapped by an entire page of PTEs. &nbsp;It is not required that all the<br/>mappings to the same physical memory have the same virtual address.<br/>But, the virtual addresses must all be aligned on a PTE-page-span<br/>boundary, and their sizes must be a multiple of the PTE-page-span.<br/>Any mappings that are less strict about VA alignment and size cannot<br/>share page tables without violating Unix memory mapping semantics<br/>and/or security principles. &nbsp;If VA alignment and size are even more<br/>strict, then 2nd-level and even higher level pages of directory entries<br/>could be shared. &nbsp;Something very similar has been done on Itanium and<br/>MIPS hardware, except that those machines have linear page tables,<br/>rather than forward-mapped.</del></p><p>Solaris/PPC 2.6 does not implement ISM. &nbsp;But, the absence of ISM<br/>support is clean. &nbsp;That is, the fact that ISM was not supported<br/>in Solaris/PPC 2.6 does not affect any decision to reuse the<br/>existing code. &nbsp;The same work would have to be done whether adding<br/>functionality to the old code or writing all new code. &nbsp;Whether any<br/>functionality we add is easy or difficult, it is pure and simple<br/>addition of functionality. &nbsp;Nothing about the Solaris/PPC 2.6 HAT<br/>design involved work that would have to be undone or commitments to<br/>a way of doing things that we might regret.</p><p>PowerPC MMU does not have any such thing as pages of PTEs. &nbsp;The only<br/>possible way to support any sharing of MMU resources on PowerPC is to<br/>use Block Address Translation (BAT) registers. &nbsp;BAT registers are the<br/>only mechanism for mapping regions of memory with a page size larger<br/>than 4K. &nbsp;There are only a handful of BAT registers. &nbsp;ISM implemented<br/>this way would have more strict alignment requirements, because a<br/>single BAT entry with a large page size would require:</p><p>&nbsp;&nbsp;&nbsp;1) that all mapping be naturally aligned with respect to page size;<br/>&nbsp;&nbsp;&nbsp;2) that the requested size must be exactly 1 page size;<br/>&nbsp;&nbsp;&nbsp;3) that the underlying physical memory be contiguous and naturally aligned physical addresses.</p><p>An unlimited number of processes could share the same memory, but at<br/>any time, only a very small number of these mappings can be supported.<br/>On an embedded system, there might be an application for which this<br/>support is just perfect. &nbsp;Even a single very large mapping shared<br/>by 2 processes could be a big win for the right kind of application.<br/>It could save a great deal of pressure on the page table. &nbsp;Let's see<br/>... large mappings can save 256 PTEs per megabyte. &nbsp;A 1 GByte mapping<br/>for shared data could save 1/4 megaPTEs. &nbsp;In order to do this, there<br/>would have do be some mechanism for preventing physical memory from<br/>getting fragmented beyond redemption before we even get to the first<br/>userland process. &nbsp;There is no interface to do this. &nbsp;There would<br/>probably have to be something in /etc/system to tell the kernel to<br/>reserve physical memory early on.&nbsp;&nbsp;</p><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT/consumer &nbsp;&nbsp;&nbsp;- Consumer of kernel services</em><br/>-</del>-</p><p>The HAT layer, proper, is pretty low down in the dependency tree of all<br/>kernel services. &nbsp;This is especially true of the pure TLB management<br/>functions. &nbsp;We would be in trouble if the data types and functions<br/>provided by the kernel changed significantly in the last decade.<br/>But it looks like we are in pretty good shape.</p><p><em>Data types</em><br/>-<del>-<br/>The HAT does interact with some other kernel data structures.</del></p><ol><li>HAT uses page_t's which describe pages of physical memory.</li></ol><p>The machine-dependent page_t, machpage_t, is a pure extension of<br/>the page_t data type; the page_t structure is not modified in any<br/>other way. &nbsp;No part of Solaris uses the machpage_t extensions.</p><p><em>Functions</em><br/>-<del>-<br/>The HAT layer needs locking primitives and some atomic operations.<br/>Function calls are used and the data types used with these functions<br/>are either opaque objects or primitive data types. &nbsp;So, the HAT does<br/>depend on functions such as: &nbsp;mutex_<em>(), cv_</em>(), atomic_*(), cas().<br/>The good news is that these functions are pretty low level and their<br/>interfaces are stable.</del></p><p>xXX Better separation of pure TLB management functions.<br/>XXX Move to separate library</p><p>XXX It may be a good idea to change use of cv_*() functions</p><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT/boot &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Partner during boot</em><br/>-</del>-</p><p>Solaris boot has changed considerably since 2.5.1 and 2.6. &nbsp;Almost all<br/>boot-related HAT code will have to be thrown out, no matter what.<br/>It is almost a complete write-off. &nbsp;Certainly, all the code related<br/>to boot-time device support is useless. &nbsp;Some snippets related to VOF,<br/>such as getting properties, can be used as a design suggestion.</p><p>XXX How much has VOF changed? &nbsp;Not much, we hope.</p><p>The good news is that modern boot makes many things easier. &nbsp;The basic<br/>problem of handing off allocated memory and mappings from boot to the<br/>kernel HAT is not much different, so some small pieces can be reused.</p><p>Another bit of good news is that some things that are done for good<br/>hygiene can be deferred. &nbsp;For example, we can just waste some memory<br/>owned by boot, bypassing the tricky hand-off code for those pages<br/>of memory. &nbsp;This is a good trade, for the sake of rapid bring-up.</p><p>Whether we reuse Solaris/PPC 2.6 code or not, I strongly recommend<br/>that we invest a great deal in enforcing the contract between boot and<br/>the HAT layer, much more than has been done for Sparc and x86, even<br/>more than was done for Solaris/IA64, which invested heavily in this.<br/>This kind of investment is one that is tempting to short-stroke in<br/>the interests of quick startup, but it pays big-time, unless all the<br/>developers are perfect in every way, or extremely lucky. &nbsp;In fact,<br/>I recommend that we deliberately change the contract, a few times<br/>during development, just to keep us safe from inadvertent dependency<br/>creep. &nbsp;For example, page table size and location can be changed,<br/>within reason; allocation of BAT registers can be changed, for no<br/>particular reason.</p><p>There is processor-dependent code to handle userland process address<br/>space allocations. &nbsp;It is not really part of the HAT, proper, but<br/>the developer who writes and maintains the HAT usually maintains<br/>this bit part, as well. &nbsp;In addition to changing HAT/boot contract,<br/>I recommend changing some aspects of VM layout, such as text start<br/>address. &nbsp;It is not that we cannot decide on a value and stick with it.<br/>It is a bit of a jolt to the system, just to keep things on track.<br/>Better to do it early, rather than later.</p><p>XXX More on boot/HAT contract, later.</p><p><em>Data types</em><br/>-<del>-<br/>XXX memseg structures changed?</del></p><p><em>Functions</em><br/>-<del>-</del></p><p><em>Flow of control</em><br/>-<del>-<br/>XXX flow of control from _starup() ... hat_kern_setup()</del></p><p>-<del>-</del></p><p>The following is a quick overview of HAT features<br/>and an assessment of:</p><ol><li>how easy it is to implement;</li><li>whether it can be deferred (from a purely technical perspective, not whether it is considered to be a critical requirement);</li><li>how much demand there is, particularly for embedded systems;</li><li>how urgent is the requirement;</li><li>how much of an embarrassment would it be if this feature were not implemented, considering things like how much expectations have changed in the last decade, what has Linux already done, etc.</li><li>How much more testing has to be done, let alone implementation cost. &nbsp;Some things could be coded right away, but have serious testing implications. &nbsp;For example, do we want to retain support for older models? &nbsp;That is a coding noop, but a huge increase in testing complexity, hardware procurement, and<br/><tt class="wikimodel-verbatim">
    so on.
</tt></li></ol><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;critcal &nbsp;testing<br/>&nbsp;&nbsp;Feature &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;easy? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer? demand urgency &nbsp;&nbsp;&nbsp;factor &nbsp;&nbsp;burden<br/>&nbsp;&nbsp;-<del>- -</del>--<del>--</del>--<del>--</del>- -<del>-<br/>&nbsp;&nbsp;Multiprocessor &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;??? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes &nbsp;&nbsp;&nbsp;high &nbsp;&nbsp;soon &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;high &nbsp;&nbsp;&nbsp;&nbsp;high<br/>&nbsp;&nbsp;64-bit &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maybe &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes &nbsp;&nbsp;&nbsp;??? &nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;high<br/>&nbsp;&nbsp;endian change &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes &nbsp;&nbsp;&nbsp;??? &nbsp;&nbsp;&nbsp;high &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low<br/>&nbsp;&nbsp;ISM &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes &nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;medium</del></p><p>-<del>-</del></p><p>XXX UPOD schedule vs quick&amp;dirty schedule<br/>XXX UPOD := Under-Promise Over-Deliver</p><p>-<del>-</del></p><p><em>OPINION on HAT DATA Structures</em></p><p>The hat data structure should be an opaque data type, preferably void. &nbsp;That is, nothing outside the HAT should refer to "struct hat", but to hat_t. &nbsp;So, hat_t <em>&nbsp;is void&nbsp;</em>, as far everyone is concerned, except the HAT implementation.</p><p>If we wrote the kernel in C++, we could make hat_t a class with private members.</p><p>We should be able to change all usage of "struct hat" to hat_t.</p><p>If that is not acceptable, than we ought to at least redefine the struct hat so that it has one member which is a simple data type and has an unlikely name, like <ins>none_of_your_business. &nbsp;Failing that, we ought to be able to redefine struct hat so that all the members are the same order, data type, offset, and size, but the member names have been changed, for example by prefixing each member name with&nbsp;</ins>.</p><p>vm/hat.h could have some preprocessor code like so:</p><h1 id="Hifdefined28HAT_IMPLEMENTATION29structhat7Bsome_typemember13B...7D3B"><span>if defined(HAT_IMPLEMENTATION)<br/>struct hat { some_type member1; ... };</span></h1><h1 id="Helsestructhat7Bsome_typemember13B...7D3B"><span>else<br/>struct hat { some_type <ins>member1; ... };</ins></span></h1><h1 id="Hendif"><span>endif</span></h1><p>END of OPINION</p><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT/boot Food Taster and HAT Debugging Tools</em><br/>-</del>-</p><p>Most of this document covers changes to Solaris/PPC 2.6 code that are<br/>imposed by external factors: changing hardware, evolution of Solaris,<br/>changes to boot. &nbsp;But, there are a few changes recommended here,<br/>simply because they are an important improvement in HAT construction<br/>technology. &nbsp;By a very wide margin, the top two are:</p><ol><li>Extensive HAT/boot food taster</li><li>HAT Debugging toolkit</li></ol><p>These additions do not come free of cost, so they need to be mentioned<br/>here. &nbsp;However, they have a very good chance of leading to a net<br/>reduction in system bringup time, and they contribute to more<br/>reliable time budgets, because big surprises are reduced.</p><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT/boot Food Taster</em><br/>-</del>-</p><p>Things don't go well if the HAT consumes anything toxic. &nbsp;Things can go<br/>especially badly early on and in mysterious ways if the HAT inherits<br/>MMU state from boot which is not compatible with the state for which<br/>it is designed. &nbsp;I recommend spending some time up front in writing<br/>a significant amount of code which tests the MMU state and other<br/>conditions, as they are when HAT first takes control. &nbsp;If there is<br/>anything that is not in order, the HAT/boot food taster should not<br/>be sparing in its effort to explain clearly what is expected and<br/>what it got, and then die a quick and merciful death. &nbsp;Perhaps in<br/>the process it can deliberately trigger the debugger (either hardware<br/>debugger or kmdb), if present, in a special way. &nbsp;The alternative to<br/>fail-fast semantics is system delusion, so fail fast and fail noisily.</p><p>This sort of thing was done on Solaris/IA64, and has been proven to save<br/>a great deal of time when integrating work done by several developers<br/>each working on different pieces, and possibly misunderstanding the<br/>HAT/boot contract.</p><p>Even if it were the case that large pieces of HAT/boot code could<br/>be reused, the amount of work needed to add a HAT/boot food taster<br/>is pretty much the same for a HAT code update or for a brand new<br/>HAT layer.</p><div class="wikimodel-emptyline"></div><p>-<del>-<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>HAT Debugging Toolkit</em><br/>-</del>-</p><p>It is common to sprinkle some ASSERTs in the code.<br/>Also, most HAT developers have a stash of HAT debugging<br/>aids, such as a handy-dandy pagetable hashing pocket calculator<br/>or pagetable walker/navigator. &nbsp;But, I believe it is a good idea<br/>to include a set of kernel functions and userland tools<br/>as a first class citizen in the software release.<br/>Solaris/IA64 had an extensive set of HAT debug helper functions,<br/>as well as userland tools to do HAT-specific monitoring of<br/>correctness and performance. &nbsp;Our new Solaris/PPC port can do even more<br/>because there are more hardware and software tools available,<br/>such as hardware debugger (when available) and DTrace.</p><p>The amount of work needed to add a HAT debugging toolkit<br/>is pretty much the same for a HAT code update or for a<br/>brand new HAT layer.</p><p>Some of the components of the HAT debugging toolkit are:</p><ol><li>Fault injection</li><li>Pagetable and HME verifier</li><li>Pagetable and HME statistics</li><li>Pathological workloads (small scale)</li></ol><p><em>Fault Injection</em><br/>-<del>-<br/>One example of the use of fault injection for the HAT layer is<br/>to arrange for races to be lost often. &nbsp;The function to atomically<br/>replace a PTE can be implemented with a version that deliberately<br/>causes it to fail with a specified probability, but being careful to<br/>limit the number of consecutive failures from the same caller so that<br/>we don't block forward progress of the system.</del></p><p><em>Pagetable and HME verifier</em><br/>-<del>-<br/>A pagetable and HME verifier is to the HAT data structures what fsck<br/>is to UFS filesystem metadata. &nbsp;On a running system things change too<br/>quickly to check consistency of the entire system, but at the time of a<br/>kernel panic, it can be done without disturbing the existing mappings.<br/>Also, most of the consistency checking is decomposable. &nbsp;That is,<br/>much can be determined about the internal consistency of a subset of<br/>page tables, and it can be tested quickly and nondestructively.</del></p><p><em>Pagetable and HME statistics</em><br/>-<del>-<br/>Before DTrace, it would have been very difficult to generate statistics<br/>about things like hash collisions without writing extra helper<br/>functions and rolling your own methods for enabling and disabling<br/>probing; and it was even more difficult to get statistics out of the<br/>kernel so that some userland monitoring / visualization program can<br/>slice and dice and present the data. &nbsp;DTrace makes this sort of thing<br/>a great deal easier. &nbsp;However, I believe the HAT may still have some<br/>hooks in it with DTrace &nbsp;and userland reporting programs in mind.</del></p><p><em>Pathological workloads</em><br/>-<del>-<br/>In order to exercise the logic for handling rare cases, such as<br/>clustering of hash collisions leading to full PTE groups, small<br/>workloads can be constructed that generate very unfortunate reference<br/>patterns.</del></p><p>-<del>-</del></p><p>There are several ideas for new functionality and performance<br/>enhancements, but they are not as important and certainly not as<br/>urgent as debugging aids. &nbsp;So, they will be collected in a document<br/>yet to come.</p>
</div>


    <div class="clearfloats"></div>
  </div>      <div id="xdocFooter">
  
                

       <div class="doc-tags" id="xdocTags">
        Tags:
        </div>
  
  <div id="xdocAuthors">
    <div class="xdocCreation">       Created by admin on 2009/10/26 12:17<br/>
          </div>
    <div class="xdocLastModification">       Last modified by admin on 2009/10/26 12:17
    </div>
  </div>
</div>
<div id="xwikidata" class="layoutsubsection">
        </div>  
    </div>      </div><div id="leftPanels" class="panels left">
                  <div class="panel expanded OSNav">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSNav');">Collectives</h1>
<div class="xwikipanelcontents">
<div id="xwikinavcontainer">
<span class="wikilink"><a href="/bin/view/Main/communities">Community Groups</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/projects">Projects</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/usergroups">User Groups</a></span>
</div><p/>
<script type="text/javascript">
document.observe('xwiki:dom:loaded', function() {
var obj = {div:'xwikinav',no:$count,height:250};
var acc = createAccordion(obj);
});
</script>
</div>
</div>
                        <div class="panel expanded OSDocs">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSDocs');">Project ppc-dev Pages</h1>
<div class="xwikipanelcontents">
<ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/GetStarted">Getting Started</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/faq">FAQ</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/files">Files</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/kickstart">Kickstarting OpenSolaris on PowerPC</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/status">Status</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/task_map">Project Task Map</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/atomic">Low Level Atomic Operations</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/bld_env">GNU Toolchain and Host Environment</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/boot_ldr">Bootloader &#45; Net/Disc</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/cache_behav">Cache Behavior</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/cbe">Cyclic Backend &#45; Timers</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/chk_res">Checkpoint and Restore</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/console">Console Items</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/ctf">CTF &#45; Compressed Text Format</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/ddi">DDI &#45; Device Driver Interface</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/dtrace">DTrace</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/hw_tools">Hardware Tools for the Target</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/inst">Installer</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/ism">ISM</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/kern_init">Kernel Inititalization</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/kmdb_mdb">KMDB / MDB / PMDB</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/krn_swtch">Kernel  Context Switching</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/krtld">Kernel Runtime Loader</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/modstubs">Module Stubs</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/mp">MP Support</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/openfirm">Openfirmware &#45; VOF</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/panic">Panic Handling</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/psm">Platform Specific Modules</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/root_nex">Root Nexus</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/rtld_ld">RTLD and ld</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/sys_calls">System Calls</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/traps">Exceptions, Traps and Interrupts</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/usr_libs">User Libraries</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/usr_swtch">User Context Switching</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/vm">Virtual Memory &#45; HAT</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/tools">Project Tools</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Project+ppc%2Ddev/proj_xtra">Project Extras</a></span></li>
</ul></li>
</ul>
                    </div>
</div>
      </div>

  </div>
<div class="clearfloats"></div>
  </div></div><div id="footerglobal" class="layoutsection">
<div class="minwidth"></div>
<hr/>
        <div id="xwikiplatformversion">XWiki Enterprise 2.7.1.34853 - <a onclick="openURL('http://enterprise.xwiki.org/xwiki/bin/view/Main/Documentation', '_blank'); return false;" href="http://www.xwiki.org/xwiki/bin/view/Main/Documentation">Documentation</a></div>
<br/>
  
      <div id="footer">
    <p>
                <a href="https://markebrooks.github.io/bin/view/Main/tou/">Terms of Use</a>
                |
                <a href="http://www.oracle.com/html/privacy.html">Privacy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/trademark/">Trademarks</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/copyrights/">Copyright Policy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site_guidelines/">Site Guidelines</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site-map/">Site Map</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/help/">Help</a>
                <br/>Your use of this web site or any of its content or software indicates your agreement to be bound by these Terms of Use.<br/>
                &copy; 2011, Oracle Corporation and/or its affiliates.<br/><img src="https://markebrooks.github.io:443/static/images/logo_oracle_footer.gif" alt="Oracle Logo"/>
            </p>
        </div>

  
</div>

</div></div></body>
</html>
