<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                                    <title>Solaris10-Branded Zone Developer Guide (Community Group zones.s10brand_dev_guide) - XWiki</title>
                <meta http-equiv="Content-Script-Type" content="text/javascript" />
                        <meta http-equiv="imagetoolbar" content="no"/>
                      <link rel="alternate" type="application/x-wiki" title="Edit" href="/bin/edit/Community+Group+zones/s10brand_dev_guide" />
                    <link rel="canonical" href="/bin/view/Community+Group+zones/s10brand_dev_guide" />
                            <meta name="document" content="Community Group zones.s10brand_dev_guide"/>
    <meta name="wiki" content="xwiki"/>
    <meta name="space" content="Community Group zones"/>
    <meta name="page" content="s10brand_dev_guide"/>
    <meta name="version" content="16.1"/>
    <meta name="restURL" content="/rest/wikis/xwiki/spaces/Community+Group+zones/pages/s10brand_dev_guide"/>
                <meta name="gwt:property" content="locale=en" />
                <meta name="revisit-after" content="7 days" />
<meta name="description" content="Solaris10-Branded Zone Developer Guide" />
<meta name="keywords" content="wiki " />
<meta name="distribution" content="GLOBAL" />
<meta name="rating" content="General" />
<meta name="author" content="flippedb" />
<meta http-equiv="reply-to" content="" />
<meta name="language" content="en" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="alternate" type="application/rss+xml" title="Wiki Feed RSS" href="/bin/view/Main/WebRss?xpage=rdf" />
<link rel="alternate" type="application/rss+xml" title="Blog RSS Feed" href="/bin/view/Blog/GlobalBlogRss?xpage=plain" />
<link rel="shortcut icon" href="/resources/icons/oso/icon.png">
                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
<link href="https://markebrooks.github.io/static/css/stylesheet.css" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/style.css?colorTheme=ColorThemes.Oso" rel="stylesheet" type="text/css" media="all" />
<link href="/bin/skin/skins/colibri/print.css" rel="stylesheet" type="text/css" media="print" />
        <!--[if IE]>
  <link href="/bin/skin/skins/colibri/ie%2Dall.css" rel="stylesheet" type="text/css" />
<![endif]-->
<!--[if IE 6]>
  <link href="/bin/skin/skins/colibri/ie%2D6.css" rel="stylesheet" type="text/css" />
<![endif]-->
<link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Settings?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/AnnotationCode/Style?language=en'/><link rel='stylesheet' type='text/css' href='/bin/ssx/XWiki/SharePage?language=en'/>
<link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/modalPopup.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/js/xwiki/widgets/jumpToPage.css?language=en'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/confirmationBox.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/resources/uicomponents/widgets/notification.css'/><link rel='stylesheet' type='text/css' href='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.css'/>

    
    <link href="/bin/skin/resources/js/xwiki/suggest/ajaxSuggest.css" rel="stylesheet" type="text/css" />
<link href="/bin/skin/resources/js/xwiki/lightbox/lightbox.css" rel="stylesheet" type="text/css" />
<!--[if IE]>
  <link href="/bin/skin/resources/js/xwiki/lightbox/lightboxIE.css" rel="stylesheet" type="text/css" />
<![endif]-->












<script type="text/javascript" src="/resources/js/prototype/prototype.js"></script>
<script type="text/javascript" src="/bin/skin/resources/js/xwiki/xwiki.js"></script>
<script type="text/javascript">
// <![CDATA[
XWiki.webapppath = "";
XWiki.servletpath = "bin/";
XWiki.contextPath = "";
XWiki.mainWiki = "xwiki";
XWiki.currentWiki = "xwiki";
XWiki.currentSpace = "Community Group zones";
XWiki.currentPage = "s10brand_dev_guide";
XWiki.editor = "";
XWiki.viewer = "";
XWiki.contextaction = "view";
XWiki.docisnew = false;
XWiki.docsyntax = "xwiki/2.0";
XWiki.blacklistedSpaces = [ "Import","Panels","Scheduler","Stats","XAppClasses","XAppSheets","XAppTemplates","XWiki","WatchCode","WatchSheets","XApp","WatchAdmin","Watch","ColorThemes","AnnotationCode" ];
XWiki.hasEdit = false;
XWiki.hasProgramming = false;
XWiki.hasBackupPackImportRights = false;
window.docviewurl = "/bin/view/Community+Group+zones/s10brand_dev_guide";
window.docediturl = "/bin/edit/Community+Group+zones/s10brand_dev_guide";
window.docsaveurl = "/bin/save/Community+Group+zones/s10brand_dev_guide";
window.docgeturl = "/bin/get/Community+Group+zones/s10brand_dev_guide";
// ]]>
</script>
<script type='text/javascript' src='/bin/skin/resources/js/scriptaculous/effects.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/modalPopup.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/js/xwiki/widgets/jumpToPage.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmationBox.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/confirmedAjaxRequest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/resources/uicomponents/widgets/notification.js' defer='defer'></script>
<script type='text/javascript' src='/resources/uicomponents/widgets/list/xlist.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/suggest/ajaxSuggest.js' defer='defer'></script>
<script type='text/javascript' src='/bin/skin/skins/colibri/resources/uicomponents/viewers/tags.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/scriptaculous/scriptaculous.js' defer='defer'></script>
<script type='text/javascript' src='/resources/js/xwiki/accordion/accordion.js' defer='defer'></script>

<script type='text/javascript' src='/bin/jsx/XWiki/WebDAV?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Settings?language=en' defer='defer'></script>
<script type='text/javascript' src='/bin/jsx/AnnotationCode/Script?language=en' defer='defer'></script>

<script type="text/javascript" src="/resources/js/xwiki/compatibility.js" defer="defer"></script>

  </head>
  <body id="body" class="wiki-xwiki space-Community_Group_zones viewbody hideright">
<div id="xwikimaincontainer">
<div id="xwikimaincontainerinner">

  <div id="menuview">
    <div id="mainmenu" class="layoutsubsection actionmenu">
<strong id="xwikimenutitle" class="hidden">General Actions:</strong>
<div class="rightmenu">
      <div id="tmLogin" class="tmLogin topmenuentry ">
   <a class="tme" href="https://auth.opensolaris.org/login.action?targetUrl=http%3A%2F%2Fmarkebrooks.github.io%2Fbin%2Fview%2FCommunity%2BGroup%2Bzones%2Fs10brand_dev_guide%3Flanguage%3Den"><strong>Log-in</strong></a>
  </div>
  </div>
<div class="leftmenu">
  <div id="tmWiki" class="tmWiki topmenuentry hasIcon">
   <a class="tme" href="/bin/view/Main/"><strong>Wiki</strong></a>
  </div>
  <div id="tmSpace" class="tmSpace topmenuentry dropdownmenuentry  hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Community+Group+zones/"><strong>Community Group zones</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
                <span class="submenuitem "><a href="/bin/view/Main/SpaceIndex?space=Community+Group+zones" id="tmSpaceDocumentIndex" class="tmSpaceDocumentIndex">Document Index</a></span>
    </span></div>

<div id="tmSubSites" class="tmSubSites topmenuentry dropdownmenuentry dropdownnolink hasIcon" onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Subsites</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem hasIcon"><a href="https://cr.opensolaris.org/" id="tmCR" class="tmCR">Code Reviews</a></span>
<span class="submenuitem hasIcon"><a href="http://repo.opensolaris.org/" id="tmRepo" class="tmRepo">SCM Management</a></span>
<span class="submenuitem hasIcon"><a href="http://pkg.opensolaris.org/" id="tmPkg" class="tmPkg">Package Search</a></span>
<span class="submenuitem hasIcon"><a href="http://bugs.opensolaris.org/" id="tmBugs" class="tmBugs">Bugster</a></span>
<span class="submenuitem hasIcon"><a href="http://defect.opensolaris.org/" id="tmDefect" class="tmDefect">Bugzilla</a></span>
<span class="submenuitem hasIcon"><a href="http://test.opensolaris.org/" id="tmTest" class="tmTest">Test Machines</a></span>
<span class="submenuitem hasIcon"><a href="http://planet.opensolaris.org/" id="tmPlanet" class="tmPlanet">Planet</a></span>
<span class="submenuitem hasIcon"><a href="http://mail.opensolaris.org/" id="tmMail" class="tmMail">Mailing Lists</a></span>
<span class="submenuitem hasIcon"><a href="http://poll.opensolaris.org/" id="tmPoll" class="tmPoll">Elections &amp; Polls</a></span>
<span class="submenuitem hasIcon"><a href="http://arc.opensolaris.org/" id="tmArc" class="tmArc">ARC Case Logs</a></span>
<span class="submenuitem hasIcon"><a href="http://jucr.opensolaris.org/" id="tmJucr" class="tmJucr">Source Juicer</a></span>
<span class="submenuitem hasIcon"><a href="http://pkgfactory.opensolaris.org/" id="tmPkgfactory" class="tmPkgfactory">Package Factory</a></span>
<span class="submenuitem hasIcon"><a href="http://auth.opensolaris.org/" id="tmAuth" class="tmAuth">Auth</a></span>
</span></div>

</div>
</div>

  </div>
 <div id="header" class="layoutsection">
<div class="minwidthb"></div>

  <div id="header">
    <table style="width: 100%;">
        <tr>
            <td style="width: 1%;">
                 <a href="https://markebrooks.github.io/bin/view/Main/"><div id="logo"></div></a>  
            </td>
            <td id="logo-text" style="width: 1%;">
                Solaris
            </td>         
            <td style="width: 98%;">
                <table id="loading-indicator">
                    <tr>
                        <td><img src="https://markebrooks.github.io:443/static/images/busy.gif"
                                 alt="Loading" title="Loading"/></td>
                        <td>Loading...</td>
                    </tr>
                </table>
            </td>
            <td style="width: 1%;">
                <table id="iconbar">
                    <tr>
                    <td><a id="collectives-icon" href="https://markebrooks.github.io/bin/view/Main/collectives">
                        Collectives</a></td>
                    <td><a id="discussions-icon" href="https://markebrooks.github.io/bin/view/Main/discussions">
                            Discussions</a></td>
                    <td><a id="documentation-icon" href="https://markebrooks.github.io/bin/view/Main/documentation">
                            Documentation</a></td>
                    <td><a id="download-icon" href="https://markebrooks.github.io/bin/view/Main/downloads">
                            Download</a></td>
                    <td><a id="source-browser-icon" href="http://src.opensolaris.org/source">
                            Source Browser</a></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

 </div> 
  <div id="globallinks">
    <form action="/bin/view/Main/Search">
      <div class="globalsearch">
        <label class="hidden" for="headerglobalsearchinput">Search</label><input class="globalsearchinput withTip" id="headerglobalsearchinput" type="text" name="text" value="search..." size="15"/><input class="button" type="image" value="Go" alt="Go" src="/resources/icons/xwiki/search.png"/>
      </div>
    </form>
  </div> <div style="float:left;">

                

   <div id="hierarchy">
                  <span class='current'>Solaris10-Branded Zone Developer Guide</span>
          </div>

</div>
  <span class="glink" id="headerlanguages" style="float:right">
        <a href="/bin/view/Community+Group+zones/s10brand_dev_guide?language=en" class="language-default language-current">en</a>
    </span>


<div class="contenthideright" id="contentcontainer">
<div id="contentcontainerinner">
<div class="leftsidecolumns">
  <div id="contentcolumn"> 
          <div class="main layoutsubsection">
      <div id="contentmenu" class="actionmenu">
    <strong id="xwikicontentmenutitle" class="hidden">Page Actions:</strong>
<div class="rightmenu">
</div>
<div class="leftmenu">
  <div id="tmExport" class="tmExport topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>Export</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/export/Community+Group+zones/s10brand_dev_guide?format=pdf&amp;language=en" id="tmExportPdf" class="tmExportPdf">Export as PDF</a></span>
  <span class="submenuitem "><a href="/bin/export/Community+Group+zones/s10brand_dev_guide?format=rtf&amp;language=en" id="tmExportRtf" class="tmExportRtf">Export as RTF</a></span>
  <span class="submenuitem "><a href="/bin/export/Community+Group+zones/s10brand_dev_guide?format=html&amp;language=en" id="tmExportHtml" class="tmExportHtml">Export as HTML</a></span>
    </span></div>

<div id="tmShow" class="tmShow topmenuentry dropdownmenuentry  " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme" href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=code&amp;language=en"><strong>View</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
<span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=comments&amp;language=en" id="tmViewComments" class="tmViewComments">Comments</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=attachments&amp;language=en" id="tmViewAttachments" class="tmViewAttachments">Attachments</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=history&amp;language=en" id="tmViewHistory" class="tmViewHistory">History</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=information&amp;language=en" id="tmViewInformation" class="tmViewInformation">Information</a></span>
<span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?viewer=code&amp;language=en" id="tmViewSource" class="tmViewSource">View Source</a></span>
</span></div>

  <div id="tmMoreActions" class="tmMoreActions topmenuentry dropdownmenuentry dropdownnolink " onmouseover="showsubmenu(this);" onmouseout="hidesubmenu(this);">
<span class="tme-extensible">
   <a class="tme"><strong>More actions</strong></a>
    <span class="hidden menucolon">: </span>
</span><span class="submenu hidden">
  <span class="submenuitem "><a href="/bin/view/Community+Group+zones/s10brand_dev_guide?xpage=print&amp;language=en" id="tmPrintPreview" class="tmPrintPreview">Print preview</a></span>
          </span></div>
</div>

    </div>
    <div id="mainContentArea">
      








    
<div id="document-title"><h1>Solaris10-Branded Zone Developer Guide</h1></div>





              <div id="document-info">
    <div>
          </div>
    <div class="clearfloats"></div>
  </div>

<div id="xwikicontent">
<h1 id="HSolaris10-BrandedZoneDeveloperGuide"><span><em>Solaris10</em>-Branded Zone Developer Guide</span></h1><p>This guide familiarizes readers with the <em>solaris10</em> zone brand, which allows OpenSolaris administrators to create <span class="wikilink"><a href="/bin/view/Project+s10brand/">Solaris 10 Containers</a></span>. The guide explains how the brand affects Solaris development and how developers can enhance the brand so that it can cope with changes to Solaris 10 and OpenSolaris. This document is aimed at all Solaris kernel developers whose work might affect the <em>solaris10</em> brand's functionality. (The <span class="wikilink"><a href="#HIntroduction">introduction</a></span> and the section entitled "<span class="wikilink"><a href="#HWhatkindsofchangestoOpenSolarisandSolaris10canbreakthesolaris10brand">What kinds of changes to OpenSolaris and Solaris 10 might break the <em>solaris10</em> brand?</a></span>" delineate the kinds of projects and fixes that are impacted.)</p><p>Note that this is a living document: The guide changes as the Solaris 10 Containers development team receives feedback from readers. Please send questions, comments, suggestions, and corrections to <span class="wikiexternallink"><a href="mailto:zones-discuss@opensolaris.org">zones-discuss@opensolaris.org</a></span>. Please ensure that your emails' subject lines start with "S10C Dev Guide" if the emails specifically address this guide.</p><h1 id="HTableofContents"><span>Table of Contents</span></h1><ol><li><span class="wikilink"><a href="#HSolaris10-BrandedZoneDeveloperGuide">Solaris10-Branded Zone Developer Guide</a></span></li><li><span class="wikilink"><a href="#HTableofContents">Table of Contents</a></span><ol><li><span class="wikilink"><a href="#HIntroduction">Introduction</a></span><ol><li><span class="wikilink"><a href="#HWhatarezones3F">What are zones?</a></span></li><li><span class="wikilink"><a href="#HWhatarebrandedzones3F">What are branded zones?</a></span></li><li><span class="wikilink"><a href="#HWhataresolaris10-brandedzones3F">What are solaris10-branded zones?</a></span></li><li><span class="wikilink"><a href="#HWhyshouldIcareaboutsolaris10-brandedzones3F">Why should I care about solaris10-branded zones?</a></span></li><li><span class="wikilink"><a href="#HDoestheSolarisABItakecareofthisforme3F">Does the Solaris ABI take care of this for me?</a></span></li><li><span class="wikilink"><a href="#HDoesthisrestrictmyabilitytoinnovateormakeincompatiblechanges3F">Does this restrict my ability to innovate or make incompatible changes?</a></span></li></ol></li><li><span class="wikilink"><a href="#HWhatkindsofchangestoOpenSolarisandSolaris10canbreakthesolaris10brand3F">What kinds of changes to OpenSolaris and Solaris 10 can break the solaris10 brand?</a></span></li><li><span class="wikilink"><a href="#HWhattechniquescanbeusedtomakesolaris10-brandedzonesworkwithmychanges3F">What techniques can be used to make solaris10-branded zones work with my changes?</a></span></li><li><span class="wikilink"><a href="#HWhereisthesourcecode3F">Where is the source code?</a></span></li><li><span class="wikilink"><a href="#HHowdoessystemcallemulationworkinthesolaris10brand3F">How does system call emulation work in the solaris10 brand?</a></span></li><li><span class="wikilink"><a href="#HHowcanIaddtoorupdatetheemulation3F">How can I add to or update the emulation?</a></span><ol><li><span class="wikilink"><a href="#HEmulatingaSystemCall">Emulating a System Call</a></span><ol><li><span class="wikilink"><a href="#HAnExample">An Example</a></span></li></ol></li><li><span class="wikilink"><a href="#HEmulatinganIoctl">Emulating an Ioctl</a></span></li><li><span class="wikilink"><a href="#HGeneralEmulationTechniques">General Emulation Techniques</a></span><ol><li><span class="wikilink"><a href="#HIssuingSystemCallswithinEmulationFunctions">Issuing System Calls within Emulation Functions</a></span><ol><li><span class="wikilink"><a href="#HAnExample-1">An Example</a></span></li></ol></li><li><span class="wikilink"><a href="#HInsertingtrussPoints">Inserting truss Points</a></span><ol><li><span class="wikilink"><a href="#HAnExample-2">An Example</a></span></li></ol></li><li><span class="wikilink"><a href="#HCopyingMemory">Copying Memory</a></span><ol><li><span class="wikilink"><a href="#HAnExample-3">An Example</a></span></li></ol></li><li><span class="wikilink"><a href="#HModifyingParameterStructures">Modifying Parameter Structures</a></span><ol><li><span class="wikilink"><a href="#HAnExample-4">An Example</a></span></li></ol></li><li><span class="wikilink"><a href="#HProducingArchitecture-SpecificCode">Producing Architecture-Specific Code</a></span></li></ol></li><li><span class="wikilink"><a href="#HGeneralEmulationConsiderations">General Emulation Considerations</a></span></li></ol></li><li><span class="wikilink"><a href="#HHowcanIsetupthebrandtouseanativecommand3F">How can I set up the brand to use a native command?</a></span><ol><li><span class="wikilink"><a href="#HANoteConcerningSplitBinaries">A Note Concerning Split Binaries</a></span></li></ol></li><li><span class="wikilink"><a href="#HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation3F">How is versioning handled for different Solaris 10 updates or patches running in the zone when they need different emulation?</a></span><ol><li><span class="wikilink"><a href="#HAnExample-5">An Example</a></span></li><li><span class="wikilink"><a href="#HDynamicFeatureDetection:SysentTablePatching">Dynamic Feature Detection: Sysent Table Patching</a></span></li></ol></li><li><span class="wikilink"><a href="#HWhatistheprocedureforbackportinganincompatiblechangetoaSolaris10updaterelease3F">What is the procedure for backporting an incompatible change to a Solaris 10 update release?</a></span></li><li><span class="wikilink"><a href="#HHowcanItestmyOpenSolarischangeswiththebrand3F">How can I test my OpenSolaris changes with the brand?</a></span><ol><li><span class="wikilink"><a href="#HRundo-it-yourself28DIY29tests">Run do-it-yourself (DIY) tests</a></span></li><li><span class="wikilink"><a href="#HManuallysetupazoneonatestsystemandtestyourchanges">Manually set up a zone on a test system and test your changes</a></span><ol><li><span class="wikilink"><a href="#HManuallytestyourchanges">Manually test your changes</a></span></li><li><span class="wikilink"><a href="#HRunalloftherelevantPITtestsorjusttheMSTCportion">Run all of the relevant PIT tests or just the MSTC portion</a></span></li></ol></li></ol></li><li><span class="wikilink"><a href="#HHowcanItestmySolaris10changeswiththebrand3F">How can I test my Solaris 10 changes with the brand?</a></span></li></ol></li></ol><h2 id="HIntroduction"><span>Introduction</span></h2><p>This section introduces <em>solaris10</em>-branded zones by providing brief overviews of zones, branded zones, what <em>solaris10</em>-branded zones do, and the reasons why Solaris kernel developers should take <em>solaris10</em>-branded zones into consideration when fixing bugs or adding new features to Solaris 10 or OpenSolaris.</p><h3 id="HWhatarezones3F"><span>What are zones?</span></h3><p><em>Solaris Zones</em> (also known as <em>Solaris Containers</em> or simply <em>zones</em>) are lightweight virtual machines that isolate user-level workloads on Solaris systems. They differ markedly from virtual machines created with other virtualization technologies such as <span class="wikilink"><a href="/bin/view/Community+Group+xen/">Xen</a></span>, <span class="wikiexternallink"><a href="http://www.virtualbox.org">VirtualBox</a></span>, and <span class="wikilink"><a href="/bin/view/Community+Group+ldoms/">Logical Domains (LDoms)</a></span> in that zones do not rely on hypervisors to provide abstracted hardware resources and isolate themselves from the native host system and each other. Zones are built into the Solaris kernel and many of the kernel's subsystems are zone-aware (i.e., they associate their abstractions with zones and base decisions in part on such associations). Consequently, processes executing within zones experience little overhead (a high estimate is 5% of total execution time) and thus come close to achieving bare-metal performance. Furthermore, the lack of overhead makes zones highly scalable: Even low-end consumer desktops are capable of running dozens of zones at a time. The noticeable lack of execution overhead experienced by zoned processes, the relative ease of zone creation and management, and the maturity of zones technology make zones one of the most popular virtualization technologies (if not <em>the</em> most popular virtualization technology) supported on Solaris 10 and OpenSolaris.</p><p>However, zones have a few well-known, fundamental limitations. Zones cannot host processes running programs compiled for non-native architectures because zones lack hypervisors. Furthermore, not all Solaris kernel subsystems are zone-aware, which limits the kinds of resources that can be fully isolated and supported within zones. Finally, ordinary zones cannot host user environments from non-native operating systems (OSes). The last limitation is largely eliminated through the use of <em>branded zones</em>, which will be discussed shortly.</p><p>You can learn more about zones by visiting the <span class="wikilink"><a href="/bin/view/Community+Group+zones/">OpenSolaris.org Zones Community Page</a></span>, the <span class="wikiexternallink"><a href="http://www.sun.com/bigadmin/content/zones/index.jsp">Solaris Containers BigAdmin Page</a></span>, or the <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/817-1592/zone">zones chapter of the <em>System Administration Guide</em> on docs.sun.com</a></span> (Solaris 10 only).</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HWhatarebrandedzones3F"><span>What are branded zones?</span></h3><p><em>Branded zones</em> are zones that are capable of emulating user environments from OSes other than Solaris 10 and OpenSolaris. Branded zones achieve this by emulating the non-native OSes' system calls (syscalls). Syscalls constitute the sole interface between user environments and kernels; therefore, if a branded zone emulates syscalls such that they have the same side effects as the syscalls of a particular non-native OS (e.g., Linux 2.4), then processes running within the zone will act as though they are running on the targeted non-native OS. A branded zone's <em>brand</em> is the collection of support libraries, support hooks, and auxiliary data files that make emulating the zone's targeted OS possible. Brands are named after the OSes whose syscalls they emulate. For example, there are <em>solaris8</em> and <em>solaris9</em> brands on Solaris 10 that allow Solaris 10 zones to host Solaris 8 and Solaris 9 user environments, respectively. Zones that host native Solaris user environments (i.e., zones that lack syscall emulation) are <em>native</em>-branded zones (often simply called <em>native zones</em>). (OpenSolaris' native zones currently use the <em>ipkg</em> brand.)</p><p>Maintaining brands can be incredibly difficult. Changes in Solaris syscalls' semantics (i.e., their parameters and side effects) can break emulation provided by brands if the brands' support libraries are not updated to account for the changes. Similarly, changes in non-native OSes' syscalls' semantics can break the emulation provided by brands. Maintaining a brand is especially difficult when the user-kernel interfaces exported by both the native Solaris kernel and the hosted non-native OS are continually in flux (as would be the case if we were to maintain a brand for the latest development releases of Linux 2.6 on OpenSolaris).</p><p>You can learn more about branded zones and the framework that makes them possible by visiting the <span class="wikilink"><a href="/bin/view/Community+Group+brandz/">OpenSolaris.org BrandZ Community Page</a></span>, which describes the brand framework and the <em>lx</em> [Linux 2.4] brand on OpenSolaris, or the <span class="wikiexternallink"><a href="http://www.sun.com/bigadmin/content/zones/index.jsp">Solaris Containers BigAdmin Page</a></span>.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HWhataresolaris10-brandedzones3F"><span>What are <em>solaris10</em>-branded zones?</span></h3><p><em>solaris10</em>-branded zones host Solaris 10 (S10) user environments inside zones on OpenSolaris. They are meant to help maintainers of Solaris 10 systems consolidate their production environments onto systems running OpenSolaris. Workloads running within <em>solaris10</em>-branded zones can take advantage of the performance improvements made to the OpenSolaris kernel and utilize some of the innovative technologies available only on OpenSolaris (e.g., Crossbow VNICs). Only Solaris 10u8 and beyond are supported and tested in such zones.</p><p>Ultimately, the purpose of <em>solaris10</em>-branded zones is to provide the proper emulation for Solaris 10 processes running inside the zones so that they work correctly with the OpenSolaris kernel. This is summarized in the following principle, which should serve as a guide for enhancing and maintaining <em>solaris10</em>-branded zones: <strong>Any script or program that works in native Solaris 10 zones should also work in <em>solaris10</em>-branded zones.</strong></p><p>You can learn more about the <em>solaris10</em> brand and track the project's progress by visiting the <span class="wikilink"><a href="/bin/view/Project+s10brand/">OpenSolaris.org <em>solaris10</em> Brand Project Page</a></span>.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HWhyshouldIcareaboutsolaris10-brandedzones3F"><span>Why should I care about <em>solaris10</em>-branded zones?</span></h3><p>Because a <em>solaris10</em>-branded zone is running Solaris 10 user-level binaries on top of the OpenSolaris kernel, mismatches in the user-kernel interfaces provided by both systems are possible. This does not happen within normal OpenSolaris zones (i.e., native OpenSolaris zones) because such zones run OpenSolaris user-level binaries, which are built to run in sync with the OpenSolaris kernel. If you make changes to either OpenSolaris or Solaris 10 that impact their user-kernel boundaries, then you will have to take <em>solaris10</em>-branded zones into consideration. If your changes break the emulation provided by <em>solaris10</em>-branded zones, then you will have to enhance the brand's emulation layer so that it can cope with such changes. OpenSolaris community contribution sponsors should ensure that ON contributions will not break the <em>solaris10</em> brand.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HDoestheSolarisABItakecareofthisforme3F"><span>Does the Solaris ABI take care of this for me?</span></h3><p>No. The ABI deals with published, well-documented interfaces such as those provided by libc and documented in the <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5167">section 2 man pages</a></span>. The <em>solaris10</em> brand must deal with undocumented, unstable interfaces such as how libc traps into the kernel. Normally changes to such interfaces are hidden within libraries such as libc in a compatible way so that applications don't notice them. However, <em>solaris10</em>-branded zones run the Solaris 10 version of libc (as well as other Solaris 10 libraries), which is not built to work with the OpenSolaris kernel. Therefore, the brand emulation layer is needed to translate between the Solaris 10 user level code and the OpenSolaris kernel code.</p><p>Here is a simple example: <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2241/issetugid-2"><tt>issetugid(2)</tt></a></span> is a libc function whose semantics haven't changed between Solaris 10 and OpenSolaris. However, Solaris 10's libc invokes the <tt>SYS_issetugid</tt> syscall (syscall number 75), which doesn't take arguments, while OpenSolaris' libc invokes the <tt>SYS_privsys</tt> syscall (number 82), which takes six arguments. Furthermore, the OpenSolaris kernel replaced <tt>SYS_issetugid</tt> with <tt>SYS_sidsys</tt>, which has radically different semantics. Consequently, if a Solaris 10 process linked with the Solaris 10 libc running on top of the OpenSolaris kernel were to invoke <tt>issetugid(2)</tt>, then it would issue the wrong syscall. This might result in the Solaris 10 process dumping core or producing incorrect results. The solution is to emulate the Solaris 10 <tt>SYS_issetugid</tt> syscall so that <tt>SYS_privsys</tt> is issued instead (with proper arguments, of course).</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HDoesthisrestrictmyabilitytoinnovateormakeincompatiblechanges3F"><span>Does this restrict my ability to innovate or make incompatible changes?</span></h3><p>No. The purpose of <em>solaris10</em>-branded zones is to translate between the old Solaris 10 code running within them and the new OpenSolaris kernel. There are existing proofs of concept with the <em>lx</em> brand running Linux on Solaris 10 and OpenSolaris as well as the <em>solaris8</em> and <em>solaris9</em> brands running those releases on Solaris 10. The capability to run Linux on OpenSolaris did not stop developers from creating ZFS, DTrace, or Crossbow (to name just a few prominent examples of Solaris innovation). You can continue to make new, innovative changes to OpenSolaris, but you will have to take the <em>solaris10</em> brand into account during your development and you may need to modify the brand so that <em>solaris10</em>-branded zones continue to work with your innovation. This guide tells you how to do this.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HWhatkindsofchangestoOpenSolarisandSolaris10canbreakthesolaris10brand3F"><span>What kinds of changes to OpenSolaris and Solaris 10 can break the <em>solaris10</em> brand?</span></h2><p>Changes that cross the user-kernel boundary affect <em>solaris10</em>-branded zones. In other words, beware all changes that cause <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/tools/scripts/Install.1">cap-I Install(1)</a></span> <span class="wikilink"><a href="/bin/view/Community+Group+on/flag%2Ddays">flag days</a></span>. The following list details these kinds of changes:</p><ul><li><strong>Changes in syscalls</strong><br/>Does the change touch <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/os/sysent.c"><tt>usr/src/uts/common/os/sysent.c</tt></a></span>? If a new syscall is added, then there probably will not be an issue. If an existing syscall is removed or changed then the change will likely impact the brand. Likewise for syscall parameters: if a syscall's parameters' structures or semantics change, then the brand will almost certainly be impacted.</li><li><strong>Changes in ioctls</strong><br/>Changes in ioctl commands or parameters for devices that are accessible within zones will likely impact the brand. Disks and NICs are the devices most commonly added to zone configurations. Exclusive-stack zones, which have dedicated NIC devices and are responsible for their administration, are expected to be ubiquitous on OpenSolaris because VNICs and the Crossbow project provide a wealth of interesting networking options for branded zones. Explorer data suggest that it is uncommon for other devices to be configured inside zones.<br/><br/>The following list contains the devices available to <em>solaris10</em>-branded zones by default:<ul><li>arp, conslog, console, cpu/self/cpuid, crypto, cryptoadm, dtrace/dtrace, dtrace/helper, dtrace/provider/*, fd/*, ipnet/{netif}, ipnet/lo0, kstat, lo0, log, logindmux, msglog, net/{netif}, null, openprom, poll, pool, ptmx, pts/*, random, sad/user, stderr, stdin, stdout, syscon, sysevent, sysmsg, systty, tcp, tcp6, ticlts, ticots, ticotsord, tty, udp, udp6, urandom, zconsole, zero, zfs</li></ul></li><li><strong>Changes in libraries</strong><br/>Bugfixes and projects that modify libraries that interact closely with the kernel could impact the brand. The following are examples of such libraries:<ul><li>libaio.so (a real library in s10)</li><li>libbc.so</li><li>libbsm.so</li><li>libc.so</li><li>libc_db.so</li><li>libcontract.so</li><li>libdlpi.so</li><li>libdoor.so</li><li>libdtrace.so</li><li>libkstat.so</li><li>libpkcs11.so (CRYPTO_GET_FUNCTION_LIST ioctl)</li><li>libproc.so</li><li>libproject.so</li><li>librt.so (a real library in s10)</li><li>librtld_db.so</li><li>libzfs.so</li></ul></li><li><strong>Changes in signals</strong><br/>There have been no signal changes between Solaris 10 and OpenSolaris. However, making such changes could impact the brand. For example, Solaris 10 changed the range for real time signals, which forced <em>solaris8</em> and <em>solaris9</em> branded zones to emulate the Solaris 8 and 9 real time signal ranges.</li><li><strong>Changes in auditing or accounting</strong><br/>If auditing or accounting change in an incompatible way, then the brand could be impacted. Although this has not occurred between Solaris 10 and OpenSolaris, this was an issue for the <em>solaris8</em> brand on Solaris 10 and could become a problem for the <em>solaris10</em> brand if such a change were made to Solaris 10 or OpenSolaris.</li><li><strong>Changes in /proc</strong><br/>Changes in the /proc file system or libproc can impact the ptools and other commands linked with libproc. At this point there have been no /proc changes that need emulation but the <em>lx</em> brand does provide /proc emulation and this could be done for the <em>solaris10</em> brand in the future if necessary.</li><li><strong>Changes in native commands or daemons used within <em>solaris10</em>-branded zones</strong><br/>If an OpenSolaris command or daemon (both will hereafter be simply referred to as 'commands' for brevity's sake) that replaces a command within a <em>solaris10</em>-branded zone is changed, then backwards compatibility with the replaced Solaris 10 command could break. Changes to such commands must be made such that the requirements for the commands to be used within <em>solaris10</em>-branded zones continue to be satisfied. (See "Use native commands or daemons" under "<span class="wikilink"><a href="#HWhattechniquescanbeusedtomakesolaris10brandedzonesworkwithmychanges">What techniques can be used to make <em>solaris10</em>-branded zones work with my changes?</a></span>" below for the list of requirements.)<br/><br/>The following native commands are used within <em>solaris10</em>-branded zones:<ul><li>automount</li><li>automountd</li><li>ifconfig</li></ul></li><li><strong>Changes in kstats</strong><br/>kstats are generally private and unstable; however, they are consumed by various user-level utilities. If the kstats on which Solaris 10 utilities depend are removed or changed, then those utilities could break. If this happens, one option is to use the the native version of the utility in place of the Solaris 10 version. This issue is currently hypothetical: No kstat issues have been observed.<br/><br/>The following utilities use various kstats:<ul><li><tt>dladm</tt>: name:mac</li><li><tt>fssnap</tt>: mod:fssnap, name: highwater</li><li><tt>fsstat</tt>: variety</li><li><tt>fuser</tt>: mod:unix, name:var</li><li><tt>in.routed</tt>: class:net</li><li><tt>iostat</tt>: mod:cpu_info; mod:cpu, name:vm; mod:cpu, name:sys; mod:unix, name:system_misc, statistic:clk_intr</li><li><tt>mibiisa</tt>: name:mac</li><li><tt>mpstat</tt>: mod:cpu_info; mod:cpu, name:vm; mod:cpu, name:sys; mod:unix, name:system_misc, statistic:clk_intr</li><li><tt>netstat</tt>: class:net; mod:sockfs, name:sock_unix_list</li><li><tt>nfsstat</tt>: mod:unix, name:rpc_*; mod:nfs, name:nfs_client; mod:nfs, name:nfs_server; mod:nfs, name:rfs*; mod:nfs_acl, name:acl*</li><li><tt>poolstat</tt>: mod:cpu, name:sys</li><li><tt>psrinfo</tt>: mod:cpu_info</li><li><tt>rpc.rstatd</tt>: mod:unix, name:system_misc; mod:cpu, name:sys; mod:cpu, name:vm; class:disk; class:net</li><li><tt>sar</tt>: mod:unix, name:sysinfo; mod:unix, name:vminfo; mod:unix, name:var; mod:unix, name:system_misc; mod:unix, name:file_cache; mod:ufs, name:inode_cache; mod:vmem, name:kmem_oversize</li><li><tt>sendmail</tt>: mod:unix, name:system_misc, statistic:avenrun_1min</li><li><tt>svc.startd</tt>: mod:unix, name:system_misc, statistic:boot_time</li><li><tt>umount(nfs)</tt>: mod:nfs, name:mntinfo</li><li><tt>vmstat</tt>: mod:cpu_info; mod:cpu, name:vm; mod:cpu, name:sys; mod:unix, name:system_misc, statistic:clk_intr</li></ul></li><li><strong>Changes in supported platforms</strong><br/>If support for a new platform is added to OpenSolaris but is withheld from Solaris 10, then the <em>solaris10</em> brand could be impacted.</li><li><strong>Changes in privileges</strong><br/>If existing privileges are broken up or removed, then the brand could be impacted. Adding new privileges should work because nothing in Solaris 10 should use those privileges and properly written Solaris 10 applications should cope with new, unfamiliar privileges.</li></ul><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HWhattechniquescanbeusedtomakesolaris10-brandedzonesworkwithmychanges3F"><span>What techniques can be used to make <em>solaris10</em>-branded zones work with my changes?</span></h2><ul><li><strong>New features</strong><br/>In general, new features that will only exist in OpenSolaris do not need to work in <em>solaris10</em>-branded zones because Solaris 10 programs and libraries will not expect them. Note that branded zones can leverage new features that are not manageable within their emulated user environments. For example, <em>solaris8</em> branded zones can reside on ZFS and DTrace can be used from the native user environment (a.k.a. the global zone) on the zones' processes. Similarly, <em>solaris10</em>-branded zones can use Crossbow network configurations managed by the global zone.</li><li><strong>Maintain compatibility</strong><br/>Change the interfaces in a backward compatible manner. This is the simplest thing to do and is often the approach a developer automatically uses without even thinking about it.</li><li><strong>Add emulation</strong><br/>The brand module can be enhanced to interpose on syscalls and act as a filter between Solaris 10 and OpenSolaris behaviors. This includes interposing on the ioctl syscall and translating commands and parameters from one format to the other. See "<span class="wikilink"><a href="#HHowcanIaddtoorupdatetheemulation">How can I add or update the emulation?"</a></span> for details about emulating ioctls and syscalls.</li><li><strong>Use native commands or daemons</strong><br/>If the change is in the private interaction between a command or daemon (both will hereafter be simply referred to as 'commands' for brevity's sake) and the kernel where no published API is involved, then the zone can be configured to use the native OpenSolaris command instead of the Solaris 10 command. (See "<span class="wikilink"><a href="#HHowcanIsetupthebrandtouseanativecommand">How can I set up the brand to use a native command?</a></span>" below for details about how to do this.) For example, the native <tt>ifconfig</tt> command can be used to configure network interfaces from within exclusive stack <em>solaris10</em>-branded zones. Syscalls issued by native commands are not emulated.<br/><br/>An OpenSolaris replacement command must meet several requirements:<ol><li>Any related configuration files must be compatible between Solaris 10 and OpenSolaris.</li><li>The replacement command's command line interface (CLI) must be backwards-compatible with that of the replaced command.</li><li>The interprocess communication (IPC) protocols utilized by the replacement command must be backwards-compatible with those of the replaced command. (If they are not, then the commands with which the replaced command communicates can also be replaced by OpenSolaris commands if and only if they also meet these requirements.)</li><li>Scripts, libraries, and executables that expect a particular output format from the replaced Solaris 10 command must be able to parse output provided by the replacement OpenSolaris command. This requirement can be relaxed only if:<ol><li>it is known that the output of the replaced command is never or rarely consumed by scripts, libraries, or other commands and it is acceptable for known consumers to fail to parse such output; or</li><li>it is acceptable for the outputs of some of the replacement program's behaviors to differ from those of the equivalent behaviors in the replaced command and it is acceptable for known consumers to fail to parse such outputs.</li></ol></li><li>If the replacement command modifies environment variables, then it must do so in a backwards-compatible manner.</li><li>The replacement command's network communication protocols must be backwards-compatible with those of the replaced command.</li><li>The replacement command must expect the same file permissions as the replaced command when accessing files.</li></ol></li><li><strong>Keep existing kernel support</strong><br/>If major changes are made to the kernel, it is possible to keep the existing behavior with the solaris10 brand as the only consumer. The brand can be enhanced to interact with the legacy behavior.</li><li><strong>Backport to Solaris 10</strong><br/>The changes can be backported to Solaris 10 and a patch can be produced for use in the zone. The brand can be enhanced to check for certain patches: See the section entitled "<span class="wikilink"><a href="#HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation">How is versioning handled for different Solaris 10 updates or patches running in the zone when they need different emulation?</a></span>" for details.</li><li><strong>Disallow certain configurations</strong><br/>The brand can validate zones and disallow unsupported configurations. For example, if a specific device is problematic, the brand can prevent zones from being configured or from booting with that device. This would only be practical for corner cases.</li><li><strong>Platform-specific libraries</strong><br/>If support is added to OpenSolaris for a new hardware platform but the platform will not be be supported by Solaris 10, then the associated OpenSolaris psr libraries can be installed into <em>solaris10</em>-branded zones from the global zone. Doing so ensures that <em>solaris10</em>-branded zones will be able to function correctly on new platforms.</li></ul><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HWhereisthesourcecode3F"><span>Where is the source code?</span></h2><p>The <em>solaris10</em> brand's source tree is layed out thus:</p><ul><li><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;path=usr/src/lib/brand/solaris10"><tt>usr/src/lib/brand/solaris10</tt></a></span><br/>This directory contains source files for the userland brand emulation library, various <tt>/usr/sbin/zoneadm</tt> and <tt>/usr/lib/zones/zoneadmd</tt> hooks, and auxiliary brand data files.</li><li><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;path=usr/src/lib/brand/solaris10/s10_brand"><tt>usr/src/lib/brand/solaris10/s10_brand</tt></a></span><br/>This directory contains the source files that construct the userland brand emulation library. All <span class="wikilink"><a href="#HHowcanIaddtoorupdatetheemulation">syscall and ioctl emulation</a></span> is defined in here (see <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/brand/solaris10/s10_brand/common/s10_brand.c"><tt>common/s10_brand.c</tt>)</a></span>.</li><li><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;path=usr/src/lib/brand/solaris10/zone"><tt>usr/src/lib/brand/solaris10/zone</tt></a></span><br/>This directory contains various shell scripts and auxiliary data files that serve as zone state transition hooks for <tt>/usr/sbin/zoneadm</tt> and <tt>/usr/lib/zones/zoneadmd</tt>. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/brand/solaris10/zone/s10_boot.ksh"><tt>s10_boot.ksh</tt></a></span> is the <em>solaris10</em> brand's boot hook script: You should modify this file if you plan to <span class="wikilink"><a href="#HHowcanIsetupthebrandtouseanativecommand">use a native OpenSolaris command or daemon</a></span> inside of <em>solaris10</em>-branded zones. <tt>version</tt> specifies the maximum emulation version supported by the <em>solaris10</em> brand. (See the section on <span class="wikilink"><a href="#HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation">emulation versioning</a></span> for details.)</li><li><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;path=usr/src/lib/brand/solaris10/s10_support"><tt>usr/src/lib/brand/solaris10/s10_support</tt></a></span><br/>This directory contains support C functions utilized by <tt>/usr/sbin/zoneadm</tt> and <tt>/usr/lib/zones/zoneadmd</tt>.</li><li><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;path=usr/src/uts/common/brand/solaris10"><tt>usr/src/uts/common/brand/solaris10</tt></a></span><br/>This directory contains source files that constitute the <em>solaris10</em> brand's kernel module, which resides in <tt>/usr/kernel/brand</tt> and <tt>/usr/kernel/brand/amd64</tt> on x86 systems and <tt>/platform/sun4u/kernel/brand/sparcv9</tt> and <tt>/platform/sun4v/kernel/brand/sparcv9</tt> on sparc systems.</li></ul><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowdoessystemcallemulationworkinthesolaris10brand3F"><span>How does system call emulation work in the <em>solaris10</em> brand?</span></h2><p>Syscall emulation is what makes the <em>solaris10</em> brand work. As mentioned in the <span class="wikilink"><a href="#HIntroduction">introduction</a></span>, the syscall interface (which includes ioctls) is the sole interface by which user processes interact with the kernel. By emulating syscalls, the <em>solaris10</em> brand can make Solaris 10 processes running within <em>solaris10</em>-branded zones act as though they are communicating with a Solaris 10 kernel.</p><p>When a process execs within a <em>solaris10</em>-branded zone, the dynamic linker loads the <em>solaris10</em> brand emulation library (which resides in the global zone) prior to all other dynamic libraries to which the process' executable is linked. The emulation library initializes its data structures and registers itself with the <em>solaris10</em> kernel module via a special brand syscall (<tt>SYS_brand</tt> with a special subcode). Thus the kernel module will know how to transfer control to the emulation library in the event a syscall is issued from the associated process. Once the emulation library finishes initializing, the dynamic linker continues to set up the associated process and transfers control to its start routine.</p><p>When a non-native process in a <em>solaris10</em>-branded zone issues a syscall, the following steps occur in order:</p><ol><li>The thread issuing the syscall traps to the kernel's syscall-handling routines.</li><li>The syscall-handling routines determine that the thread's process resides in a <em>solaris10</em>-branded zone and invoke a special syscall-handling callback registered by the <em>solaris10</em> brand's kernel module.</li><li>The callback looks up the syscall's entry in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulation_table"><tt>s10_emulation_table</tt></a></span>, an array of flags defined by the brand's kernel module and indexed by syscall number. If the syscall's entry is not flagged (i.e., the entry is zero), then the callback returns to the kernel's syscall-handling routines: The syscall is not emulated by the brand. Otherwise, the callback transfers control to the brand's emulation library (which resides in userland) at a registered entry point.</li><li>The brand emulation library's entry point looks up the syscall's entry in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span>, an array mapping syscalls to library functions that emulate the syscalls. If the syscall's entry indicates that a library function handles the syscall, then the handler is invoked with all of the syscall's parameters; otherwise, the emulation library sends <tt>SIGSYS</tt> (bad syscall) to the associated process.</li><li>After the handler returns to the emulation library's entry point, the thread returns to its process' code at the instruction following the syscall. The library's entry point makes the emulated syscall's handler's return value and error code visible to the thread's process.</li></ol><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowcanIaddtoorupdatetheemulation3F"><span>How can I add to or update the emulation?</span></h2><p>The <em>solaris10</em> brand's emulation library is constructed from <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/brand/solaris10/s10_brand/common/s10_brand.c"><tt>usr/src/lib/brand/solaris10/s10_brand/common/s10_brand.c</tt></a></span> in the source tree.</p><h3 id="HEmulatingaSystemCall"><span>Emulating a System Call</span></h3><p>To emulate a Solaris 10 syscall, you must create a static function in the brand emulation library with the following signature:</p><div class="box code">static int<br/>&lt;function-name&gt;(sysret_t *&lt;rv&gt;, &lt;syscall-args&gt;)</div><p>where <tt>&lt;function-name&gt;</tt> is the name of the function and <tt>&lt;syscall-args&gt;</tt> are the syscall's parameter declarations. The function should return the <tt>errno</tt> value that the emulated Solaris 10 syscall would produce. You should store the emulated syscall's return value in <tt>&lt;rv&gt;</tt>.</p><p>You must make two additional changes, one to the brand emulation library and the other to the <em>solaris10</em> brand's kernel module (<span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/brand/solaris10/s10_brand.c"><tt>usr/src/uts/common/brand/solaris10/s10_brand.c</tt></a></span> in the source tree):</p><ul><li>Find the definition of the array <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> at the bottom of the brand emulation library's source file and locate the row/entry corresponding to the numeric identifier of the emulated syscall. (Comments have been added to each row/entry indicating its corresponding numeric syscall identifier.) Change the entry from "<tt>NOSYS</tt>" to<br/><span class="box code">EMULATE(&lt;function-name&gt;, &lt;num-syscall-args&gt; | &lt;syscall-RV-flags&gt;)</span><br/>where <tt>&lt;function-name&gt;</tt> is the name of the emulation function in the brand library that will handle the syscall, <tt>&lt;num-syscall-args&gt;</tt> is the number of parameters for the emulated Solaris 10 syscall, and <tt>&lt;syscall-RV-flags&gt;</tt> is one of the following constants:<ul><li><strong><tt>RV_DEFAULT</tt></strong>: The syscall returns "default" values. Use this when the Solaris 10 syscall is defined in the sysent table in <tt>uts/common/os/sysent.c</tt> with <tt>SYSENT_C</tt>, <tt>SYSENT_CI</tt>, or <tt>SYSENT_CL</tt>.</li><li><strong><tt>RV_32RVAL2</tt></strong>: The syscall returns two 32-bit values. Use this when the Solaris 10 syscall is defined with <tt>SYSENT_2CI</tt>.</li><li><strong><tt>RV_64RVAL</tt></strong>: The syscall returns a single 64-bit value. Use this when the Solaris 10 syscall is defined with <tt>SYSENT_AP</tt>.</li></ul></li><li>Find the definition of <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=_init&amp;path=usr/src/uts/common/brand/solaris10"><tt>_init()</tt></a></span> in the <em>solaris10</em> brand kernel module and add<br/><span class="box code">s10_emulation_table[&lt;SYS-identifier&gt;] = 1;</span><br/>near the beginning of the function, where <tt>&lt;SYS-identifier&gt;</tt> is the numeric code of the emulated syscall as defined in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/sys/syscall.h"><tt>usr/src/uts/common/sys/syscall.h</tt></a></span>. There are already several such lines and they should be ordered by syscall number.</li></ul><h4 id="HAnExample"><span>An Example</span></h4><p>In this example, we will emulate the Solaris 10 <tt>SYS_sigqueue</tt> syscall. We will name the emulation function <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sigqueue"><tt>s10_sigqueue()</tt></a></span> and define it thus:</p><div class="box code">/*<br/>&nbsp;* New last arg "block" flag should be zero. &nbsp;The block flag is used by<br/>&nbsp;* the Opensolaris AIO implementation, which is now part of libc.<br/>&nbsp;*/<br/>static int<br/>s10_sigqueue(sysret_t *rval, pid_t pid, int signo, void *value, int si_code)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rval, SYS_sigqueue + 1024, pid, signo, value,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si_code, 0));<br/>}</div><p>(For information about <tt>__systemcall()</tt>, see "<span class="wikilink"><a href="#HIssuingSystemCallswithinEmulationFunctions">Issuing System Calls within Emulation Functions</a></span>".)</p><p>We need to modify the entry in the brand emulation library's <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> array corresponding to <tt>SYS_sigqueue</tt> (entry 190) so that <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sigqueue"><tt>s10_sigqueue()</tt></a></span> will be invoked when processes issue <tt>SYS_sigqueue</tt>. <tt>SYS_sigqueue</tt> takes four arguments and returns "default" values in Solaris 10, so the correct entry is:</p><div class="box code">EMULATE(s10_sigqueue, 4 | RV_DEFAULT)</div><p>Finally, we need to modify the <em>solaris10</em> brand kernel module so that it knows to emulate <tt>SIG_sigqueue</tt>. We would add the following line to the beginning of the <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=_init&amp;path=usr/src/uts/common/brand/solaris10"><tt>_init()</tt></a></span> function in the kernel module:</p><div class="box code">s10_emulation_table[SYS_sigqueue] = 1;</div><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HEmulatinganIoctl"><span>Emulating an Ioctl</span></h3><p>All ioctls are issued via the <tt>SYS_ioctl</tt> syscall, which the brand emulation library emulates in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_ioctl"><tt>s10_ioctl()</tt></a></span>. All ioctls are currently emulated by first checking the <tt>request</tt> argument to <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5167/ioctl-2"><tt>ioctl(2)</tt></a></span> (the <tt>cmd</tt> argument to <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_ioctl"><tt>s10_ioctl()</tt></a></span>) and taking appropriate action based on its value (usually calling separate emulation functions to handle subsystem- or device-specific ioctls, such as <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=zfs_ioctl&amp;path=usr/src/lib/brand/solaris10/s10_brand/common"><tt>zfs_ioctl()</tt></a></span> to handle ZFS ioctls). If the argument does not match any emulated ioctls, then the syscall is passed to the OpenSolaris kernel.</p><p>Here is an example of <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_ioctl"><tt>s10_ioctl()</tt></a></span>:</p><div class="box code">int<br/>s10_ioctl(sysret_t *rval, int fdes, int cmd, intptr_t arg)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Is the ioctl command a specific ioctl that needs to<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* be emulated?<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (cmd) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case CRYPTO_GET_FUNCTION_LIST:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (crypto_ioctl(rval, fdes, cmd, arg));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case CT_TGET:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (ctfs_ioctl(rval, fdes, cmd, arg));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case CT_TSET:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (ctfs_ioctl(rval, fdes, cmd, arg));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Does the ioctl belong to the ZFS ioctl family?<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((cmd &amp; 0xff00) == ZFS_IOC)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (zfs_ioctl(rval, fdes, cmd, arg));<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* The ioctl doesn't need to be emulated. &nbsp;Pass it to the<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* OpenSolaris kernel.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rval, SYS_ioctl + 1024, fdes, cmd, arg));<br/>}</div><p>Note that the same ioctl command number might be used by two different devices: Checking the command number does not determine which of the two is being controlled. Although most Solaris devices have unique ioctl commands, there is no guarantee that a Solaris device-specific ioctl command is not used by a third-party device. If this is a concern, then ioctl emulation code can gather more information about the targeted device by performing an <tt>fstat</tt> operation (<tt>SYS_fstat</tt>) and checking the results.</p><p>For example, suppose that we will emulate the contract file system's (CTFS's) <tt>CT_TGET</tt> and <tt>CT_TSET</tt> ioctl commands in the emulation function <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=ctfs_ioctl"><tt>ctfs_ioctl()</tt></a></span>. Suppose further that we want to ensure that we only emulate these ioctls when they target CTFS files. We can issue a <tt>SYS_fstat</tt> syscall and check that the targeted file's filesystem's type is <tt>MNTTYPE_CTFS</tt>:</p><div class="box code">static int<br/>ctfs_ioctl(sysret_t *rval, int fdes, int cmd, intptr_t arg)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int err;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct stat statbuf;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((err = __systemcall(rval, SYS_fstat + 1024, fdes, &amp;statbuf)) != 0)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (err);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (strcmp(statbuf.st_fstype, MNTTYPE_CTFS) != 0) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* The target doesn't reside on CTFS. &nbsp;Assume that the ioctl<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* doesn't need to be emulated and pass it to the kernel.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rval, SYS_ioctl + 1024, fdes, cmd, arg));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}</div><p>(For information about <tt>__systemcall()</tt>, see "<span class="wikilink"><a href="#HIssuingSystemCallswithinEmulationFunctions">Issuing System Calls within Emulation Functions</a></span>".)</p><p>Notice that the above function assumes that <tt>CT_TGET</tt> and <tt>CT_TSET</tt> ioctls should not be emulated if they are not intended for CTFS files. This might not be the case if another device uses either ioctl command and needs to be emulated.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HGeneralEmulationTechniques"><span>General Emulation Techniques</span></h3><p>The following sections detail common techniques used in syscall and ioctl emulation functions.</p><h4 id="HIssuingSystemCallswithinEmulationFunctions"><span>Issuing System Calls within Emulation Functions</span></h4><p>Many emulation functions need to issue syscalls to the native OpenSolaris kernel. To do so, invoke the <tt>__systemcall()</tt> function as follows:</p><div class="box code">__systemcall(&lt;rv&gt;, &lt;SYS-identifier&gt; + 1024, &lt;syscall-args&gt;);</div><p><tt>&lt;SYS-identifier&gt;</tt> is the numeric code of the syscall being issued as defined in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/sys/syscall.h"><tt>usr/src/uts/common/sys/syscall.h</tt></a></span> (e.g., <tt>SYS_fstat</tt>) and <tt>&lt;syscall-args&gt;</tt> are the arguments to the syscall. The return value of the syscall is stored in <tt>&lt;rv&gt;</tt>, which has type <tt>sysret_t *</tt>. The return value of <tt>__systemcall()</tt> indicates whether or not an error occurred. If it is zero, then no errors occurred.</p><p>Notice that you should add 1024 to the syscall's numeric identifier. The brand framework treats all syscalls whose identifiers are less than 1024 as emulated syscalls and will bounce them back to the brand emulation library, whereas syscalls whose identifiers are offset by 1024 are treated as native syscalls and are not emulated. If you do not add 1024 to the identifier, then the brand emulation library will handle the syscall, which is probably not what you want. Not adding 1024 might also cause infinite recursion if the emulation function inadvertently invokes itself while issuing the syscall, resulting in stack overflows and, ultimately, core dumps.</p><h5 id="HAnExample-1"><span>An Example</span></h5><p>Refer to the example emulation function <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sigqueue"><tt>s10_sigqueue()</tt></a></span> provided in the last section, which emulates the <tt>SYS_sigqueue</tt> syscall:</p><div class="box code">/*<br/>&nbsp;* New last arg "block" flag should be zero. &nbsp;The block flag is used by<br/>&nbsp;* the Opensolaris AIO implementation, which is now part of libc.<br/>&nbsp;*/<br/>static int<br/>s10_sigqueue(sysret_t *rval, pid_t pid, int signo, void *value, int si_code)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rval, SYS_sigqueue + 1024, pid, signo, value,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si_code, 0));<br/>}</div><p>In Solaris 10, <tt>SYS_sigqueue</tt> takes five arguments, but the OpenSolaris version takes six. The new sixth argument is a flag used by OpenSolaris' AIO subsystem and should be zero when <tt>SYS_sigqueue</tt> is issued from within a <em>solaris10</em>-branded zone. Reissuing the syscall within the emulation function with a zeroed sixth argument solves the problem. The above code issues a native <tt>SYS_sigqueue</tt> syscall (notice that the function offsets the syscall identifier by 1024), passing all of the arguments provided by the calling process untouched and adding a zero as the sixth argument. The return value of the syscall is stored in <tt>rval</tt>, which is handed to the calling process when the emulation function completes. The error code (if any) produced by the syscall is returned to the calling process.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h4 id="HInsertingtrussPoints"><span>Inserting <tt>truss</tt> Points</span></h4><p>No truss points are triggered when a syscall is emulated by the brand library. If a native syscall is issued from an emulation function (see "<span class="wikilink"><a href="#HIssuingSystemCallswithinEmulationFunctions">Issuing System Calls within Emulation Functions</a></span>" above), then the native syscall's truss point is triggered. However, if the emulation function does not issue a native syscall, then you should insert a truss point via the <tt>S10_TRUSS_POINT_*</tt> macros. These macros issue a <tt>SYS_brand</tt> syscall in order to simulate a truss point.</p><p>The macros have the following signature:</p><div class="box code">S10_TRUSS_POINT_N(&lt;rv&gt;, &lt;SYS-identifier&gt;, &lt;errno-value&gt;, &lt;arguments&gt;)</div><p><tt>N</tt> is an integer between one and five (inclusive) that specifies the number of arguments to report in the truss point. <tt>&lt;rv&gt;</tt> is a non-NULL <tt>sysret_t *</tt> that stores the return value of the syscall that performs the truss operation. <tt>&lt;SYS-identifier&gt;</tt> is the numeric identifier of the syscall being issued as defined in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/sys/syscall.h"><tt>usr/src/uts/common/sys/syscall.h</tt></a></span> (e.g., <tt>SYS_fstat</tt>). <tt>&lt;errno-value&gt;</tt> is an integer such that if it is nonzero, then the <tt>SYS_brandsys</tt> syscall that simulates the truss point stores it in the calling thread's <tt>errno</tt>. <tt>&lt;arguments&gt;</tt> is a comma-separated list of <tt>N</tt> values to report in the truss point.</p><p>The macros return zero for success and an <tt>errno</tt> error code for failure.</p><h5 id="HAnExample-2"><span>An Example</span></h5><p>In this example, <tt>SYS_systeminfo</tt> is emulated entirely in the brand emulation library by the function <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysinfo"><tt>s10_sysinfo()</tt></a></span>. If a process running in a <em>solaris10</em>-branded zone issues <tt>SYS_systeminfo</tt> and an instance of <tt>truss</tt> is observing the process' syscalls, then the latter won't see the <tt>SYS_systeminfo</tt> syscall because <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysinfo"><tt>s10_sysinfo()</tt></a></span> never issues a native syscall. Creating a simulated truss point solves this problem:</p><div class="box code">int<br/>s10_sysinfo(sysret_t *rv, int command, char *buf, long count)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char *value;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int len;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* On success, sysinfo(2) returns the size of buffer required to hold<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* the complete value plus its terminating NULL byte.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void) S10_TRUSS_POINT_3(rv, SYS_systeminfo, 0, command, buf, count);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv-&gt;sys_rval1 = len;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv-&gt;sys_rval2 = 0;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (0);<br/>}</div><p>Notice that the function passes zero as <tt>&lt;errno-value&gt;</tt> in the truss macro in order to tell observing <tt>truss</tt> processes that the syscall completed successfully.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h4 id="HCopyingMemory"><span>Copying Memory</span></h4><p>If you need to copy data to or from a buffer or structure provided by the calling process, then you should use <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopy"><tt>s10_uucopy()</tt></a></span> and <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopystr"><tt>s10_uucopystr()</tt></a></span>. Both prevent the emulation library from performing illegal memory accesses if the calling process provides junk pointers. The signatures of the two functions are identical:</p><div class="box code">static int s10_uucopy[str](const void *from, void *to, size_t size)</div><p><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopy"><tt>s10_uucopy()</tt></a></span> copies <tt>size</tt> bytes from <tt>from</tt> to <tt>to</tt>. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopystr"><tt>s10_uucopystr()</tt></a></span> functions like <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5168/strncpy-3c"><tt>strncpy(3C)</tt></a></span> in that it copies at most <tt>size</tt> characters from <tt>from</tt> to <tt>to</tt>, but unlike <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5168/strncpy-3c"><tt>strncpy(3C)</tt></a></span> it <strong>never</strong> adds a terminating <tt>NULL</tt> byte. Both functions indicate success by returning zero and indicate failure by returning an <tt>errno</tt> value (e.g., <tt>EFAULT</tt>).</p><h5 id="HAnExample-3"><span>An Example</span></h5><p>This example expands the <span class="wikilink"><a href="#HAnExample-2">example of inserting truss points</a></span>, which showcased part of the emulation function for <tt>SYS_systeminfo</tt>.</p><div class="box code">int<br/>s10_sysinfo(sysret_t *rv, int command, char *buf, long count)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char *value;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int len;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* We must interpose on the sysinfo(2) commands SI_RELEASE and<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* SI_VERSION; all others get passed to the native sysinfo(2)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* command.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (command) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case SI_RELEASE:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value = "5.10";<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case SI_VERSION:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value = "Generic_Virtual";<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Copy the string to the buffer provided by the calling<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* process. &nbsp;Use s10_uucopystr() in order to properly<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* handle memory access/protection faults. &nbsp;(We can't<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* trust pointers provided by the calling process!)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len = strlen(value) + 1;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (count &gt; 0) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (s10_uucopystr(value, buf, count) != 0)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (EFAULT);<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Ensure NULL termination of buf as s10_uucopystr() doesn't. */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (len &gt; count &amp;&amp; s10_uucopy("\0", buf + (count - 1), 1) != 0)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (EFAULT);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* On success, sysinfo(2) returns the size of buffer required to hold<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* the complete value plus its terminating NULL byte.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void) S10_TRUSS_POINT_3(rv, SYS_systeminfo, 0, command, buf, count);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv-&gt;sys_rval1 = len;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv-&gt;sys_rval2 = 0;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (0);<br/>}</div><p>When the calling process requests either the release (<tt>SI_RELEASE</tt>) or the version (<tt>SI_VERSION</tt>) of the kernel, the emulation function produces fake values so that the calling process will see values reflecting a Solaris 10 kernel. Once the appropriate string is selected, <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopystr"><tt>s10_uucopystr()</tt></a></span> copies it to the buffer provided by the calling process. However, <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopystr"><tt>s10_uucopystr()</tt></a></span> does not copy the string's terminating <tt>NULL</tt> byte, so the function invokes <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_uucopy"><tt>s10_uucopy()</tt></a></span> to append a <tt>NULL</tt> byte to the end of the buffer.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h4 id="HModifyingParameterStructures"><span>Modifying Parameter Structures</span></h4><p>Some syscalls' and ioctls' parameters' structures and semantics differ between Solaris 10 and OpenSolaris. For example, the contract file system's <tt>ct_param_t</tt> structure changed in OpenSolaris so that it looks like</p><div class="box code">/* OpenSolaris version */<br/>typedef struct ct_param {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_id;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_size;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void &nbsp;&nbsp;&nbsp;&nbsp;*ctpm_value;<br/>} ct_param_t;</div><p>instead of</p><div class="box code">/* Solaris 10 version */<br/>typedef struct ct_param {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_id;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_pad;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint64_t ctpm_value;<br/>} ct_param_t;</div><p>Notice that the third field, <tt>ctpm_value</tt>, changed from <tt>uint64_t</tt> to <tt>void *</tt>. Unfortunately, this means that the size of the structure is 12 bytes on 32-bit systems and 16 bytes on 64-bit systems. Solaris 10 processes issuing <tt>CT_TGET</tt> or <tt>CT_TSET</tt> contract file system ioctls will pass the Solaris 10 version of the structure as the ioctl argument, which is invalid on 32-bit OpenSolaris systems.</p><p>Other examples of incompatible structure changes include new fields, deleted fields, new flag field values, and field value range changes.</p><p>Structure changes can be overcome by defining the Solaris 10 version of the structure in the brand emulation library, declaring a stack instance (local variable) of the OpenSolaris version of the structure in the associated emulation function, copying the contents of the structure parameter to the local structure variable in the appropriate places (see "<span class="wikilink"><a href="#HCopyingMemory">Copying Memory</a></span>" above), adjusting the fields of the structure on the stack as necessary, issuing the system call or ioctl and passing the OpenSolaris structure instead of the Solaris 10 structure, and copying modified fields from the OpenSolaris structure to the Solaris 10 structure if any of the former's fields were modified by the syscall or ioctl. Sometimes a stack instance of the Solaris 10 structure must also be declared and utilized: see the example below for a case in which this is necessary.</p><h5 id="HAnExample-4"><span>An Example</span></h5><p>The following example shows how the aforementioned <tt>ct_param_t</tt> structure change can be circumvented by the brand emulation library. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=ctfs_ioctl"><tt>ctfs_ioctl()</tt></a></span> emulates the contract file system <tt>CT_TGET</tt> and <tt>CT_TSET</tt> ioctls in the emulation library. Here is its definition:</p><div class="box code">#include &lt;sys/ctfs.h&gt;<br/><br/>/* Solaris 10 version of ct_param_t */<br/>typedef struct s10_ct_param {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_id;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint32_t ctpm_pad;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint64_t ctpm_value;<br/>} s10_ct_param_t;<br/><br/>/*<br/>&nbsp;* We have to emulate process contract ioctls for init(1M) because the<br/>&nbsp;* ioctl parameter structure changed between Solaris 10 and OpenSolaris.<br/>&nbsp;* This is a relatively simple process of filling OpenSolaris structure<br/>&nbsp;* fields, shuffling values, and initiating a native syscall.<br/>&nbsp;*/<br/>static int<br/>ctfs_ioctl(sysret_t *rval, int fdes, int cmd, intptr_t arg)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int err;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_ct_param_t s10param; /* Solaris 10 version */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ct_param_t param; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* OpenSolaris version */<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Copy the structure provided by the caller to the stack<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* and fill the fields of the OpenSolaris version of the structure<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* with appropriate values. &nbsp;Then issue the syscall with<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* the OpenSolaris version of the structure.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (s10_uucopy((const void *)arg, &amp;s10param, sizeof (s10param)) != 0)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (EFAULT);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param.ctpm_id = s10param.ctpm_id;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param.ctpm_size = sizeof (uint64_t);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param.ctpm_value = &amp;s10param.ctpm_value;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((err = __systemcall(rval, SYS_ioctl + 1024, fdes, cmd, &amp;param))<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!= 0)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (err);<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* If the ioctl is CT_TGET, then the syscall stored a value in<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* the 'ctpm_value' field of the Solaris 10 structure (notice that<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* the OpenSolaris version's 'ctpm_value' field is a pointer to the<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Solaris 10 version's 'ctpm_value' field). &nbsp;Copy the entire<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Solaris 10 structure back to the caller so that it sees the<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* new value.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmd == CT_TGET)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (s10_uucopy(&amp;s10param, (void *)arg, sizeof (s10param)));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (0);<br/>}</div><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h4 id="HProducingArchitecture-SpecificCode"><span>Producing Architecture-Specific Code</span></h4><p>The <em>solaris10</em> brand emulation library is compiled twice for both x86 and sparc in order to produce 32- and 64-bit shared libraries. Consequently, it is possible to restrict pieces of code in the emulation library to particular architectures via the standard architecture preprocessor symbols: <tt>__x86</tt> for 32- or 64-bit x86; <tt>__i386</tt> for 32-bit x86; <tt>__amd64</tt> for 64-bit x86 (i.e., x86-64); <tt>__sparc</tt> for any sparc architecture; <tt>__sparcv7</tt>, <tt>__sparcv8</tt>, and <tt>__sparcv9</tt> for sparc V7, V8, and V9, respectively; and <tt>_LP64</tt> for any 64-bit architecture. For example, suppose that a particular ioctl only needs to be emulated when issued by a 64-bit x86 process. We can implement such emulation by wrapping the emulation code (and its invocations) with preprocessor conditional statements:</p><div class="box code">#ifdef &nbsp;__amd64<br/>static int<br/>s10_some_ioctl_emulation_function(sysret_t *rval, int fdes, int cmd,<br/>&nbsp;&nbsp;&nbsp;&nbsp;intptr_t arg)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}<br/>#endif &nbsp;/* __amd64 */<br/><br/>int<br/>s10_ioctl(sysret_t *rval, int fdes, int cmd, intptr_t arg)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/><br/>#ifdef &nbsp;__amd64<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmd == SOME_IOCTL)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (s10_some_ioctl_emulation_function(rval, fdes, cmd,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arg));<br/>#endif &nbsp;/* __amd64 */<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}</div><p>However, care must be taken when restricting syscall emulation to specific architectures. If the syscall emulation function will only exist for some architectures, then the <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> array in the emulation library should be configured such that it specifies <tt>NOSYS</tt> for the architectures for which the syscall will not be emulated. The brand's kernel module's <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulation_table"><tt>s10_emulation_table</tt></a></span> should also be properly configured so that the syscall is only emulated for those architectures for which emulation is necessary. (For more information about <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> and <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulation_table"><tt>s10_emulation_table</tt></a></span>, see "<span class="wikilink"><a href="#HEmulatingaSystemCall">Emulating a System Call</a></span>" above.) For example, if <tt>SYS_fstat</tt> were to be emulated by sparc alone, then we should define the emulation function thus:</p><div class="box code">#ifdef &nbsp;__sparc<br/>static int<br/>s10_fstat(sysret_t *rval, int fd, struct stat *sb)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}<br/>#endif &nbsp;/* __sparc */</div><p>We would have to modify <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> as follows (note that <tt>SYS_fstat</tt> is syscall number 28):</p><div class="box code">s10_sysent_table_t s10_sysent_table[] = {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 27 */<br/>#ifdef &nbsp;__sparc<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMULATE(s10_fstat, 2 | RV_DEFAULT), &nbsp;&nbsp;/* 28 */<br/>#else &nbsp;&nbsp;/* !__sparc */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 28 */<br/>#endif &nbsp;/* !__sparc */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 29 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>};</div><p>Finally, we would have to modify <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=_init&amp;path=usr/src/uts/common/brand/solaris10"><tt>_init()</tt></a></span> in the kernel module thus:</p><div class="box code">int<br/>_init(void)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>#ifdef &nbsp;__sparc<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_emulation_table[SYS_fstat] = 1; &nbsp;&nbsp;/* 28 */<br/>#endif &nbsp;/* __sparc */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}</div><p>If a syscall will only be emulated on one or more 64-bit architectures, then an emulation function usually has to be created for 32-bit architectures that only passes the syscall's arguments to the native kernel. For example, if <tt>SYS_fstat</tt> should only be emulated by 64-bit x86 processes, then we should define the emulation function thus:</p><div class="box code">#ifdef &nbsp;__x86<br/>static int<br/>s10_fstat(sysret_t *rval, int fd, struct stat *sb)<br/>{<br/>#ifdef &nbsp;__amd64<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>#else &nbsp;&nbsp;/* !__amd64 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* The brand library won't do anything special for SYS_fstats issued by<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* 32-bit x86 processes, so we'll hand the syscall back to the kernel.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rval, SYS_fstat + 1024, fd, sb));<br/>#endif &nbsp;/* !__amd64 */<br/>}<br/>#endif &nbsp;/* __x86 */</div><p>We would have to modify <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> as follows:</p><div class="box code">s10_sysent_table_t s10_sysent_table[] = {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 27 */<br/>#ifdef &nbsp;__x86<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMULATE(s10_fstat, 2 | RV_DEFAULT), &nbsp;&nbsp;/* 28 */<br/>#else &nbsp;&nbsp;/* !__x86 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 28 */<br/>#endif &nbsp;/* !__x86 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 29 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>};</div><p>This specifies that <tt>SYS_fstat</tt> will be emulated by <tt>s10_fstat()</tt> on both 32- and 64-bit x86 but not on sparc. Finally, we would have to modify <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=_init&amp;path=usr/src/uts/common/brand/solaris10"><tt>_init()</tt></a></span> in the kernel module thus:</p><div class="box code">int<br/>_init(void)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>#ifdef &nbsp;__amd64<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* NOTE: Even though SYS_fstat will only be emulated when running a<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* 64-bit x86 kernel, SYS_fstat will be emulated for both 32- and 64-<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* bit processes.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_emulation_table[SYS_fstat] = 1; &nbsp;&nbsp;/* 28 */<br/>#endif &nbsp;/* __amd64 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>}</div><p>The above code ensures that only the 64-bit x86 kernel module will pass <tt>SYS_fstat</tt> syscalls to the brand emulation library. However, both 32- and 64-bit processes are capable of running on 64-bit kernels and the kernel brand framework does not discriminate between syscalls issued by 32- and 64-bit processes. Consequently, <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> must be configured so that <tt>SYS_fstat</tt> is handled by the brand emulation library for both 32- and 64-bit processes even though the 32-bit emulation function simply hands control back to the kernel. If <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> were instead configured thus:</p><div class="box code">s10_sysent_table_t s10_sysent_table[] = {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 27 */<br/>#ifdef &nbsp;__amd64 &nbsp;&nbsp;&nbsp;&nbsp;/* fstat() is only emulated for 64-bit x86 processes, right? */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMULATE(s10_fstat, 2 | RV_DEFAULT), &nbsp;&nbsp;/* 28 */<br/>#else &nbsp;&nbsp;/* !__amd64 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 28 */<br/>#endif &nbsp;/* !__amd64 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOSYS, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* 29 */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>};</div><p>then if a 32-bit x86 process running on a 64-bit kernel were to issue <tt>SYS_fstat</tt>, then the brand's kernel module would pass the syscall to the brand emulation library and the library would signal the calling process with <tt>SIGSYS</tt> (bad syscall) because the 32-bit library does not emulate <tt>SYS_fstat</tt>.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HGeneralEmulationConsiderations"><span>General Emulation Considerations</span></h3><p>Keep the following considerations in mind when you modify the emulation library:</p><ol><li><strong>Do not set <tt>errno</tt>!</strong> The brand emulation library has its own copy of <tt>errno</tt>, so processes running in <em>solaris10</em>-branded zones will not see any modifications to <tt>errno</tt> that are made from the emulation library. Emulation functions should return <tt>errno</tt> values: The brand framework and Solaris 10 libc move these values into <tt>errno</tt> as seen by the processes running in <em>solaris10</em>-branded zones. For example, if a syscall emulation function succeeds, then it should return zero (i.e., <tt>return (0);</tt>) and ensure that the <tt>sysret_t</tt> value passed to the emulation function is properly set. On the other hand, if the emulation function needs to indicate <tt>EFAULT</tt> to the invoking process, then it should return <tt>EFAULT</tt> (i.e., <tt>return (EFAULT);</tt>).</li><li><strong>Take care regarding which library functions you invoke.</strong> The brand emulation library is linked to its own copy of the Solaris 10 libc and other libraries, so it can invoke standard functions such as <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5168/strtol-3c"><tt>strtol(3C)</tt></a></span>. However, you must be careful when you invoke a library function because it might issue syscalls that result in recursion as described in "<span class="wikilink"><a href="#HIssuingSystemCallswithinEmulationFunctions">Issuing System Calls within Emulation Functions</a></span>" above.</li><li><strong>Always leave comments explaining why you are providing emulation.</strong> Make everyone's life easier. People reviewing the brand emulation library will most likely not be intimately familiar with the subsystem(s) whose behaviors you are emulating.</li></ol><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowcanIsetupthebrandtouseanativecommand3F"><span>How can I set up the brand to use a native command?</span></h2><p>Modify the <em>solaris10</em> brand boot script (<span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/brand/solaris10/zone/s10_boot.ksh"><tt>usr/src/lib/brand/solaris10/zone/s10_boot.ksh</tt></a></span> in the source tree) as follows:</p><ol><li>Navigate to the section labeled "STEP ONE".</li><li>If the replaced command's path is <tt>/d_1/d_2/.../d_N/B</tt>, where <tt>d_i</tt> is a directory (<tt>i</tt> is between <tt>1</tt> and <tt>N</tt>) and <tt>B</tt> is the name of the command, then add the following lines to the script under "STEP ONE":<br/><span class="box code">safe_dir /d_1<br/>safe_dir /d_1/d_2<br/>...<br/>safe_dir /d_1/d_2/.../d_N</span><br/>For example, if you want to replace <tt>/foo/bar/baz/some_command</tt>, then add the following lines to the script under "STEP ONE":<br/><span class="box code">safe_dir /foo<br/>safe_dir /foo/bar<br/>safe_dir /foo/bar/baz</span><br/>You do not need to duplicate these lines for two commands residing within the same directory. For example, if you want to replace <tt>/foo/bar/baz/command_1</tt> and <tt>/foo/bar/baz/command_2</tt>, then you only need to add the above lines once.</li><li>Navigate to the section labeled "STEP TWO".</li><li>If the path of the replacement command is identical to that of the replaced command, then add the following line to the script under "STEP TWO": <tt>replace_with_native &lt;abs-path&gt; &lt;mode&gt; &lt;user&gt;:&lt;group&gt;</tt>, where <tt>&lt;abs-path&gt;</tt> is the absolute path to the replacement command, <tt>&lt;mode&gt;</tt> is the hex UNIX permissions that the replacement command will have, <tt>&lt;user&gt;</tt> is the name of the command's owner, and <tt>&lt;group&gt;</tt> is the owner's group.<br/><br/>The following example replaces <tt>/sbin/ifconfig</tt> with the native OpenSolaris <tt>ifconfig</tt>, both of which reside in <tt>/sbin</tt>; gives the replacement owner, group, and world read and execute permissions; and makes the zone's <tt>root</tt> user (group <tt>bin</tt>) the replacement's owner:<br/><span class="box code">replace_with_native /sbin/ifconfig 0555 root:bin</span></li><li>If the path of the replacement command differs from that of the replaced command, then add the following line to the script under "STEP TWO": <tt>safe_replace $ZONEROOT/&lt;replaced-abs-path&gt; &lt;replacement-abs-path&gt; &lt;mode&gt; &lt;user&gt;:&lt;group&gt; remove</tt>, where <tt>&lt;replaced-abs-path&gt;</tt> is the absolute path of the replaced command (as seen from within the zone), <tt>&lt;replacement-abs-path&gt;</tt> is the absolute path of the replacement command, and <tt>&lt;mode&gt;</tt>, <tt>&lt;owner&gt;</tt>, and <tt>&lt;group&gt;</tt> have the same semantics as in the previous step.<br/><br/>The following example replaces the Solaris 10 <tt>/usr/bin/true</tt> with the OpenSolaris <tt>/usr/bin/false</tt>, gives the replacement owner, group, and world read and execute permissions, and makes the zone's <tt>root</tt> user (group <tt>bin</tt>) the replacement's owner:<br/><span class="box code">safe_replace $ZONEROOT/usr/bin/true /usr/bin/false 0555 root:bin remove</span></li></ol><p>The brand boot script executes whenever a <em>solaris10</em>-branded zone boots. Once zone bootup is complete, every replaced command <tt>X</tt> will have been backed up to <tt>X.pre_p2v</tt>. If you need to restore the replaced command's binary within a zone, then execute <tt>mv X.pre_p2v X</tt> within the zone, where <tt>X</tt> is the full path of the replaced command.</p><p>Here is an example that replaces <tt>/usr/bin/zcat</tt> with OpenSolaris' <tt>/usr/bin/zcat</tt> (with owner <tt>root</tt>, group <tt>bin</tt>, and UNIX file permissions <tt>0555</tt>) and <tt>/usr/demo/dtrace/kstat.d</tt> with OpenSolaris' <tt>/usr/bin/true</tt> (with owner <tt>root</tt>, group <tt>bin</tt>, and UNIX file permissions <tt>0644</tt>):</p><div class="box code">#<br/># STEP ONE<br/>#<br/># Validate that the zone filesystem looks like we expect it to.<br/>#<br/>safe_dir /usr<br/>safe_dir /usr/bin<br/>safe_dir /usr/demo<br/>safe_dir /usr/demo/dtrace<br/><br/># ...<br/><br/>#<br/># STEP TWO<br/>#<br/># Replace Solaris 10 binaries with OpenSolaris binaries.<br/>#<br/>replace_with_native /usr/bin/zcat 0555 root:bin<br/>safe_replace $ZONEROOT/usr/demo/dtrace/kstat.d /usr/bin/true 0644 root:bin \<br/>&nbsp;&nbsp;&nbsp;&nbsp;remove<br/><br/># ...</div><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HANoteConcerningSplitBinaries"><span>A Note Concerning Split Binaries</span></h3><p>Some commands in <tt>/usr/bin</tt>, such as <tt>/usr/bin/pmap</tt>, are split into 32- and 64-bit versions that reside in architecture-dependent subdirectories of <tt>/usr/bin</tt>. For example, the 32-bit version of <tt>pmap</tt> resides in <tt>/usr/bin/i86</tt> while the 64-bit version resides in <tt>/usr/bin/amd64</tt> on x86 systems. Sparc systems only have a 64-bit version of <tt>pmap</tt>: <tt>/usr/bin/sparcv9/pmap</tt>. To replace a split command such as <tt>pmap</tt>, you must replace both the 32-bit binary (if it exists) and the 64-bit binary.</p><p>Suppose that you want to replace the split command <tt>/usr/bin/X</tt> with the OpenSolaris version of <tt>/usr/bin/X</tt>. Then skip steps four and five above and add the following lines below "STEP TWO" instead:</p><div class="box code">if [ -n "$ARCH32" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replace_with_native /usr/bin/$ARCH32/X &lt;mode&gt; &lt;owner&gt;:&lt;group&gt;<br/>fi<br/>if [ -n "$ARCH64" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replace_with_native /usr/bin/$ARCH64/X &lt;mode&gt; &lt;owner&gt;:&lt;group&gt;<br/>fi</div><p><tt>&lt;mode&gt;</tt>, <tt>&lt;owner&gt;</tt>, and <tt>&lt;group&gt;</tt> have the same semantics as in steps four and five above.</p><p>Here is an example that replaces the split command <tt>/usr/bin/pmap</tt>:</p><div class="box code">if [ -n "$ARCH32" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replace_with_native /usr/bin/$ARCH32/pmap 0555 root:bin<br/>fi<br/>if [ -n "$ARCH64" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replace_with_native /usr/bin/$ARCH64/pmap 0555 root:bin<br/>fi</div><p>If the replacement command's path differs from that of the replaced command, then add the following lines below "STEP TWO" instead:</p><div class="box code">if [ -n "$ARCH32" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_replace $ZONEROOT/usr/bin/$ARCH32/X \<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;32-bit-replacement-abs-path&gt; &lt;mode&gt; &lt;owner&gt;:&lt;group&gt; remove<br/>fi<br/>if [ -n "$ARCH64" ]; then<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safe_replace $ZONEROOT/usr/bin/$ARCH64/X \<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;64-bit-replacement-abs-path&gt; &lt;mode&gt; &lt;owner&gt;:&lt;group&gt; remove<br/>fi</div><p><tt>X</tt> is the name of the replaced command. <tt>&lt;32-bit-replacement-abs-path&gt;</tt> and <tt>&lt;64-bit-replacement-abs-path&gt;</tt> are the absolute paths of the replacement commands for the 32- and 64-bit binaries (respectfully).</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation3F"><span>How is versioning handled for different Solaris 10 updates or patches running in the zone when they need different emulation?</span></h2><p>Any OpenSolaris changes that require updates to the brand's emulation must ensure that Solaris 10u8 and later will function correctly inside of <em>solaris10</em>-branded zones. This is simply a matter of straightforward compatibility and no special versioning support is needed.</p><p>Versioning becomes a factor when making changes to Solaris 10 code. A single OpenSolaris system can host <em>solaris10</em>-branded zones running different releases of Solaris 10 (u8, u9, etc.). For example, an OpenSolaris system might have two zones <tt>foo</tt> and <tt>bar</tt> that host Solaris 10u8 and Solaris 10u9 environments, respectively. This is problematic because different Solaris 10 releases might require different emulation due to backports and other Solaris 10 changes. The <em>solaris10</em> brand overcomes this problem through a basic versioning system.</p><p>Note that enhancing the brand's emulation library to dynamically detect the presence or absence of features in hosted Solaris 10 environments is preferable to versioning. You can see an example of this in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span>, which determines whether a zone's libc works when the <tt>%fs</tt> x86 segment register is zero. (Solaris 10u8 sets <tt>%fs</tt> to a nonzero value in 64-bit x86 processes whereas OpenSolaris clears it.) If it does not, then <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span> changes the current LWP's <tt>%fs</tt> register to a nonzero value and adjusts the brand emulation library so that future LWPs created via the <tt>SYS_lwp_create</tt> syscall will have nonzero <tt>%fs</tt> registers; otherwise, the emulation library does not change <tt>%fs</tt>. Read the subsection entitled "<span class="wikilink"><a href="#HDynamicFeatureDetectionSysentTablePatching">Dynamic Feature Detection: Sysent Table Patching</a></span>" to learn about techniques that improve the performance of emulation functions that utilize dynamic feature detection.</p><p>In order to use versioning, you must change OpenSolaris thus:</p><ol><li>Create a new enumeration constant in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> that represents the Solaris 10 backport or fix. &nbsp;Choose a name that starts with <tt>S10_FEATURE_</tt> and describes the fix (e.g., <tt>S10_FEATURE_ALTERED_MNTFS_IOCTL</tt> or <tt>S10_FEATURE_CR_6813502</tt>). &nbsp;Place the new enumeration value immediately before <tt>S10_NUM_EMUL_FEATURES</tt>.<br/><br/>If your new constant conflicts with someone's putback (i.e., someone else adds a new constant to the enumeration), then merge the changes such that your new constant appears immediately before <tt>S10_NUM_EMUL_FEATURES</tt>.<br/><br/>Remember the value of your new constant. &nbsp;You will need it in later steps.</li><li>Alter the fix's emulation in the brand's emulation library so that it performs conditional emulation. &nbsp;For example, if some emulation will not be necessary when your backport integrates into Solaris 10, then you can alter the emulation so that it only occurs when the backport is not present in the hosted Solaris 10 environment. &nbsp;On the other hand, if your Solaris 10 fix will require new emulation in the <em>solaris10</em> brand's emulation library, then you should modify the library so that the new emulation is only performed when the backport is present in the hosted Solaris 10 environment. &nbsp;See "<span class="wikilink"><a href="#HHowcanIaddtoorupdatetheemulation">How can I add to or update the emulation?</a></span>" for details about adding and updating syscall and ioctl emulation.</li></ol><p>For example, suppose that you need to backport a fix to Solaris 10u9 that would eliminate the need for MNTFS ioctl emulation. &nbsp;You would have to add a new constant to <tt>s10_emulated_features</tt> representing the backport. &nbsp;If you were to name the constant <tt>S10_FEATURE_ALTERED_MNTFS_IOCTL</tt>, then you would have to add it to <tt>s10_emulated_features</tt> thus:</p><div class="box code">enum s10_emulated_features {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S10_FEATURE_ALTERED_MNTFS_IOCTL,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S10_NUM_EMUL_FEATURES &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* This must be the last entry! */ <br/>};</div><p>If your addition were to conflict with another developer's putback because the developer also added a constant (say, <tt>S10_FEATURE_SOME_BACKPORT</tt>), then you would have to merge the changes thus:</p><div class="box code">enum s10_emulated_features {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* ... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S10_FEATURE_SOME_BACKPORT,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S10_FEATURE_ALTERED_MNTFS_IOCTL,<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S10_NUM_EMUL_FEATURES &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* This must be the last entry! */<br/>};</div><p>Emulation functions can easily detect fixes and backports inside <em>solaris10</em>-branded zones via the <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=S10_FEATURE_IS_PRESENT"><tt>S10_FEATURE_IS_PRESENT()</tt></a></span> macro. &nbsp;<tt>S10_FEATURE_IS_PRESENT(N)</tt> is true iff the fix or backport represented by the <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constant <tt>N</tt> is present in the associated zone's Solaris 10 environment. &nbsp;Armed with this macro and your new <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constant, you can make the emulation library conditionally emulate syscalls or ioctls (or both).</p><p>Take the aforementioned example of a backport that obsoletes MNTFS ioctl emulation. You cannot delete the emulation because older Solaris 10 environments (e.g., u8 environments) will need the emulation in order to function properly; therefore, the emulation library should emulate the ioctl iff the Solaris 10 backport is not present. &nbsp;You should make the ioctl's emulation look something like this:</p><div class="box code">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (S10_FEATURE_IS_PRESENT(S10_FEATURE_ALTERED_MNTFS_IOCTL)) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Emulation isn't necessary. Do whatever the<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* native kernel would do.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(/* ... */));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Perform the emulation... */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><p>On the other hand, suppose that the backport represented by <tt>S10_FEATURE_ALTERED_MNTFS_IOCTL</tt> would <em>require</em> MNTFS ioctl emulation that did not previously exist. &nbsp;Swapping the above example's branches would achieve the desired effect: The MNTFS ioctl would be emulated iff <tt>S10_FEATURE_IS_PRESENT(S10_FEATURE_ALTERED_MNTFS_IOCTL)</tt> were true.</p><p>You must do the following as part of your Solaris 10 fix or backport after you finish modifying the <em>solaris10</em> brand's emulation:</p><ol><li>Create a file named <tt>usr/src/lib/brand/solaris10/M</tt> in Solaris 10's source tree, where <tt>M</tt> is the integral value of your new <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constant. &nbsp;For example, if your new <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constant equals four, then your fix should create a file named <tt>usr/src/lib/brand/solaris10/4</tt>. &nbsp;The file can be empty, but it might be useful to insert a short description of the fix (what it changes, its CR number, etc.) so that developers will be able to more easily determine the file's associated fix.</li><li>&nbsp;Update Solaris 10's <tt>usr/src/lib/brand/solaris10/Makefile</tt> to install the new file into your proto area's <tt>/usr/lib/brand/solaris10</tt> directory.</li><li>&nbsp;Update the Solaris 10 SVr4 package that delivers your fix to also deliver the new file into the <tt>/usr/lib/brand/solaris10</tt> directory. &nbsp;This ensures that the new file is delivered together with your fix.</li></ol><p>zoneadm(1M) will refuse to boot <em>solaris10</em>-branded zones that host Solaris 10 environments containing unrecognized numbered files in <tt>/usr/lib/brand/solaris10</tt>. In other words, <em>solaris10</em>-branded zones hosting newer versions of Solaris 10 will not boot if the <em>solaris10</em> brand does not provide sufficiently up-to-date emulation (i.e., OpenSolaris is not sufficiently up-to-date). &nbsp;For example, the brand will not permit a <em>solaris10</em>-branded zone containing <tt>/usr/lib/brand/solaris10/5</tt> to boot when the brand only recognizes <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constants that are less than five (i.e., <tt>S10_NUM_EMULATED_FEATURES</tt> equals five). &nbsp;This prevents users from hosting Solaris 10 environments that cannot be correctly emulated.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HAnExample-5"><span>An Example</span></h3><p>Suppose that you need to change a device's ioctl in OpenSolaris and backport the change to Solaris 10u9 at the same time. Furthermore, suppose that the device is used in native Solaris 10 zones. Then you will have to change OpenSolaris thus:</p><ol><li>Create a new constant in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> using the procedure described above. (This example will name the constant <tt>S10_FEATURE_DEV_IOCTL_BACKPORT</tt>.)</li><li>Update the <em>solaris10</em> brand's emulation library to emulate the ioctl's old Solaris 10 format when <tt>S10_FEATURE_IS_PRESENT(S10_FEATURE_DEV_IOCTL_BACKPORT)</tt> is true. This ensures that <em>solaris10</em>-branded zones will properly host Solaris 10 images that lack your backport.</li></ol><p>Additionally, you should do the following in the Solaris 10 backport:</p><ol><li>Create the file <tt>usr/lib/brand/solaris10/M</tt> in the Solaris 10 source tree, where <tt>M</tt> is the value of <tt>S10_FEATURE_DEV_IOCTL_BACKPORT</tt>.</li><li>Modify Solaris 10's <tt>usr/src/lib/brand/solaris10/Makefile</tt> so that it installs the new file into the <tt>/usr/lib/brand/solaris10</tt> directory.</li><li>Ensure that the appropriate Solaris 10 SVr4 packages install the new file.</li></ol><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h3 id="HDynamicFeatureDetection:SysentTablePatching"><span>Dynamic Feature Detection: Sysent Table Patching</span></h3><p>Syscall emulation functions can dynamically adjust syscalls' <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> entries to make the emulation library invoke different syscall emulation functions. This technique, called <em>sysent table patching</em>, eliminates repeated dynamic feature detection (e.g., probing zones' environments for indications of whether a fix or backport is present) at the cost coding and maintaining multiple emulation functions.</p><p><span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span> uses sysent table patching. <span class="wikilink"><a href="#HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation">As described above</a></span>, <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span> determines whether the Solaris 10 libc can function when the <tt>%fs</tt> x86 segment register is zero. If libc cannot, then <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span> modifies the <tt>SYS_lwp_create</tt> syscall's entry in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> so that <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_create_correct_fs"><tt>s10_lwp_create_correct_fs</tt></a></span> emulates <tt>SYS_lwp_create</tt> syscalls rather than the default handler, <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_create"><tt>s10_lwp_create</tt></a></span>. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_create_correct_fs"><tt>s10_lwp_create_correct_fs</tt></a></span> ensures that new LWPs start in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_create_entry_point"><tt>s10_lwp_create_entry_point</tt></a></span>, which sets the new LWP's <tt>%fs</tt> register to the legacy nonzero Solaris 10 selector value before making the LWP jump to its true entry point. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_create"><tt>s10_lwp_create</tt></a></span> simply hands the <tt>SYS_lwp_create</tt> syscall to the kernel. <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_lwp_private"><tt>s10_lwp_private()</tt></a></span> is invoked once after a process execs and only while the process is single-threaded; therefore, its sysent table patch, if applied, affects all of the process' <tt>SYS_lwp_create</tt> syscalls.</p><p>In general, do the following when you want a syscall to use sysent table patching:</p><ol><li>Create two emulation functions: one that does not emulate the syscall (i.e., one that simply passes the syscall to the kernel) and one that does. The next step will refer to the former as <tt>&lt;first-emulation-function&gt;</tt> and the latter as <tt>&lt;second-emulation-function&gt;</tt>.</li><li>Create an additional emulation function as follows:<br/><tt class="wikimodel-verbatim">TEST</tt><br/><br/><tt class="wikimodel-verbatim">TEST2</tt><br/><br/><span class="box code">static int<br/>&lt;function-name&gt;(sysret_t *&lt;rv&gt;, &lt;syscall-args&gt;)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Determine whether the syscall should be emulated. */<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (/* The syscall needs to be emulated */) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_sysent_table[&lt;SYS-identifier&gt;].st_callc =<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sysent_cb_t)&lt;second-emulation-function&gt;;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (&lt;second-emulation-function&gt;(&lt;rv&gt;, &lt;syscall-args&gt;));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_sysent_table[&lt;SYS-identifier&gt;].st_callc =<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sysent_cb_t)&lt;first-emulation-function&gt;;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (&lt;first-emulation-function&gt;(&lt;rv&gt;, &lt;syscall-args&gt;));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</span><br/>where <tt>&lt;function-name&gt;</tt> is the name of the emulation function, <tt>&lt;syscall-args&gt;</tt> is the comma-separated list of the syscall's parameters, <tt>&lt;SYS-identifier&gt;</tt> is the syscall's numeric identifier as defined in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/sys/syscall.h"><tt>usr/src/uts/common/sys/syscall.h</tt></a></span>, and <tt>&lt;first-emulation-function&gt;</tt> and <tt>&lt;second-emulation-function&gt;</tt> are the names of the emulation functions defined in the previous step.</li><li>Configure the syscall's <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> entry to use the emulation function defined in the last step. (See the section entitled "<span class="wikilink"><a href="#HEmulatingaSystemCall">Emulating a System Call</a></span>" above for instructions on modifying <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span>.)</li></ol><p>For example, suppose that <tt>SYS_fstat</tt> needs to be emulated when a zone's Solaris 10 environment contains the fix represented by a hypothetical <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_emulated_features"><tt>s10_emulated_features</tt></a></span> constant named <tt>S10_FEATURE_FSTAT_CHANGE</tt>. We would follow the above procedure thus:</p><ol><li>Define a function named <tt>s10_noemu_fstat</tt>:<br/><span class="box code">/*<br/>&nbsp;* This function simply hands SYS_fstat syscalls to the kernel. &nbsp;It doesn't<br/>&nbsp;* emulate the syscall.<br/>&nbsp;*/<br/>static int<br/>s10_noemu_fstat(sysret_t *rv, int fd, struct stat *sb)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (__systemcall(rv, SYS_fstat + 1024, fd, sb));<br/>}</span><br/>Define another function named <tt>s10_emulate_fstat</tt>:<br/><span class="box code">/*<br/>&nbsp;* This function emulates SYS_fstat syscalls when S10_FEATURE_FSTAT_CHANGE is<br/>&nbsp;* in the zone.<br/>&nbsp;*/<br/>static int<br/>s10_emulate_fstat(sysret_t *rv, int fd, struct stat *sb)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Emulation... */<br/>}</span></li><li>Define an emulation function named <tt>s10_fstat</tt>:<br/><span class="box code">/*<br/>&nbsp;* This emulation function is the initial handler for SYS_fstat syscalls.<br/>&nbsp;* Its sole purpose is to patch the sysent table when the process issues its<br/>&nbsp;* first SYS_fstat syscall. &nbsp;If the Solaris 10 fix represented by<br/>&nbsp;* S10_FEATURE_FSTAT_CHANGE is in the zone, then the sysent table will<br/>&nbsp;* be patched so that s10_emulate_fstat() will handle all future SYS_fstat<br/>&nbsp;* syscalls; otherwise, the sysent table will be patched so that it uses<br/>&nbsp;* s10_noemu_fstat() instead.<br/>&nbsp;*/<br/>static int<br/>s10_fstat(sysret_t *rv, int fd, struct stat *sb)<br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* SYS_fstat must be emulated if S10_FEATURE_FSTAT_CHANGE is present<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* in the zone.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (S10_FEATURE_IS_PRESENT(S10_FEATURE_FSTAT_CHANGE)) {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_sysent_table[SYS_fstat].st_callc =<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sysent_cb_t)s10_emulate_fstat;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (s10_emulate_fstat(rv, fd, sb));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s10_sysent_table[SYS_fstat].st_callc =<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sysent_cb_t)s10_noemu_fstat;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (s10_noemu_fstat(rv, fd, sb));<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</span></li><li>Modify <tt>SYS_fstat</tt>'s entry in <span class="wikiexternallink"><a href="http://src.opensolaris.org/source/search?q=&amp;defs=s10_sysent_table"><tt>s10_sysent_table</tt></a></span> so that <tt>s10_fstat()</tt> handles <tt>SYS_fstat</tt> syscalls:<br/><span class="box code">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMULATE(s10_fstat, 2 | RV_DEFAULT)</span></li></ol><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HWhatistheprocedureforbackportinganincompatiblechangetoaSolaris10updaterelease3F"><span>What is the procedure for backporting an incompatible change to a Solaris 10 update release?</span></h2><p>Please see the section entitled "<span class="wikilink"><a href="#HHowisversioninghandledfordifferentSolaris10updatesorpatchesrunninginthezonewhentheyneeddifferentemulation">How is versioning handled for different Solaris 10 updates or patches running in the zone when they need different emulation?</a></span>" for the full backporting and conditional emulation procedure.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowcanItestmyOpenSolarischangeswiththebrand3F"><span>How can I test my OpenSolaris changes with the brand?</span></h2><p>There are two ways to test your OpenSolaris fixes and projects with <em>solaris10</em>-branded zones:</p><h3 id="HRundo-it-yourself28DIY29tests"><span>Run do-it-yourself (DIY) tests</span></h3><p>The DIY test page at diy,ireland includes tests for zones under Category:Zones. &nbsp;When you run these tests you will automatically run tests for solaris10 branded zones.</p><h3 id="HManuallysetupazoneonatestsystemandtestyourchanges"><span>Manually set up a zone on a test system and test your changes</span></h3><p>Your system must have the <tt>SUNWs10brand</tt> package. &nbsp;You can install it on OpenSolaris via the <tt>pkg(5)</tt> command:</p><div class="box code"># pkg install SUNWs10brand</div><p>The <span class="wikiexternallink"><a href="http://pkg.opensolaris.org/dev">OpenSolaris.org development repository</a></span> publishes the <tt>SUNWs10brand</tt> package.</p><p>Use <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2240/zonecfg-1m">zonecfg(1M)</a></span> to configure a new <em>solaris10</em>-branded zone. Be sure to specify <tt>SUNWsolaris10</tt> when issuing the <tt>create</tt> subcommand. For example:</p><div class="box code"># zonecfg -z testzone<br/>testzone: No such zone configured<br/>Use 'create' to begin configuring a new zone.<br/>zonecfg:testzone&gt; create -t SUNWsolaris10</div><p>Each zone configuration must specify a <tt>zonepath</tt>: Every other property is optional. Note that the zone path of a <em>solaris10</em>-branded zone must reside on a ZFS filesystem. The following is an example of a minimal configuration for a <em>solaris10</em>-branded zone:</p><div class="box code"># zonecfg -z testzone<br/>testzone: No such zone configured<br/>Use 'create' to begin configuring a new zone.<br/>zonecfg:testzone&gt; create -t SUNWsolaris10<br/>zonecfg:testzone&gt; set zonepath=/export/zones/testzone<br/>zonecfg:testzone&gt; info<br/>zonename: testzone<br/>zonepath: /export/zones/testzone<br/>brand: solaris10<br/>autoboot: false<br/>bootargs: <br/>pool: <br/>limitpriv: <br/>scheduling-class: <br/>ip-type: shared<br/>hostid: <br/>zonecfg:testzone&gt; exit</div><p>Once you have configured a <em>solaris10</em>-branded zone, install it via <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2240/zoneadm-1m">zoneadm(1M)</a></span> using the <tt>install</tt> subcommand. You will have to use one of the <tt>-a</tt> or the <tt>-d</tt> options. <tt>-a &lt;archive-path&gt;</tt> specifies a <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5174/flash-archive-4"><tt>flash_archive(4)</tt></a></span>; a <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5165/cpio-1"><tt>cpio(1)</tt></a></span> archive, which can be compressed with either <tt>gzip(1)</tt> or <tt>bzip2(1)</tt>; a <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5165/pax-1"><tt>pax(1)</tt></a></span> "xustar" archive; or a level zero <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5166/ufsdump-1m"><tt>ufsdump(1M)</tt></a></span> of the installed Solaris 10 system (either a physical system or a native Solaris 10 zone) whose files will be installed into the new zone. <tt>-d &lt;s10-system-root-path&gt;</tt> specifies the full path of the root directory of an installed Solaris 10 system (again, either a physical system or a native Solaris 10 zone) whose files will be installed into the new zone. You must also specify either <tt>-p</tt> to preserve the virtualized system's configuration or <tt>-u</tt> to run <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5166/sys-unconfig-1m"><tt>sys-unconfig(1M)</tt></a></span> within the zone after it is installed. The following example installs the zone configured above from a flash archive of a physical Solaris 10 update 8 system and indicates that <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5166/sys-unconfig-1m"><tt>sys-unconfig(1M)</tt></a></span> should be run within the zone:</p><div class="box code"># zoneadm -z testzone install -a /net/kodiak.sfbay/gates/s10brand/public/images/s10u8b8ax.flar -u<br/>A ZFS file system has been created for this zone.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log File: /var/tmp/testzone.install_log.esaZ0g<br/>&nbsp;&nbsp;&nbsp;&nbsp;Installing: This may take several minutes...<br/>Postprocessing: This may take a while...<br/>&nbsp;&nbsp;&nbsp;Postprocess: Updating the image to run within a zone<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Result: Installation completed successfully.<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log File: /export/zones/testzone/root/var/log/testzone.install111754.log</div><p>The <tt>solaris10(5)</tt> man page contains more information about configuring and installing <em>solaris10</em>-branded zones.</p><p>A variety of pre-built Solaris 10u8 images are available within Sun for testing. They are located in <tt>/net/kodiak.sfbay/gates/s10brand/public/images</tt>.</p><p>Boot the zone via the <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2240/zoneadm-1m">zoneadm(1M)</a></span> <tt>boot</tt> subcommand:</p><div class="box code"># zoneadm -z testzone boot</div><p>Once the zone boots, you can log into the zone via the <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/819-2239/zlogin-1">zlogin(1)</a></span> command. If you specified <tt>-u</tt> when you installed the zone, then you should grab the zone's console and step through the <span class="wikiexternallink"><a href="http://docs.sun.com/app/docs/doc/816-5166/sys-unconfig-1m"><tt>sys-unconfig(1M)</tt></a></span> screens via <tt>zlogin -C</tt>. For example:</p><div class="box code"># zlogin -C testzone<br/>[Connected to zone 'testzone' console]<br/><br/>What type of terminal are you using?<br/>&nbsp;1) ANSI Standard CRT<br/>&nbsp;2) DEC VT52<br/>&nbsp;3) DEC VT100<br/>&nbsp;4) Heathkit 19<br/>&nbsp;5) Lear Siegler ADM31<br/>&nbsp;6) PC Console<br/>&nbsp;7) Sun Command Tool<br/>&nbsp;8) Sun Workstation<br/>&nbsp;9) Televideo 910<br/>&nbsp;10) Televideo 925<br/>&nbsp;11) Wyse Model 50<br/>&nbsp;12) X Terminal Emulator (xterms)<br/>&nbsp;13) CDE Terminal Emulator (dtterm)<br/>&nbsp;14) Other<br/>Type the number of your choice and press Return:</div><p>The zone's filesystem is accessible from the global zone via <tt>&lt;zonepath&gt;/root</tt>, where <tt>&lt;zonepath&gt;</tt> is the zone's path as specified in its configuration.</p><p>Once you boot a <em>solaris10</em>-branded zone, you can do two things: &nbsp;(Please note that these options are not mutually exclusive; in fact, doing both is highly recommended.)</p><h4 id="HManuallytestyourchanges"><span>Manually test your changes</span></h4><p>If your changes only affect a few binaries (e.g., your changes alter private interfaces between special libraries and the kernel), then it is usually sufficient to test the affected binaries in your zone. &nbsp;For example, if your changes alter a ZFS ioctl, then you can execute relevant ZFS commands in your zone in order to ensure that the ioctl functions properly. &nbsp;If your changes affect a syscall, then you can create and execute tests that invoke library functions that issue the syscall. &nbsp;If you are using <span class="wikilink"><a href="#HHowcanIsetupthebrandtouseanativecommand">native command replacement</a></span>, then you can log into your zone and test the functionality of the replacement binary's CLI and the functionality of commands that fork the binary if it is a command or test the functionality of commands that communicate with the replacement if it is a daemon. &nbsp;You should also consider running multithreaded tests that stress the interfaces affected by your changes if the interfaces are thread-safe in Solaris 10.</p><p>Remember, syscalls, ioctls, and other facets of the user-kernel interface as seen from within <em>solaris10</em>-branded zones must function as they do in Solaris 10. &nbsp;The same is true of commands and daemons within <em>solaris10</em>-branded zones.</p><h4 id="HRunalloftherelevantPITtestsorjusttheMSTCportion"><span>Run all of the relevant PIT tests or just the MSTC portion</span></h4><p>Consider running one or more PIT tests, such as MSTC, in your zone in addition to manually testing your changes if your changes are extensive or affect frequently-used syscalls or ioctls (e.g., <tt>SYS_lwp_create</tt> or a tty ioctl).</p><p>NOTE: The following procedure uses Sun-internal links to the test pages. Links to procedures for external testing will be provided soon.</p><p>Determine which PIT tests run within <em>solaris10</em>-branded zones. Many but not all of the existing test suites work in <em>solaris10</em>-branded zones. Any suite that runs in native Solaris 10 zones should run identically in <em>solaris10</em>-branded zones. You can do one of the following to determine whether a test will work:</p><ol><li>Go to the Solaris 10 PIT chessboard, which is accessible from the <span class="wikiexternallink"><a href="http://diablo.ireland">main PIT page</a></span>, and navigate to the "Virtualization/Zones/Native" icon. Clicking it should give you a list of tests that have been run inside of native Solaris 10 zones.</li><li>From the <span class="wikiexternallink"><a href="http://diablo.ireland">main PIT page</a></span>, select "Search PIT results database". Click on the "All Test Suites" pull-down menu, select the test suite that you want to run, and click "Go". You should get a list of all the test runs associated with the selected test suite. If you see any results associated with a native Solaris 10 zone, then the test can be run in <em>solaris10</em>-branded zones. Any host that ends in "-z*" (e.g., foo-z1) is a zone.</li></ol><p>Afterwards, run the test suite. All PIT test suites can be run via the STEP tool. <span class="wikiexternallink"><a href="http://step.ireland/cgi-bin/step-web/main.cgi?html_display=Intro_about.html">Click here for instructions on how to run STEP.</a></span> You should run STEP from the global zone. STEP will query you for the hostname of your test system, at which point you should enter the name of the <em>solaris10</em>-branded zone that you created for the test. Specify "zlogin_console" when STEP queries for the connection type.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p><h2 id="HHowcanItestmySolaris10changeswiththebrand3F"><span>How can I test my Solaris 10 changes with the brand?</span></h2><p>You will need to follow the procedures for <span class="wikilink"><a href="#HHowcanItestmyOpenSolarischangeswiththebrand">manually testing the zone</a></span>. However, you will not be able to use one of the pre-built Solaris 10u8 images. Instead, as part of your testing of the Solaris 10 change, you should create a flash archive of a physical system onto which you installed your change.</p><div class="box code"># flar create -n testflar /export/home/test.flar</div><p>Instead of <tt>test.flar</tt>, you can name the flar as you choose. &nbsp;If your physical Solaris 10 test system has a ZFS root, then you must create the flar with an explicit <tt>cpio</tt> or <tt>pax</tt> archive using the <tt>-L</tt> option:</p><div class="box code"># flar create -n testflar -L cpio /export/home/test.flar</div><p>You can now use this flar to install the zone and complete the testing. &nbsp;When installing the zone using your new flar, you must also use the <tt>-F</tt> option which<br/>bypasses the built-in version checking. &nbsp;This is needed because only Solaris 10u8 and later are supported and a BFU image does not look like a supported <br/>version of Solaris 10.</p><div class="box code"># zoneadm -z testzone install -a /home/foo/test.flar -F -u</div><p>If your code changes are simple, an alternative to creating your own flar is to use one of the pre-existing archives to install the zone and then<br/>replace the updated user-level binaries with the new binaries that you've built. &nbsp;If you use this technique, you must be sure that the base archive you're<br/>using is fully compatible with the changed files you're replacing.</p><p><span class="wikilink"><a href="#HTableofContents">Back to the Table of Contents</a></span></p>
</div>


    <div class="clearfloats"></div>
  </div>      <div id="xdocFooter">
  
                

       <div class="doc-tags" id="xdocTags">
        Tags:
        </div>
  
  <div id="xdocAuthors">
    <div class="xdocCreation">       Created by admin on 2009/10/26 12:11<br/>
          </div>
    <div class="xdocLastModification">       Last modified by flippedb on 2010/02/24 03:43
    </div>
  </div>
</div>
<div id="xwikidata" class="layoutsubsection">
        </div>  
    </div>      </div><div id="leftPanels" class="panels left">
                  <div class="panel expanded OSNav">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSNav');">Collectives</h1>
<div class="xwikipanelcontents">
<div id="xwikinavcontainer">
<span class="wikilink"><a href="/bin/view/Main/communities">Community Groups</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/projects">Projects</a></span><br/>
<span class="wikilink"><a href="/bin/view/Main/usergroups">User Groups</a></span>
</div><p/>
<script type="text/javascript">
document.observe('xwiki:dom:loaded', function() {
var obj = {div:'xwikinav',no:$count,height:250};
var acc = createAccordion(obj);
});
</script>
</div>
</div>
                        <div class="panel expanded OSDocs">
<h1 class="xwikipaneltitle" onclick="XWiki.togglePanelVisibility(this.parentNode, 'XWiki.XWikiGuest_Panels.OSDocs');">Community Group zones Pages</h1>
<div class="xwikipanelcontents">
<ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz">BrandZ</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_bugfixes">BrandZ Bugfixes</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_contribute">Contribute Code to BrandZ</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_design_doc">BrandZ Design Doc</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_downloads">BrandZ Downloads</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_install">BrandZ Installation</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_on_dev">BrandZ Impact on ON Development</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_project_list">BrandZ Project List</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/brandz_scla_faq">BrandZ/SCLA FAQ</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/linux_applications">Linux Applications</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/faq">Zones and Containers FAQ</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/flar_zones">Flash Archives & Zones</a></span></li>
</ul></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/files">Files</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/roadmap">Zones Roadmap</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/s10brand_dev_guide">Solaris10&#45;Branded Zone Developer Guide</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/zones_design_docs">Zones Project Documents</a></span><ul class="star">
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/rm_enhancements">Enhanced Resource Management Project</a></span></li>
<li><span class="wikilink"><a href="/bin/view/Community+Group+zones/zoss">zones on shared storage proposal</a></span></li>
</ul></li>
</ul>
                              </div>
</div>
      </div>

  </div>
<div class="clearfloats"></div>
  </div></div><div id="footerglobal" class="layoutsection">
<div class="minwidth"></div>
<hr/>
        <div id="xwikiplatformversion">XWiki Enterprise 2.7.1.34853 - <a onclick="openURL('http://enterprise.xwiki.org/xwiki/bin/view/Main/Documentation', '_blank'); return false;" href="http://www.xwiki.org/xwiki/bin/view/Main/Documentation">Documentation</a></div>
<br/>
  
      <div id="footer">
    <p>
                <a href="https://markebrooks.github.io/bin/view/Main/tou/">Terms of Use</a>
                |
                <a href="http://www.oracle.com/html/privacy.html">Privacy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/trademark/">Trademarks</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/copyrights/">Copyright Policy</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site_guidelines/">Site Guidelines</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/site-map/">Site Map</a>
                |
                <a href="https://markebrooks.github.io/bin/view/Main/help/">Help</a>
                <br/>Your use of this web site or any of its content or software indicates your agreement to be bound by these Terms of Use.<br/>
                &copy; 2012, Oracle Corporation and/or its affiliates.<br/><img src="https://markebrooks.github.io:443/static/images/logo_oracle_footer.gif" alt="Oracle Logo"/>
            </p>
        </div>

  
</div>

</div></div></body>
</html>
